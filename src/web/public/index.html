<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0a">
    <title>EDGY ALPHA CONSOLE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDGY ALPHA CONSOLE - TRADING DESK INTERFACE
   Bloomberg/Palantir-inspired dark terminal aesthetic
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
    /* BACKGROUNDS */
    --bg-terminal:    #0a0a0a;
    --bg-panel:       #0d0d0d;
    --bg-elevated:    #111111;
    --bg-input:       #080808;

    /* BORDERS */
    --border-dim:     #1a1a1a;
    --border-mid:     #222222;
    --border-bright:  #2a2a2a;

    /* ACCENT COLORS */
    --green-profit:   #00ff88;
    --green-dim:      #00aa66;
    --green-dark:     #004422;
    --amber-watch:    #ffaa00;
    --amber-dim:      #996600;
    --red-risk:       #ff3344;
    --red-dim:        #aa2233;
    --cyan-info:      #00ccff;
    --cyan-dim:       #0088aa;

    /* TEXT */
    --text-primary:   #e0e0e0;
    --text-secondary: #888888;
    --text-muted:     #555555;
    --text-dim:       #333333;

    /* TYPOGRAPHY */
    --font-mono:      'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    --fs-xs:          9px;
    --fs-sm:          11px;
    --fs-md:          13px;
    --fs-lg:          18px;
    --fs-xl:          24px;
    --fs-xxl:         32px;

    /* SPACING */
    --sp-xs:          4px;
    --sp-sm:          8px;
    --sp-md:          16px;
    --sp-lg:          24px;
    --sp-xl:          32px;
}

/* BRIGHT MODE */
[data-theme="light"] {
    --bg-terminal:    #f5f5f5;
    --bg-panel:       #ffffff;
    --bg-elevated:    #fafafa;
    --bg-input:       #f0f0f0;

    --border-dim:     #e0e0e0;
    --border-mid:     #d0d0d0;
    --border-bright:  #c0c0c0;

    --green-profit:   #00aa44;
    --green-dim:      #008833;
    --green-dark:     #e8f5e9;
    --amber-watch:    #ff8800;
    --amber-dim:      #cc6600;
    --red-risk:       #dd2233;
    --red-dim:        #aa1122;
    --cyan-info:      #0088cc;
    --cyan-dim:       #006699;

    --text-primary:   #1a1a1a;
    --text-secondary: #555555;
    --text-muted:     #888888;
    --text-dim:       #aaaaaa;
}

.logout-btn:hover {
    border-color: var(--red-risk) !important;
    color: var(--red-risk) !important;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    height: 100%;
    overflow: hidden;
}

body {
    font-family: var(--font-mono);
    font-size: var(--fs-sm);
    background: var(--bg-terminal);
    color: var(--text-primary);
    line-height: 1.4;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT - THREE COLUMN TRADING DESK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.console-app {
    display: grid;
    grid-template-columns: 180px 1fr;
    grid-template-rows: 36px 1fr 28px;
    height: 100vh;
    gap: 1px;
    background: var(--border-dim);
}

/* Mit Drilldown-Panel (3 Spalten) */
.console-app.show-drilldown {
    grid-template-columns: 180px 1fr 320px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.header-bar {
    grid-column: 1 / -1;
    background: var(--bg-panel);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--sp-md);
    border-bottom: 1px solid var(--border-mid);
}

.header-brand {
    display: flex;
    align-items: center;
    gap: var(--sp-md);
}

.brand-logo {
    font-size: var(--fs-md);
    font-weight: 700;
    color: var(--green-profit);
    letter-spacing: 2px;
    text-shadow: 0 0 10px var(--green-dark);
}

.brand-logo::before {
    content: 'â–Œ';
    margin-right: 4px;
    animation: cursor-blink 0.7s step-end infinite;
}

@keyframes cursor-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}

.header-status {
    display: flex;
    align-items: center;
    gap: var(--sp-lg);
}

.status-badge {
    display: flex;
    align-items: center;
    gap: var(--sp-xs);
    padding: 4px 10px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-mid);
    font-size: var(--fs-xs);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
}

.status-badge:hover {
    border-color: var(--green-dim);
    color: var(--green-profit);
}

.status-badge.mode-paper { border-color: var(--cyan-dim); color: var(--cyan-info); }
.status-badge.mode-shadow { border-color: var(--amber-dim); color: var(--amber-watch); }
.status-badge.mode-live {
    border-color: var(--green-dim);
    color: var(--green-profit);
    background: var(--green-dark);
}

.status-badge.killswitch-active {
    border-color: var(--red-dim);
    background: rgba(255,51,68,0.15);
    color: var(--red-risk);
    animation: killswitch-pulse 1s infinite;
}

@keyframes killswitch-pulse {
    0%, 100% { box-shadow: 0 0 5px transparent; }
    50% { box-shadow: 0 0 10px var(--red-dim); }
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green-profit);
    box-shadow: 0 0 6px var(--green-profit);
}

.status-dot.warning { background: var(--amber-watch); box-shadow: 0 0 6px var(--amber-watch); }
.status-dot.error { background: var(--red-risk); box-shadow: 0 0 6px var(--red-risk); }
.status-dot.offline { background: var(--text-muted); box-shadow: none; }

.header-metrics {
    display: flex;
    align-items: center;
    gap: var(--sp-lg);
    font-size: var(--fs-sm);
}

.metric {
    display: flex;
    align-items: center;
    gap: var(--sp-xs);
}

.metric-label {
    color: var(--text-muted);
    font-size: var(--fs-xs);
}

.metric-value {
    color: var(--text-primary);
    font-weight: 600;
}

.metric-value.positive { color: var(--green-profit); }
.metric-value.negative { color: var(--red-risk); }
.metric-value.warning { color: var(--amber-watch); }

.clock {
    font-size: var(--fs-sm);
    color: var(--text-secondary);
    font-variant-numeric: tabular-nums;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEFT SIDEBAR - NAVIGATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.sidebar-nav {
    background: var(--bg-panel);
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-dim);
    overflow-y: auto;
}

.nav-section {
    padding: var(--sp-sm) 0;
    border-bottom: 1px solid var(--border-dim);
}

.nav-section:last-child {
    border-bottom: none;
}

.nav-header {
    padding: var(--sp-xs) var(--sp-md);
    font-size: var(--fs-xs);
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: var(--sp-sm);
    padding: var(--sp-sm) var(--sp-md);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.1s;
    border-left: 2px solid transparent;
}

.nav-item:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
}

.nav-item.active {
    background: var(--bg-elevated);
    color: var(--green-profit);
    border-left-color: var(--green-profit);
}

.nav-item .nav-icon {
    width: 16px;
    text-align: center;
    font-size: var(--fs-sm);
}

.nav-item .nav-count {
    margin-left: auto;
    padding: 1px 6px;
    background: var(--bg-terminal);
    border-radius: 2px;
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

.nav-item.active .nav-count {
    background: var(--green-dark);
    color: var(--green-profit);
}

/* Pipeline Status */
.pipeline-status {
    padding: var(--sp-sm) var(--sp-md);
}

.pipeline-item {
    display: flex;
    align-items: center;
    gap: var(--sp-sm);
    padding: var(--sp-xs) 0;
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

.pipeline-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--green-profit);
}

.pipeline-dot.stale { background: var(--amber-watch); }
.pipeline-dot.error { background: var(--red-risk); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN VIEWPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.main-viewport {
    background: var(--bg-terminal);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Viewport Header */
.viewport-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--sp-sm) var(--sp-md);
    background: var(--bg-panel);
    border-bottom: 1px solid var(--border-dim);
}

.viewport-title {
    display: flex;
    align-items: center;
    gap: var(--sp-sm);
    font-size: var(--fs-sm);
    color: var(--text-primary);
    letter-spacing: 1px;
}

.viewport-title::before {
    content: '>';
    color: var(--green-dim);
}

.viewport-actions {
    display: flex;
    gap: var(--sp-sm);
}

/* Content Panels */
.viewport-content {
    flex: 1;
    overflow: hidden;
    display: none;
    flex-direction: column;
}

.viewport-content.active {
    display: flex;
}

/* Panel Styling */
.panel {
    background: var(--bg-panel);
    border: 1px solid var(--border-dim);
    margin: var(--sp-sm);
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--sp-sm) var(--sp-md);
    border-bottom: 1px solid var(--border-dim);
    font-size: var(--fs-xs);
    color: var(--text-secondary);
    letter-spacing: 1px;
}

.panel-header::before {
    content: 'â”€â”€â”€ ';
    color: var(--border-bright);
}

.panel-header::after {
    content: ' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
    color: var(--border-bright);
    flex: 1;
    overflow: hidden;
    margin-left: var(--sp-sm);
}

.panel-body {
    padding: var(--sp-md);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGNAL LIST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.signal-list {
    flex: 1;
    overflow-y: auto;
    padding: var(--sp-sm);
}

.signal-item {
    display: grid;
    grid-template-columns: 60px 1fr 80px 80px 60px;
    align-items: center;
    gap: var(--sp-md);
    padding: var(--sp-sm) var(--sp-md);
    background: var(--bg-panel);
    border: 1px solid var(--border-dim);
    margin-bottom: var(--sp-xs);
    cursor: pointer;
    transition: all 0.1s;
}

.signal-item:hover {
    border-color: var(--border-bright);
    background: var(--bg-elevated);
}

.signal-item.selected {
    border-color: var(--green-dim);
    border-left-width: 3px;
}

.signal-item.high-alpha {
    border-left: 3px solid var(--green-profit);
}

.signal-score {
    font-size: var(--fs-lg);
    font-weight: 700;
    color: var(--green-profit);
}

.signal-score.medium { color: var(--amber-watch); }
.signal-score.low { color: var(--text-muted); }

.signal-info {
    overflow: hidden;
}

.signal-question {
    font-size: var(--fs-sm);
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.signal-meta {
    display: flex;
    gap: var(--sp-sm);
    margin-top: 2px;
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

.signal-tag {
    padding: 1px 4px;
    background: var(--bg-terminal);
    color: var(--text-secondary);
}

.signal-tag.german { color: var(--amber-watch); }
.signal-tag.politics { color: var(--cyan-info); }

.signal-direction {
    font-size: var(--fs-md);
    font-weight: 600;
}

.signal-direction.yes { color: var(--green-profit); }
.signal-direction.no { color: var(--red-risk); }

.signal-edge {
    font-size: var(--fs-sm);
    font-weight: 500;
    color: var(--green-profit);
}

.signal-size {
    font-size: var(--fs-sm);
    color: var(--text-secondary);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSOLE LOG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.console-log {
    flex: 1;
    overflow-y: auto;
    padding: var(--sp-sm);
    background: var(--bg-terminal);
    font-size: var(--fs-xs);
}

.console-log::-webkit-scrollbar {
    width: 6px;
}

.console-log::-webkit-scrollbar-track {
    background: var(--bg-terminal);
}

.console-log::-webkit-scrollbar-thumb {
    background: var(--border-mid);
}

.log-entry {
    display: flex;
    gap: var(--sp-sm);
    padding: 2px 0;
    border-bottom: 1px solid var(--border-dim);
}

.log-time {
    color: var(--text-muted);
    flex-shrink: 0;
    width: 70px;
}

.log-level {
    width: 50px;
    flex-shrink: 0;
    font-weight: 500;
}

.log-level.info { color: var(--cyan-info); }
.log-level.success { color: var(--green-profit); }
.log-level.warn { color: var(--amber-watch); }
.log-level.error { color: var(--red-risk); }
.log-level.system { color: var(--text-muted); }

.log-message {
    color: var(--text-secondary);
    word-break: break-word;
}

.console-input {
    display: flex;
    align-items: center;
    padding: var(--sp-sm) var(--sp-md);
    background: var(--bg-panel);
    border-top: 1px solid var(--border-dim);
}

.console-prompt {
    color: var(--green-profit);
    margin-right: var(--sp-sm);
}

.console-cursor {
    display: inline-block;
    width: 8px;
    height: 14px;
    background: var(--green-profit);
    animation: cursor-blink 0.7s step-end infinite;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIGHT SIDEBAR - DRILLDOWN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.drilldown-panel {
    background: var(--bg-panel);
    display: none;
    flex-direction: column;
    border-left: 1px solid var(--border-dim);
    overflow-y: auto;
}

/* Drilldown nur auf Signals-Seite anzeigen */
.console-app.show-drilldown .drilldown-panel {
    display: flex;
}

/* Close Button fÃ¼r Drilldown */
.drilldown-close {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: var(--bg-terminal);
    border: 1px solid var(--border-mid);
    color: var(--text-muted);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.drilldown-close:hover {
    border-color: var(--red-dim);
    color: var(--red-risk);
}

.drilldown-header {
    padding: var(--sp-md);
    border-bottom: 1px solid var(--border-dim);
    position: relative;
}

.drilldown-title {
    font-size: var(--fs-sm);
    color: var(--green-profit);
    letter-spacing: 1px;
    margin-bottom: var(--sp-xs);
}

.drilldown-subtitle {
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

/* Chart Container */
.chart-container {
    height: 200px;
    padding: var(--sp-md);
    background: var(--bg-terminal);
    border-bottom: 1px solid var(--border-dim);
    position: relative;
}

.chart-placeholder {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: var(--fs-xs);
    border: 1px dashed var(--border-mid);
}

.chart-overlay {
    position: absolute;
    top: var(--sp-sm);
    right: var(--sp-sm);
    display: flex;
    gap: var(--sp-xs);
}

.chart-marker {
    padding: 2px 6px;
    font-size: var(--fs-xs);
    background: var(--bg-panel);
    border: 1px solid var(--border-mid);
}

.chart-marker.signal { border-color: var(--green-dim); color: var(--green-profit); }
.chart-marker.entry { border-color: var(--cyan-dim); color: var(--cyan-info); }

/* Drilldown Sections */
.drilldown-section {
    padding: var(--sp-md);
    border-bottom: 1px solid var(--border-dim);
}

.drilldown-section:last-child {
    border-bottom: none;
}

.section-label {
    font-size: var(--fs-xs);
    color: var(--text-muted);
    letter-spacing: 1px;
    margin-bottom: var(--sp-sm);
}

.section-label::before {
    content: 'â”€â”€ ';
    color: var(--border-bright);
}

/* Data Rows */
.data-row {
    display: flex;
    justify-content: space-between;
    padding: var(--sp-xs) 0;
    font-size: var(--fs-sm);
}

.data-label {
    color: var(--text-muted);
}

.data-value {
    color: var(--text-primary);
    font-weight: 500;
}

.data-value.positive { color: var(--green-profit); }
.data-value.negative { color: var(--red-risk); }
.data-value.warning { color: var(--amber-watch); }

/* Feature List */
.feature-list {
    font-size: var(--fs-xs);
}

.feature-item {
    display: flex;
    align-items: center;
    gap: var(--sp-sm);
    padding: var(--sp-xs) 0;
    color: var(--text-secondary);
}

.feature-bar {
    flex: 1;
    height: 4px;
    background: var(--bg-terminal);
    position: relative;
}

.feature-fill {
    height: 100%;
    background: var(--green-dim);
}

.feature-value {
    width: 40px;
    text-align: right;
    font-variant-numeric: tabular-nums;
}

/* Risk Gates */
.gate-list {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--sp-xs);
}

.gate-item {
    display: flex;
    align-items: center;
    gap: var(--sp-xs);
    padding: var(--sp-xs);
    background: var(--bg-terminal);
    font-size: var(--fs-xs);
}

.gate-icon {
    width: 14px;
    text-align: center;
}

.gate-icon.pass { color: var(--green-profit); }
.gate-icon.fail { color: var(--red-risk); }

/* Action Buttons */
.drilldown-actions {
    padding: var(--sp-md);
    display: flex;
    gap: var(--sp-sm);
    margin-top: auto;
}

.btn {
    flex: 1;
    padding: var(--sp-sm) var(--sp-md);
    border: 1px solid var(--border-mid);
    background: var(--bg-terminal);
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.15s;
}

.btn:hover {
    border-color: var(--green-dim);
    color: var(--green-profit);
}

.btn.primary {
    border-color: var(--green-dim);
    color: var(--green-profit);
}

.btn.primary:hover {
    background: var(--green-dark);
}

.btn.danger {
    border-color: var(--red-dim);
    color: var(--red-risk);
}

.btn.danger:hover {
    background: rgba(255,51,68,0.15);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.footer-bar {
    grid-column: 1 / -1;
    background: var(--bg-panel);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--sp-md);
    border-top: 1px solid var(--border-dim);
    font-size: var(--fs-xs);
}

.footer-left {
    color: var(--text-muted);
}

.footer-center {
    display: flex;
    align-items: center;
    gap: var(--sp-md);
}

.footer-right {
    display: flex;
    align-items: center;
    gap: var(--sp-md);
}

.scan-btn {
    padding: var(--sp-xs) var(--sp-md);
    background: var(--green-dim);
    border: none;
    color: var(--bg-terminal);
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    font-weight: 600;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.15s;
}

.scan-btn:hover {
    background: var(--green-profit);
    box-shadow: 0 0 10px var(--green-dark);
}

.scan-btn:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
}

.scan-btn.scanning {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RISK DASHBOARD VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.risk-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--sp-md);
    padding: var(--sp-md);
}

.risk-card {
    background: var(--bg-panel);
    border: 1px solid var(--border-dim);
    padding: var(--sp-md);
}

.risk-card-header {
    font-size: var(--fs-xs);
    color: var(--text-muted);
    letter-spacing: 1px;
    margin-bottom: var(--sp-md);
    padding-bottom: var(--sp-sm);
    border-bottom: 1px solid var(--border-dim);
}

.risk-big-number {
    font-size: var(--fs-xxl);
    font-weight: 700;
    line-height: 1;
}

.risk-big-number.positive { color: var(--green-profit); }
.risk-big-number.negative { color: var(--red-risk); }
.risk-big-number.neutral { color: var(--text-primary); }

.risk-progress {
    margin-top: var(--sp-md);
}

.risk-progress-bar {
    height: 8px;
    background: var(--bg-terminal);
    border: 1px solid var(--border-dim);
    overflow: hidden;
}

.risk-progress-fill {
    height: 100%;
    background: var(--green-dim);
    transition: width 0.3s;
}

.risk-progress-fill.warning { background: var(--amber-watch); }
.risk-progress-fill.danger { background: var(--red-risk); }

.risk-progress-labels {
    display: flex;
    justify-content: space-between;
    margin-top: var(--sp-xs);
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

/* Mode Selector */
.mode-selector {
    display: flex;
    gap: var(--sp-sm);
}

.mode-btn {
    flex: 1;
    padding: var(--sp-md);
    background: var(--bg-terminal);
    border: 1px solid var(--border-dim);
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: var(--fs-sm);
    cursor: pointer;
    transition: all 0.15s;
}

.mode-btn:hover {
    border-color: var(--border-bright);
}

.mode-btn.active {
    border-color: var(--green-dim);
    color: var(--green-profit);
    background: var(--green-dark);
}

.mode-btn.active.shadow {
    border-color: var(--amber-dim);
    color: var(--amber-watch);
    background: rgba(255,170,0,0.1);
}

.mode-btn.active.live {
    border-color: var(--green-profit);
    color: var(--bg-terminal);
    background: var(--green-profit);
}

/* Kill Switch */
.killswitch-big {
    padding: var(--sp-lg);
    background: var(--bg-terminal);
    border: 2px solid var(--green-dim);
    color: var(--green-profit);
    text-align: center;
    font-size: var(--fs-md);
    cursor: pointer;
    transition: all 0.15s;
}

.killswitch-big:hover {
    background: var(--green-dark);
}

.killswitch-big.active {
    border-color: var(--red-risk);
    background: rgba(255,51,68,0.2);
    color: var(--red-risk);
    animation: killswitch-pulse 1s infinite;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ASCII ELEMENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.ascii-divider {
    color: var(--border-bright);
    font-size: var(--fs-xs);
    padding: var(--sp-xs) 0;
    user-select: none;
}

.ascii-box {
    border: 1px solid var(--border-mid);
    padding: var(--sp-md);
    position: relative;
}

.ascii-box::before {
    content: 'â”Œ';
    position: absolute;
    top: -1px;
    left: -1px;
    color: var(--border-bright);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

@media (max-width: 1200px) {
    .console-app {
        grid-template-columns: 60px 1fr 280px;
    }

    .nav-item span:not(.nav-icon):not(.nav-count) {
        display: none;
    }

    .nav-header {
        display: none;
    }
}

@media (max-width: 900px) {
    .console-app,
    .console-app.show-drilldown {
        grid-template-columns: 1fr;
        grid-template-rows: 36px 1fr auto 28px;
    }

    .sidebar-nav {
        display: none;
    }

    .drilldown-panel,
    .console-app.show-drilldown .drilldown-panel {
        display: none;
    }
}
    </style>
</head>
<body>
    <div class="console-app">
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             HEADER BAR
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <header class="header-bar">
            <div class="header-brand">
                <span class="brand-logo">EDGY ALPHA</span>
            </div>

            <div class="header-status">
                <div class="status-badge mode-paper" id="mode-badge" onclick="showView('risk')">
                    <span>ğŸ“</span>
                    <span id="mode-text">PAPER</span>
                </div>

                <div class="status-badge" id="killswitch-badge" onclick="toggleKillSwitch()">
                    <span class="status-dot" id="killswitch-dot"></span>
                    <span id="killswitch-text">AKTIV</span>
                </div>

                <div class="metric">
                    <span class="metric-label">PnL</span>
                    <span class="metric-value positive" id="header-pnl">+$0.00</span>
                </div>

                <div class="metric">
                    <span class="metric-label">TRADES</span>
                    <span class="metric-value" id="header-trades">0</span>
                </div>
            </div>

            <div class="header-metrics">
                <div class="status-badge" onclick="toggleTheme()" title="Theme wechseln">
                    <span id="theme-icon">ğŸŒ™</span>
                </div>
                <a href="/docs.html" class="status-badge" style="text-decoration: none;">
                    <span>ğŸ“–</span>
                    <span>DOCS</span>
                </a>
                <div class="status-badge">
                    <span class="status-dot" id="ws-status"></span>
                    <span>WS</span>
                </div>
                <span class="clock" id="clock">--:--:--</span>
                <a href="/logout" class="status-badge logout-btn" style="text-decoration: none;" title="Logout">
                    <span>â»</span>
                </a>
            </div>
        </header>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             LEFT SIDEBAR - NAVIGATION
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-header">TRADING</div>
                <div class="nav-item active" data-view="signals" onclick="showView('signals')">
                    <span class="nav-icon">â—‰</span>
                    <span>SIGNALS</span>
                    <span class="nav-count" id="signal-count">0</span>
                </div>
                <div class="nav-item" data-view="markets" onclick="showView('markets')">
                    <span class="nav-icon">â—ˆ</span>
                    <span>PIPELINES</span>
                </div>
                <div class="nav-item" data-view="risk" onclick="showView('risk')">
                    <span class="nav-icon">â—†</span>
                    <span>RISK</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-header">ANALYSIS</div>
                <div class="nav-item" data-view="performance" onclick="showView('performance')">
                    <span class="nav-icon">ğŸ“ˆ</span>
                    <span>PERFORMANCE</span>
                </div>
                <div class="nav-item" data-view="backtest" onclick="showView('backtest')">
                    <span class="nav-icon">â–¤</span>
                    <span>BACKTEST</span>
                </div>
                <div class="nav-item" data-view="history" onclick="showView('history')">
                    <span class="nav-icon">â–¥</span>
                    <span>HISTORY</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-header">SOURCES</div>
                <div class="nav-item" data-view="almanien" onclick="showView('almanien')">
                    <span class="nav-icon">ğŸ‡©ğŸ‡ª</span>
                    <span>ALMANIEN</span>
                </div>
                <div class="nav-item" data-view="ticker" onclick="showView('ticker')">
                    <span class="nav-icon">â—</span>
                    <span>LIVE TICKER</span>
                </div>
            </div>

            <div class="nav-section" style="margin-top: auto;">
                <div class="nav-header">PIPELINES</div>
                <div class="pipeline-status">
                    <div class="pipeline-item">
                        <span class="pipeline-dot" id="pipe-poly"></span>
                        <span>Polymarket</span>
                    </div>
                    <div class="pipeline-item">
                        <span class="pipeline-dot" id="pipe-rss"></span>
                        <span>RSS Feeds</span>
                    </div>
                    <div class="pipeline-item">
                        <span class="pipeline-dot" id="pipe-dawum"></span>
                        <span>Dawum</span>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-item" data-view="console" onclick="showView('console')">
                    <span class="nav-icon">â–¸</span>
                    <span>CONSOLE</span>
                </div>
                <div class="nav-item" data-view="settings" onclick="showView('settings')">
                    <span class="nav-icon">âš™</span>
                    <span>SETTINGS</span>
                </div>
            </div>
        </nav>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             MAIN VIEWPORT
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <main class="main-viewport">
            <!-- SIGNALS VIEW -->
            <div class="viewport-content active" id="view-signals">
                <div class="viewport-header">
                    <div class="viewport-title">ACTIVE SIGNALS</div>
                    <div class="viewport-actions">
                        <button class="btn" onclick="refreshSignals()">REFRESH</button>
                    </div>
                </div>
                <div class="signal-list" id="signal-list">
                    <div class="log-entry" style="justify-content: center; padding: 40px; color: var(--text-muted);">
                        <span>> Keine aktiven Signale. Starte Scan...</span>
                        <span class="console-cursor"></span>
                    </div>
                </div>
            </div>

            <!-- CONSOLE VIEW -->
            <div class="viewport-content" id="view-console">
                <div class="viewport-header">
                    <div class="viewport-title">SYSTEM CONSOLE</div>
                </div>
                <div class="console-log" id="console-log"></div>
                <div class="console-input">
                    <span class="console-prompt">></span>
                    <span class="console-cursor"></span>
                </div>
            </div>

            <!-- RISK VIEW -->
            <div class="viewport-content" id="view-risk">
                <div class="viewport-header">
                    <div class="viewport-title">RISK DASHBOARD</div>
                </div>
                <div class="risk-grid">
                    <div class="risk-card">
                        <div class="risk-card-header">EXECUTION MODE</div>
                        <div class="mode-selector">
                            <button class="mode-btn active" id="btn-paper" onclick="setMode('paper')">ğŸ“ PAPER</button>
                            <button class="mode-btn" id="btn-shadow" onclick="setMode('shadow')">ğŸ‘» SHADOW</button>
                            <button class="mode-btn" id="btn-live" onclick="setMode('live')">ğŸš€ LIVE</button>
                        </div>
                    </div>

                    <div class="risk-card">
                        <div class="risk-card-header">KILL-SWITCH</div>
                        <div class="killswitch-big" id="killswitch-big" onclick="toggleKillSwitch()">
                            ğŸŸ¢ TRADING AKTIV<br>
                            <span style="font-size: 10px; color: var(--text-muted);">Klicken zum Stoppen</span>
                        </div>
                    </div>

                    <div class="risk-card">
                        <div class="risk-card-header">DAILY PnL</div>
                        <div class="risk-big-number positive" id="risk-pnl">+$0.00</div>
                        <div class="risk-progress">
                            <div class="risk-progress-bar">
                                <div class="risk-progress-fill" id="loss-limit-bar" style="width: 100%"></div>
                            </div>
                            <div class="risk-progress-labels">
                                <span>Loss Limit</span>
                                <span id="loss-limit-text">$100 remaining</span>
                            </div>
                        </div>
                    </div>

                    <div class="risk-card">
                        <div class="risk-card-header">POSITIONS</div>
                        <div class="risk-big-number neutral" id="risk-positions">0<span style="font-size: 16px; color: var(--text-muted);">/10</span></div>
                        <div class="data-row" style="margin-top: 16px;">
                            <span class="data-label">Total Exposure</span>
                            <span class="data-value" id="risk-exposure">$0.00</span>
                        </div>
                    </div>

                    <div class="risk-card" style="grid-column: 1 / -1;">
                        <div class="risk-card-header">DAILY STATS</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700;" id="stat-trades">0</div>
                                <div style="font-size: 10px; color: var(--text-muted);">TRADES</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--green-profit);" id="stat-wins">0</div>
                                <div style="font-size: 10px; color: var(--text-muted);">WINS</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--red-risk);" id="stat-losses">0</div>
                                <div style="font-size: 10px; color: var(--text-muted);">LOSSES</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700;" id="stat-winrate">--</div>
                                <div style="font-size: 10px; color: var(--text-muted);">WIN RATE</div>
                            </div>
                        </div>
                    </div>

                    <div class="risk-card" style="grid-column: 1 / -1;">
                        <div class="risk-card-header">EQUITY CURVE</div>
                        <div id="equity-chart-container" style="height: 150px; background: var(--bg-input); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: var(--text-muted); font-size: 11px;">Keine Trades - Chart erscheint nach erstem Trade</span>
                        </div>
                    </div>

                    <div class="risk-card" style="grid-column: 1 / -1;">
                        <div class="risk-card-header">AUDIT LOG (LETZTE AKTIONEN)</div>
                        <div id="audit-log-container" style="max-height: 150px; overflow-y: auto; font-size: 10px;">
                            <div style="color: var(--text-muted); padding: 8px;">Lade Audit-Log...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TICKER VIEW -->
            <div class="viewport-content" id="view-ticker">
                <div class="viewport-header">
                    <div class="viewport-title">LIVE NEWS TICKER</div>
                    <div class="viewport-actions">
                        <div class="metric">
                            <span class="metric-label">NEWS</span>
                            <span class="metric-value" id="ticker-news">0</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">MATCHES</span>
                            <span class="metric-value positive" id="ticker-matches">0</span>
                        </div>
                    </div>
                </div>
                <div class="console-log" id="ticker-log"></div>
            </div>

            <!-- ALMANIEN VIEW -->
            <div class="viewport-content" id="view-almanien">
                <div class="viewport-header">
                    <div class="viewport-title">ALMANIEN INTELLIGENCE</div>
                    <div class="viewport-actions">
                        <div class="metric">
                            <span class="metric-label">MATCHES</span>
                            <span class="metric-value positive" id="almanien-match-count">0</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">NEWS</span>
                            <span class="metric-value" id="almanien-news-count">0</span>
                        </div>
                        <button class="btn" onclick="loadAlmanienMatches()" style="font-size: 10px;">REFRESH</button>
                    </div>
                </div>
                <div style="padding: 16px; overflow-y: auto; height: calc(100% - 44px);">
                    <!-- Matches Panel (Hauptbereich) -->
                    <div class="panel" style="margin-bottom: 16px;">
                        <div class="panel-header">NEWS-MARKT MATCHES</div>
                        <div class="panel-body" id="almanien-matches" style="padding: 0;">
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 24px; margin-bottom: 12px;">Lade Matches...</div>
                                <div style="font-size: 10px;">Deutsche News werden mit Polymarket-Maerkten abgeglichen</div>
                            </div>
                        </div>
                    </div>

                    <!-- Umfragen Panel (klein) -->
                    <div class="panel">
                        <div class="panel-header">SONNTAGSFRAGE (DAWUM)</div>
                        <div class="panel-body" id="polls-data">
                            <span style="color: var(--text-muted);">Lade...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MARKETS VIEW -->
            <div class="viewport-content" id="view-markets">
                <div class="viewport-header">
                    <div class="viewport-title">PIPELINE HEALTH</div>
                    <div class="viewport-actions">
                        <div class="metric">
                            <span class="status-dot" id="pipeline-overall-status"></span>
                            <span class="metric-label" id="pipeline-overall-text">CHECKING</span>
                        </div>
                    </div>
                </div>
                <div style="padding: 16px; overflow-y: auto;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                        <!-- RSS Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-rss">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“¡ RSS FEEDS</span>
                                <span class="status-dot" id="pl-rss-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-rss-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Success</span><span class="data-value" id="pl-rss-last">--</span></div>
                                <div class="data-row"><span class="data-label">Error Count</span><span class="data-value" id="pl-rss-errors">--</span></div>
                            </div>
                        </div>

                        <!-- Dawum Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-dawum">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š DAWUM UMFRAGEN</span>
                                <span class="status-dot" id="pl-dawum-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-dawum-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Success</span><span class="data-value" id="pl-dawum-last">--</span></div>
                                <div class="data-row"><span class="data-label">Error Count</span><span class="data-value" id="pl-dawum-errors">--</span></div>
                            </div>
                        </div>

                        <!-- Polymarket Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-polymarket">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“ˆ POLYMARKET API</span>
                                <span class="status-dot" id="pl-polymarket-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-polymarket-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Success</span><span class="data-value" id="pl-polymarket-last">--</span></div>
                                <div class="data-row"><span class="data-label">Error Count</span><span class="data-value" id="pl-polymarket-errors">--</span></div>
                            </div>
                        </div>

                        <!-- Scanner Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-scanner">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ” SCANNER ENGINE</span>
                                <span class="status-dot" id="pl-scanner-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-scanner-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Scan</span><span class="data-value" id="pl-scanner-last">--</span></div>
                                <div class="data-row"><span class="data-label">Last Signal</span><span class="data-value" id="pl-scanner-signal">--</span></div>
                            </div>
                        </div>

                        <!-- Ticker Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-ticker">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“° NEWS TICKER</span>
                                <span class="status-dot" id="pl-ticker-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-ticker-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Success</span><span class="data-value" id="pl-ticker-last">--</span></div>
                                <div class="data-row"><span class="data-label">Error Count</span><span class="data-value" id="pl-ticker-errors">--</span></div>
                            </div>
                        </div>

                        <!-- WebSocket Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-websocket">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ”Œ WEBSOCKET</span>
                                <span class="status-dot" id="pl-ws-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-ws-status">--</span></div>
                                <div class="data-row"><span class="data-label">Connected</span><span class="data-value" id="pl-ws-connected">--</span></div>
                                <div class="data-row"><span class="data-label">Reconnects</span><span class="data-value" id="pl-ws-reconnects">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Logs -->
                    <div class="panel" style="margin-top: 16px;">
                        <div class="panel-header">PIPELINE EVENTS</div>
                        <div class="panel-body console-log" id="pipeline-log" style="height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- BACKTEST VIEW -->
            <div class="viewport-content" id="view-backtest">
                <div class="viewport-header">
                    <div class="viewport-title">BACKTEST RUNNER</div>
                    <div class="viewport-actions">
                        <div class="metric" id="bt-data-status">
                            <span class="metric-label">DATA</span>
                            <span class="metric-value" id="bt-trade-count">--</span>
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 1px; background: var(--border-dim); height: calc(100% - 44px);">
                    <!-- Backtest Config Panel -->
                    <div style="background: var(--bg-panel); padding: 16px; overflow-y: auto;">
                        <div class="panel" style="margin-bottom: 16px;">
                            <div class="panel-header">KONFIGURATION</div>
                            <div class="panel-body">
                                <div style="margin-bottom: 12px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">ENGINE</label>
                                    <select id="bt-engine" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 11px;">
                                        <option value="meta">META (Combined)</option>
                                        <option value="timeDelay">TIME_DELAY (News)</option>
                                        <option value="mispricing">MISPRICING (Value)</option>
                                    </select>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">VON</label>
                                        <input type="date" id="bt-from" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 10px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">BIS</label>
                                        <input type="date" id="bt-to" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 10px;">
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">BANKROLL ($)</label>
                                    <input type="number" id="bt-bankroll" value="1000" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 11px;">
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="bt-slippage" checked style="accent-color: var(--green-profit);">
                                        Slippage-Modell aktivieren
                                    </label>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="bt-walkforward" checked style="accent-color: var(--cyan-info);">
                                        Walk-Forward (Out-of-Sample)
                                    </label>
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px; margin-left: 24px;">
                                        Meta-Combiner lernt wÃ¤hrend des Tests
                                    </div>
                                </div>
                                <button class="btn primary" style="width: 100%;" id="bt-run-btn" onclick="runBacktest()">
                                    â–¶ BACKTEST STARTEN
                                </button>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="panel" id="bt-progress-panel" style="display: none;">
                            <div class="panel-header">FORTSCHRITT</div>
                            <div class="panel-body">
                                <div style="margin-bottom: 8px;">
                                    <div style="height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden;">
                                        <div id="bt-progress-bar" style="height: 100%; background: var(--green-profit); width: 0%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                <div style="font-size: 10px; color: var(--text-secondary);" id="bt-progress-text">Initialisiere...</div>
                            </div>
                        </div>

                        <!-- Data Info -->
                        <div class="panel">
                            <div class="panel-header">HISTORISCHE DATEN</div>
                            <div class="panel-body" id="bt-data-info">
                                <span style="color: var(--text-muted);">Lade...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Backtest Results -->
                    <div style="background: var(--bg-panel); overflow-y: auto;">
                        <div id="bt-results" style="padding: 16px;">
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <div style="font-size: 32px; margin-bottom: 16px;">ğŸ“Š</div>
                                <div>Konfiguriere und starte einen Backtest</div>
                                <div style="font-size: 10px; margin-top: 8px;">Ergebnisse werden hier angezeigt</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PERFORMANCE DASHBOARD VIEW -->
            <div class="viewport-content" id="view-performance">
                <div class="viewport-header">
                    <div class="viewport-title">ROLLING PERFORMANCE DASHBOARD</div>
                    <div class="viewport-actions">
                        <select id="perf-window" onchange="loadPerformanceData()" style="background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 4px 8px; font-family: var(--font-mono); font-size: 10px;">
                            <option value="7">7 TAGE</option>
                            <option value="30" selected>30 TAGE</option>
                            <option value="90">90 TAGE</option>
                            <option value="all">ALL TIME</option>
                        </select>
                        <button class="btn" onclick="loadPerformanceData()" style="font-size: 10px;">â†» REFRESH</button>
                    </div>
                </div>
                <div style="padding: 16px; overflow-y: auto; height: calc(100% - 44px);">
                    <!-- KPI Cards -->
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-pnl" style="font-size: 24px; font-weight: 700;" class="positive">$0.00</div>
                            <div style="font-size: 10px; color: var(--text-muted);">TOTAL PnL</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-winrate" style="font-size: 24px; font-weight: 700;">0%</div>
                            <div style="font-size: 10px; color: var(--text-muted);">WIN RATE</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-trades" style="font-size: 24px; font-weight: 700;">0</div>
                            <div style="font-size: 10px; color: var(--text-muted);">TRADES</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-sharpe" style="font-size: 24px; font-weight: 700;">0.00</div>
                            <div style="font-size: 10px; color: var(--text-muted);">SHARPE</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-drawdown" style="font-size: 24px; font-weight: 700;" class="negative">0%</div>
                            <div style="font-size: 10px; color: var(--text-muted);">MAX DD</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-quality" style="font-size: 24px; font-weight: 700;">--</div>
                            <div style="font-size: 10px; color: var(--text-muted);">EXEC QUALITY</div>
                        </div>
                    </div>

                    <!-- Equity Curve -->
                    <div class="panel" style="margin-bottom: 16px;">
                        <div class="panel-header">EQUITY CURVE (ROLLING)</div>
                        <div class="panel-body" style="padding: 0;">
                            <div id="perf-equity-chart" style="height: 200px; width: 100%;"></div>
                        </div>
                    </div>

                    <!-- Zwei-Spalten Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <!-- Engine Performance -->
                        <div class="panel">
                            <div class="panel-header">ENGINE PERFORMANCE</div>
                            <div class="panel-body" id="perf-engines">
                                <div class="data-row">
                                    <span class="data-label">TIME_DELAY</span>
                                    <span class="data-value" id="perf-timedelay">-- trades, $--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">MISPRICING</span>
                                    <span class="data-value" id="perf-mispricing">-- trades, $--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">META</span>
                                    <span class="data-value" id="perf-meta">-- trades, $--</span>
                                </div>
                            </div>
                        </div>

                        <!-- Streaks -->
                        <div class="panel">
                            <div class="panel-header">STREAKS & STATS</div>
                            <div class="panel-body">
                                <div class="data-row">
                                    <span class="data-label">Current Streak</span>
                                    <span class="data-value" id="perf-streak">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Best Win Streak</span>
                                    <span class="data-value positive" id="perf-best-streak">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Worst Loss Streak</span>
                                    <span class="data-value negative" id="perf-worst-streak">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Avg Win</span>
                                    <span class="data-value positive" id="perf-avg-win">$--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Avg Loss</span>
                                    <span class="data-value negative" id="perf-avg-loss">$--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Profit Factor</span>
                                    <span class="data-value" id="perf-profit-factor">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Execution Quality -->
                    <div class="panel" style="margin-bottom: 16px;">
                        <div class="panel-header">EXECUTION QUALITY ANALYSIS</div>
                        <div class="panel-body">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                <div>
                                    <div class="data-row"><span class="data-label">Fill Rate</span><span class="data-value" id="perf-fill-rate">--%</span></div>
                                    <div class="data-row"><span class="data-label">Avg Slippage</span><span class="data-value" id="perf-avg-slippage">--%</span></div>
                                </div>
                                <div>
                                    <div class="data-row"><span class="data-label">Expected Slip</span><span class="data-value" id="perf-exp-slippage">--%</span></div>
                                    <div class="data-row"><span class="data-label">Slippage Cost</span><span class="data-value negative" id="perf-slip-cost">$--</span></div>
                                </div>
                                <div>
                                    <div class="data-row"><span class="data-label">Avg Latency</span><span class="data-value" id="perf-latency">--ms</span></div>
                                    <div class="data-row"><span class="data-label">P95 Latency</span><span class="data-value" id="perf-p95-latency">--ms</span></div>
                                </div>
                                <div>
                                    <div class="data-row"><span class="data-label">Price Improve</span><span class="data-value" id="perf-price-improve">--%</span></div>
                                    <div class="data-row"><span class="data-label">Model Accuracy</span><span class="data-value" id="perf-model-acc">--%</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="panel">
                        <div class="panel-header">SYSTEM RECOMMENDATIONS</div>
                        <div class="panel-body" id="perf-recommendations" style="font-size: 11px;">
                            <div style="color: var(--text-muted);">Lade Empfehlungen...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORY VIEW -->
            <div class="viewport-content" id="view-history">
                <div class="viewport-header">
                    <div class="viewport-title">TRADE HISTORY</div>
                </div>
                <div class="console-log" style="padding: 40px; text-align: center;">
                    <span style="color: var(--text-muted);">> History view coming soon...</span>
                    <span class="console-cursor"></span>
                </div>
            </div>
        </main>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             RIGHT SIDEBAR - DRILLDOWN
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <aside class="drilldown-panel" id="drilldown-panel">
            <div class="drilldown-header">
                <button class="drilldown-close" onclick="closeDrilldown()" title="Schliessen">Ã—</button>
                <div class="drilldown-title" id="drilldown-title">SELECT SIGNAL</div>
                <div class="drilldown-subtitle" id="drilldown-subtitle">Waehle ein Signal fuer Details</div>
            </div>

            <div class="chart-container" id="chart-container">
                <div class="chart-placeholder">
                    <span>ğŸ“ˆ Chart loads when signal selected</span>
                </div>
            </div>

            <div class="drilldown-section">
                <div class="section-label">SIGNAL DATA</div>
                <div class="data-row">
                    <span class="data-label">Direction</span>
                    <span class="data-value" id="dd-direction">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Edge</span>
                    <span class="data-value positive" id="dd-edge">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Confidence</span>
                    <span class="data-value" id="dd-confidence">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Size (Kelly)</span>
                    <span class="data-value" id="dd-size">--</span>
                </div>
            </div>

            <div class="drilldown-section">
                <div class="section-label">TOP FEATURES</div>
                <div class="feature-list" id="dd-features">
                    <div class="feature-item">
                        <span style="width: 80px;">--</span>
                        <div class="feature-bar"><div class="feature-fill" style="width: 0%"></div></div>
                        <span class="feature-value">--</span>
                    </div>
                </div>
            </div>

            <div class="drilldown-section">
                <div class="section-label">RISK GATES</div>
                <div class="gate-list" id="dd-gates">
                    <div class="gate-item">
                        <span class="gate-icon">--</span>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>

            <div class="drilldown-actions">
                <button class="btn primary" id="btn-trade-yes" onclick="executeTrade('YES')" disabled>BUY YES</button>
                <button class="btn danger" id="btn-trade-no" onclick="executeTrade('NO')" disabled>BUY NO</button>
            </div>
        </aside>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             FOOTER BAR
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <footer class="footer-bar">
            <div class="footer-left">
                <span id="scan-status">BEREIT</span>
            </div>
            <div class="footer-center">
                <span style="color: var(--text-muted);">v2.1.0 | MIT ALMANIEN-VORSPRUNG</span>
            </div>
            <div class="footer-right">
                <button class="scan-btn" id="scan-btn" onclick="startScan()">â–¶ SCAN STARTEN</button>
            </div>
        </footer>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        EDGY ALPHA CONSOLE - CLIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let socket = null;
let signals = [];
let selectedSignal = null;
let riskDashboard = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        THEME TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    const icon = document.getElementById('theme-icon');
    if (icon) {
        icon.textContent = theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';
    }
}

function initTheme() {
    const saved = localStorage.getItem('theme') || 'dark';
    if (saved === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
    }
    updateThemeIcon(saved);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    initSocket();
    initClock();
    loadInitialData();
    bootSequence();
    // Initial Drilldown-Panel fuer Signals-Seite aktivieren
    document.querySelector('.console-app').classList.add('show-drilldown');
});

function bootSequence() {
    const msgs = [
        ['system', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
        ['system', '  EDGY ALPHA CONSOLE v2.1.0'],
        ['system', '  Trading Desk Interface | MIT ALMANIEN-VORSPRUNG'],
        ['system', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
        ['info', 'Initialisiere Systeme...'],
        ['success', 'WebSocket verbunden'],
        ['info', 'Lade Pipeline-Status...'],
        ['success', 'Polymarket API online'],
        ['success', 'RSS Feeds aktiv (40 Quellen)'],
        ['success', 'Dawum Umfragen geladen'],
        ['info', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'],
        ['info', 'System bereit. Warte auf Befehle...'],
    ];

    let i = 0;
    const interval = setInterval(() => {
        if (i < msgs.length) {
            addLog(msgs[i][0], msgs[i][1]);
            i++;
        } else {
            clearInterval(interval);
        }
    }, 200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initSocket() {
    socket = io();

    socket.on('connect', () => {
        document.getElementById('ws-status').classList.remove('offline', 'error');
        addLog('success', 'WebSocket verbunden');
    });

    socket.on('disconnect', () => {
        document.getElementById('ws-status').classList.add('error');
        addLog('error', 'WebSocket getrennt');
    });

    socket.on('scan_started', () => {
        document.getElementById('scan-btn').disabled = true;
        document.getElementById('scan-btn').classList.add('scanning');
        document.getElementById('scan-btn').textContent = 'â—Œ SCANNT...';
        document.getElementById('scan-status').textContent = 'SCANNING';
        addLog('info', 'Scan gestartet...');
    });

    socket.on('scan_completed', (result) => {
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('scan-btn').classList.remove('scanning');
        document.getElementById('scan-btn').textContent = 'â–¶ SCAN STARTEN';
        document.getElementById('scan-status').textContent = 'BEREIT';
        handleScanResult(result);
    });

    socket.on('signal_found', (signal) => {
        addLog('success', `SIGNAL: ${signal.market?.question?.substring(0, 50)}...`);
    });

    socket.on('ticker', (event) => {
        handleTickerEvent(event);
    });

    socket.on('runtime_state_change', (event) => {
        addLog('info', `State: ${event.field} â†’ ${JSON.stringify(event.newValue)}`);
        loadRiskDashboard();
    });

    socket.on('kill_switch', (data) => {
        updateKillSwitchUI(data.active);
        addLog(data.active ? 'warn' : 'success',
            data.active ? 'KILL-SWITCH AKTIVIERT' : 'Kill-Switch deaktiviert');
    });

    socket.on('risk_update', (data) => {
        riskDashboard = data;
        updateRiskUI();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadInitialData() {
    const opts = { credentials: 'include' };

    try {
        const [signalsData, riskData, polls, news] = await Promise.all([
            fetch('/api/signals', opts).then(r => r.ok ? r.json() : []).catch(() => []),
            fetch('/api/risk/dashboard', opts).then(r => r.ok ? r.json() : null).catch(() => null),
            fetch('/api/germany/polls', opts).then(r => r.ok ? r.json() : []).catch(() => []),
            fetch('/api/germany/news', opts).then(r => r.ok ? r.json() : []).catch(() => []),
        ]);

        if (signalsData.length) {
            signals = signalsData;
            renderSignals();
        }

        if (riskData) {
            riskDashboard = riskData;
            updateRiskUI();
            updateModeUI(riskData.mode);
            updateKillSwitchUI(riskData.killSwitch.active);
        }

        renderPolls(polls);
        renderNews(news);
    } catch (err) {
        addLog('error', 'Fehler beim Laden: ' + err.message);
    }
}

async function loadRiskDashboard() {
    try {
        const data = await fetch('/api/risk/dashboard', { credentials: 'include' }).then(r => r.json());
        riskDashboard = data;
        updateRiskUI();
        updateModeUI(data.mode);
        updateKillSwitchUI(data.killSwitch.active);
    } catch (err) {
        addLog('error', 'Risk Dashboard Fehler');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        UI UPDATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateRiskUI() {
    if (!riskDashboard) return;

    const d = riskDashboard;

    // Header
    const pnlEl = document.getElementById('header-pnl');
    pnlEl.textContent = (d.daily.pnl >= 0 ? '+' : '') + '$' + d.daily.pnl.toFixed(2);
    pnlEl.className = 'metric-value ' + (d.daily.pnl >= 0 ? 'positive' : 'negative');
    document.getElementById('header-trades').textContent = d.daily.trades;

    // Risk View
    const riskPnl = document.getElementById('risk-pnl');
    if (riskPnl) {
        riskPnl.textContent = (d.daily.pnl >= 0 ? '+' : '') + '$' + d.daily.pnl.toFixed(2);
        riskPnl.className = 'risk-big-number ' + (d.daily.pnl >= 0 ? 'positive' : 'negative');
    }

    const lossBar = document.getElementById('loss-limit-bar');
    const lossText = document.getElementById('loss-limit-text');
    if (lossBar && lossText) {
        const pct = Math.max(0, (d.limits.dailyLossRemaining / d.limits.dailyLossLimit) * 100);
        lossBar.style.width = pct + '%';
        lossBar.className = 'risk-progress-fill' + (pct < 30 ? ' danger' : pct < 60 ? ' warning' : '');
        lossText.textContent = '$' + d.limits.dailyLossRemaining.toFixed(0) + ' remaining';
    }

    const posEl = document.getElementById('risk-positions');
    if (posEl) posEl.innerHTML = d.positions.open + '<span style="font-size: 16px; color: var(--text-muted);">/' + d.positions.max + '</span>';

    const expEl = document.getElementById('risk-exposure');
    if (expEl) expEl.textContent = '$' + d.positions.totalExposure.toFixed(2);

    // Stats
    const statEls = {
        'stat-trades': d.daily.trades,
        'stat-wins': d.daily.wins,
        'stat-losses': d.daily.losses,
        'stat-winrate': d.daily.trades > 0 ? d.daily.winRate.toFixed(0) + '%' : '--',
    };
    for (const [id, val] of Object.entries(statEls)) {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    }
}

function updateModeUI(mode) {
    // Header badge
    const badge = document.getElementById('mode-badge');
    badge.className = 'status-badge mode-' + mode;
    document.getElementById('mode-text').textContent = mode.toUpperCase();

    // Mode buttons
    ['paper', 'shadow', 'live'].forEach(m => {
        const btn = document.getElementById('btn-' + m);
        if (btn) {
            btn.classList.toggle('active', m === mode);
            if (m === mode) btn.classList.add(m);
        }
    });
}

function updateKillSwitchUI(active) {
    const badge = document.getElementById('killswitch-badge');
    const dot = document.getElementById('killswitch-dot');
    const text = document.getElementById('killswitch-text');
    const big = document.getElementById('killswitch-big');

    badge.classList.toggle('killswitch-active', active);
    dot.classList.toggle('error', active);
    text.textContent = active ? 'STOP' : 'AKTIV';

    if (big) {
        big.classList.toggle('active', active);
        big.innerHTML = active
            ? 'ğŸ”´ TRADING GESTOPPT<br><span style="font-size: 10px; color: var(--text-muted);">Klicken zum Aktivieren</span>'
            : 'ğŸŸ¢ TRADING AKTIV<br><span style="font-size: 10px; color: var(--text-muted);">Klicken zum Stoppen</span>';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showView(viewId) {
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewId);
    });

    // Update content
    document.querySelectorAll('.viewport-content').forEach(content => {
        content.classList.toggle('active', content.id === 'view-' + viewId);
    });

    // Drilldown-Panel nur auf der Signals-Seite anzeigen
    const consoleApp = document.querySelector('.console-app');
    if (viewId === 'signals') {
        consoleApp.classList.add('show-drilldown');
    } else {
        consoleApp.classList.remove('show-drilldown');
        // Reset Drilldown-Zustand beim Verlassen
        resetDrilldown();
    }
}

// Drilldown schliessen und zuruecksetzen
function closeDrilldown() {
    const consoleApp = document.querySelector('.console-app');
    consoleApp.classList.remove('show-drilldown');
    resetDrilldown();
}

// Drilldown-Panel zuruecksetzen
function resetDrilldown() {
    selectedSignal = null;

    // Chart entfernen falls vorhanden
    if (typeof priceChart !== 'undefined' && priceChart) {
        try {
            priceChart.remove();
        } catch (e) {}
        priceChart = null;
    }

    // Chart-Container zuruecksetzen
    const chartContainer = document.getElementById('chart-container');
    if (chartContainer) {
        chartContainer.innerHTML = '<div class="chart-placeholder"><span>Waehle ein Signal fuer Chart</span></div>';
    }

    // Drilldown-Felder zuruecksetzen
    document.getElementById('drilldown-title').textContent = 'SELECT SIGNAL';
    document.getElementById('drilldown-subtitle').textContent = 'Waehle ein Signal fuer Details';
    document.getElementById('dd-direction').textContent = '--';
    document.getElementById('dd-direction').className = 'data-value';
    document.getElementById('dd-edge').textContent = '--';
    document.getElementById('dd-confidence').textContent = '--';
    document.getElementById('dd-size').textContent = '--';

    // Trade-Buttons deaktivieren
    document.getElementById('btn-trade-yes').disabled = true;
    document.getElementById('btn-trade-no').disabled = true;

    // Signal-Selektion aufheben
    document.querySelectorAll('.signal-item').forEach(el => {
        el.classList.remove('selected');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        SIGNALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderSignals() {
    const container = document.getElementById('signal-list');
    document.getElementById('signal-count').textContent = signals.length;

    if (!signals.length) {
        container.innerHTML = `
            <div class="log-entry" style="justify-content: center; padding: 40px; color: var(--text-muted);">
                <span>> Keine aktiven Signale. Starte Scan...</span>
                <span class="console-cursor"></span>
            </div>
        `;
        return;
    }

    container.innerHTML = signals.map((s, i) => {
        const scoreClass = s.score > 0.7 ? '' : s.score > 0.5 ? 'medium' : 'low';
        const isGerman = s.germanSource !== undefined;

        return `
            <div class="signal-item ${s.score > 0.7 ? 'high-alpha' : ''}" onclick="selectSignal(${i})">
                <div class="signal-score ${scoreClass}">${(s.score * 100).toFixed(0)}%</div>
                <div class="signal-info">
                    <div class="signal-question">${s.market?.question || 'Unknown'}</div>
                    <div class="signal-meta">
                        ${isGerman ? '<span class="signal-tag german">DE</span>' : ''}
                        <span class="signal-tag">${s.market?.category || 'MARKET'}</span>
                    </div>
                </div>
                <div class="signal-direction ${s.direction?.toLowerCase()}">${s.direction}</div>
                <div class="signal-edge">+${(s.edge * 100).toFixed(1)}%</div>
                <div class="signal-size">$${s.kellyBet?.toFixed(0) || '--'}</div>
            </div>
        `;
    }).join('');
}

function selectSignal(index) {
    selectedSignal = signals[index];

    // Update selection UI
    document.querySelectorAll('.signal-item').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });

    // Update drilldown
    const s = selectedSignal;
    document.getElementById('drilldown-title').textContent = 'SIGNAL #' + s.id?.substring(0, 8);
    document.getElementById('drilldown-subtitle').textContent = s.market?.question?.substring(0, 50) + '...';

    document.getElementById('dd-direction').textContent = s.direction;
    document.getElementById('dd-direction').className = 'data-value ' + (s.direction === 'YES' ? 'positive' : 'negative');
    document.getElementById('dd-edge').textContent = '+' + (s.edge * 100).toFixed(1) + '%';
    document.getElementById('dd-confidence').textContent = (s.confidence * 100).toFixed(0) + '%';
    document.getElementById('dd-size').textContent = '$' + (s.kellyBet?.toFixed(2) || '--');

    // Enable trade buttons
    document.getElementById('btn-trade-yes').disabled = false;
    document.getElementById('btn-trade-no').disabled = false;

    // Load price chart
    loadPriceChart(s);
}

async function refreshSignals() {
    try {
        const data = await fetch('/api/signals', { credentials: 'include' }).then(r => r.json());
        signals = data;
        renderSignals();
        addLog('info', signals.length + ' Signale geladen');
    } catch (err) {
        addLog('error', 'Signals Refresh fehlgeschlagen');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        SCANNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function startScan() {
    document.getElementById('scan-btn').disabled = true;
    document.getElementById('scan-btn').classList.add('scanning');
    document.getElementById('scan-btn').textContent = 'â—Œ SCANNT...';
    document.getElementById('scan-status').textContent = 'SCANNING';

    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    addLog('info', 'STARTE MARKT-SCAN');
    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    try {
        const result = await fetch('/api/scan', { method: 'POST', credentials: 'include' }).then(r => r.json());
        handleScanResult(result);
    } catch (err) {
        addLog('error', 'Scan fehlgeschlagen: ' + err.message);
    } finally {
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('scan-btn').classList.remove('scanning');
        document.getElementById('scan-btn').textContent = 'â–¶ SCAN STARTEN';
        document.getElementById('scan-status').textContent = 'BEREIT';
    }
}

function handleScanResult(result) {
    const count = result.signalsFound?.length || 0;
    const highAlpha = result.signalsFound?.filter(s => s.score > 0.7).length || 0;

    addLog('info', result.marketsScanned + ' MÃ¤rkte gescannt');
    addLog('success', count + ' Signale gefunden (' + highAlpha + ' High Alpha)');
    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    if (count > 0) {
        signals = result.signalsFound;
        renderSignals();
        showView('signals');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        RISK CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function setMode(mode) {
    try {
        const res = await fetch('/api/execution/mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ mode })
        }).then(r => r.json());

        if (res.success) {
            updateModeUI(res.mode);
            addLog('success', 'Mode: ' + res.mode.toUpperCase());
        } else {
            addLog('error', res.error || 'Mode change failed');
        }
    } catch (err) {
        addLog('error', 'Mode Fehler: ' + err.message);
    }
}

async function toggleKillSwitch() {
    try {
        const res = await fetch('/api/risk/killswitch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ action: 'toggle' })
        }).then(r => r.json());

        if (res.success) {
            updateKillSwitchUI(res.killSwitchActive);
        }
    } catch (err) {
        addLog('error', 'Kill-Switch Fehler');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        TRADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function executeTrade(direction) {
    if (!selectedSignal) return;

    addLog('info', 'Trade ' + direction + ' fÃ¼r ' + selectedSignal.id?.substring(0, 8) + '...');

    try {
        const res = await fetch('/api/trade/' + selectedSignal.id, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ direction })
        }).then(r => r.json());

        if (res.success) {
            addLog('success', 'Trade vorbereitet: ' + res.message);
        } else {
            addLog('error', res.error || 'Trade fehlgeschlagen');
        }
    } catch (err) {
        addLog('error', 'Trade Fehler: ' + err.message);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        TICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let tickerStats = { news: 0, matches: 0 };

function handleTickerEvent(event) {
    const log = document.getElementById('ticker-log');
    const time = new Date(event.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

    if (event.type === 'match_found' || event.type === 'no_match') {
        tickerStats.news++;
        if (event.type === 'match_found') tickerStats.matches++;
        document.getElementById('ticker-news').textContent = tickerStats.news;
        document.getElementById('ticker-matches').textContent = tickerStats.matches;
    }

    const entry = document.createElement('div');
    entry.className = 'log-entry';

    if (event.type === 'match_found') {
        const score = (event.matchResult?.markets?.[0]?.matchScore * 100).toFixed(0);
        const bar = 'â–ˆ'.repeat(Math.round(score / 10)) + 'â–‘'.repeat(10 - Math.round(score / 10));
        entry.innerHTML = `
            <span class="log-time">[${time}]</span>
            <span class="log-level success">MATCH</span>
            <span class="log-message"><span style="color: var(--green-profit); font-family: monospace;">${bar}</span> ${score}% â†’ ${event.matchResult?.markets?.[0]?.question?.substring(0, 40)}...</span>
        `;
    } else if (event.type === 'news_in') {
        entry.innerHTML = `
            <span class="log-time">[${time}]</span>
            <span class="log-level info">NEWS</span>
            <span class="log-message">${event.source}: ${event.title?.substring(0, 60)}...</span>
        `;
    } else {
        entry.innerHTML = `
            <span class="log-time">[${time}]</span>
            <span class="log-level system">â”€â”€</span>
            <span class="log-message" style="color: var(--text-muted);">no match</span>
        `;
    }

    log.appendChild(entry);
    while (log.children.length > 100) log.removeChild(log.firstChild);
    log.scrollTop = log.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        ALMANIEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderPolls(polls) {
    const container = document.getElementById('polls-data');
    if (!polls?.length) {
        container.innerHTML = '<span style="color: var(--text-muted);">Keine Umfragen</span>';
        return;
    }

    const poll = polls[0];
    const parties = ['CDU/CSU', 'AfD', 'SPD', 'GrÃ¼ne', 'BSW', 'FDP'];
    const colors = { 'CDU/CSU': '#666', 'AfD': '#00aaff', 'SPD': '#ff3333', 'GrÃ¼ne': '#22cc33', 'BSW': '#ff6600', 'FDP': '#ffdd00' };

    let html = `<div style="font-size: 9px; color: var(--text-muted); margin-bottom: 12px;">${poll.institute} | ${poll.date}</div>`;

    html += parties.map(party => {
        const val = poll.results?.[party] || 0;
        if (!val) return '';
        return `
            <div style="display: flex; align-items: center; gap: 8px; margin: 4px 0;">
                <span style="width: 60px; font-size: 10px; color: var(--text-muted);">${party}</span>
                <div style="flex: 1; height: 12px; background: var(--bg-terminal);">
                    <div style="width: ${val * 2}%; height: 100%; background: ${colors[party] || 'var(--green-dim)'}; position: relative;">
                        <div style="position: absolute; right: 0; top: 0; bottom: 0; width: 2px; background: ${colors[party]}; box-shadow: 0 0 4px ${colors[party]};"></div>
                    </div>
                </div>
                <span style="width: 30px; text-align: right; font-size: 10px;">${val}%</span>
            </div>
        `;
    }).filter(x => x).join('');

    container.innerHTML = html;
}

function renderNews(news) {
    const container = document.getElementById('news-data');
    if (!news?.length) {
        container.innerHTML = '<span style="color: var(--text-muted);">Keine News</span>';
        return;
    }

    container.innerHTML = news.slice(0, 10).map(item => `
        <div style="padding: 8px 0; border-bottom: 1px solid var(--border-dim);">
            <div style="font-size: 9px; color: var(--text-muted);">${item.data?.source || 'NEWS'}</div>
            <div style="font-size: 11px; color: var(--text-secondary);">${item.title}</div>
        </div>
    `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        CONSOLE LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function addLog(level, message) {
    const log = document.getElementById('console-log');
    const time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-level ${level}">${level.toUpperCase().padEnd(7)}</span>
        <span class="log-message">${message}</span>
    `;

    log.appendChild(entry);
    while (log.children.length > 500) log.removeChild(log.firstChild);
    log.scrollTop = log.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initClock() {
    function update() {
        document.getElementById('clock').textContent = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    update();
    setInterval(update, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        BACKTEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadBacktestData() {
    try {
        const res = await fetch('/api/backtest/data', { credentials: 'include' }).then(r => r.json());
        const container = document.getElementById('bt-data-info');

        if (res.available) {
            document.getElementById('bt-trade-count').textContent = res.tradeCount.toLocaleString();

            // Set default dates from data range
            if (res.dateRange?.from) {
                document.getElementById('bt-from').value = res.dateRange.from.substring(0, 10);
            }
            if (res.dateRange?.to) {
                document.getElementById('bt-to').value = res.dateRange.to.substring(0, 10);
            }

            container.innerHTML = `
                <div class="data-row"><span class="data-label">Trades</span><span class="data-value">${res.tradeCount.toLocaleString()}</span></div>
                <div class="data-row"><span class="data-label">MÃ¤rkte</span><span class="data-value">${res.marketCount.toLocaleString()}</span></div>
                <div class="data-row"><span class="data-label">Resolved</span><span class="data-value">${res.resolvedCount.toLocaleString()}</span></div>
                <div class="data-row"><span class="data-label">Von</span><span class="data-value">${res.dateRange?.from?.substring(0, 10) || '--'}</span></div>
                <div class="data-row"><span class="data-label">Bis</span><span class="data-value">${res.dateRange?.to?.substring(0, 10) || '--'}</span></div>
            `;
        } else {
            document.getElementById('bt-trade-count').textContent = '0';
            container.innerHTML = `
                <div style="color: var(--amber-watch); font-size: 10px;">
                    ${res.error || 'Keine Daten'}<br><br>
                    <span style="color: var(--text-muted);">${res.hint || 'Importiere mit npm run import:polydata'}</span>
                </div>
            `;
        }
    } catch (err) {
        document.getElementById('bt-data-info').innerHTML = '<span style="color: var(--red-risk);">Fehler beim Laden</span>';
    }
}

async function runBacktest() {
    const btn = document.getElementById('bt-run-btn');
    const progressPanel = document.getElementById('bt-progress-panel');

    btn.disabled = true;
    btn.textContent = 'â—Œ LÃ„UFT...';
    progressPanel.style.display = 'block';

    const params = {
        engine: document.getElementById('bt-engine').value,
        from: document.getElementById('bt-from').value || undefined,
        to: document.getElementById('bt-to').value || undefined,
        bankroll: parseFloat(document.getElementById('bt-bankroll').value) || 1000,
        slippage: document.getElementById('bt-slippage').checked
    };

    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    addLog('info', 'STARTE BACKTEST: ' + params.engine.toUpperCase());
    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    try {
        const res = await fetch('/api/backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(params)
        }).then(r => r.json());

        if (res.error) {
            throw new Error(res.error);
        }

        addLog('success', 'Backtest gestartet');

        // Poll for completion
        pollBacktestStatus();
    } catch (err) {
        addLog('error', 'Backtest Fehler: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'â–¶ BACKTEST STARTEN';
        progressPanel.style.display = 'none';
    }
}

async function pollBacktestStatus() {
    const btn = document.getElementById('bt-run-btn');
    const progressBar = document.getElementById('bt-progress-bar');
    const progressText = document.getElementById('bt-progress-text');
    const progressPanel = document.getElementById('bt-progress-panel');

    try {
        const status = await fetch('/api/backtest/status', { credentials: 'include' }).then(r => r.json());

        progressBar.style.width = status.progress + '%';
        progressText.textContent = status.currentPhase;

        if (status.running) {
            setTimeout(pollBacktestStatus, 500);
        } else if (status.error) {
            addLog('error', 'Backtest fehlgeschlagen: ' + status.error);
            btn.disabled = false;
            btn.textContent = 'â–¶ BACKTEST STARTEN';
            progressPanel.style.display = 'none';
        } else if (status.hasResult) {
            addLog('success', 'Backtest abgeschlossen');
            btn.disabled = false;
            btn.textContent = 'â–¶ BACKTEST STARTEN';
            progressPanel.style.display = 'none';
            loadBacktestResults();
        }
    } catch (err) {
        addLog('error', 'Status-Abfrage fehlgeschlagen');
        btn.disabled = false;
        btn.textContent = 'â–¶ BACKTEST STARTEN';
    }
}

async function loadBacktestResults() {
    try {
        const res = await fetch('/api/backtest/results', { credentials: 'include' }).then(r => r.json());

        const container = document.getElementById('bt-results');
        const pnlClass = res.metrics.totalPnl >= 0 ? 'positive' : 'negative';
        const pnlSign = res.metrics.totalPnl >= 0 ? '+' : '';
        const profitFactorStr = res.metrics.profitFactor === Infinity ? 'âˆ' : res.metrics.profitFactor?.toFixed(2) || '--';

        container.innerHTML = `
            <!-- Header mit Download-Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 14px; font-weight: 600; color: var(--green-profit);">
                    ${res.engine.toUpperCase()} ENGINE BACKTEST
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="downloadBacktestJSON()" class="btn" style="font-size: 10px; padding: 6px 12px;">
                        â†“ JSON
                    </button>
                    <button onclick="downloadBacktestCSV()" class="btn" style="font-size: 10px; padding: 6px 12px;">
                        â†“ CSV
                    </button>
                    <button onclick="downloadBacktestMarkdown()" class="btn" style="font-size: 10px; padding: 6px 12px;">
                        â†“ MD
                    </button>
                </div>
            </div>

            <!-- Haupt-KPIs -->
            <div class="panel" style="margin-bottom: 16px;">
                <div class="panel-header">PERFORMANCE</div>
                <div class="panel-body">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 28px; font-weight: 700;" class="${pnlClass}">${pnlSign}$${res.metrics.totalPnl.toFixed(2)}</div>
                            <div style="font-size: 10px; color: var(--text-muted);">TOTAL PnL</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: 700;">${(res.metrics.winRate * 100).toFixed(1)}%</div>
                            <div style="font-size: 10px; color: var(--text-muted);">WIN RATE</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: 700;">${res.metrics.sharpeRatio.toFixed(2)}</div>
                            <div style="font-size: 10px; color: var(--text-muted);">SHARPE</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: 700;">${res.tradeCount}</div>
                            <div style="font-size: 10px; color: var(--text-muted);">TRADES</div>
                        </div>
                    </div>
                    <div style="font-size: 10px; color: var(--text-muted);">
                        Zeitraum: ${res.period.from.substring(0, 10)} bis ${res.period.to.substring(0, 10)}
                    </div>
                </div>
            </div>

            <!-- Equity Curve Chart -->
            <div class="panel" style="margin-bottom: 16px;">
                <div class="panel-header">EQUITY CURVE</div>
                <div class="panel-body" style="padding: 0;">
                    <div id="bt-equity-chart" style="height: 200px; width: 100%;"></div>
                </div>
            </div>

            <!-- Erweiterte Metriken -->
            <div class="panel" style="margin-bottom: 16px;">
                <div class="panel-header">METRIKEN</div>
                <div class="panel-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <div class="data-row"><span class="data-label">Max Drawdown</span><span class="data-value negative">-$${Math.abs(res.metrics.maxDrawdown).toFixed(2)}</span></div>
                            <div class="data-row"><span class="data-label">Profit Factor</span><span class="data-value">${profitFactorStr}</span></div>
                            <div class="data-row"><span class="data-label">Brier Score</span><span class="data-value">${res.metrics.brierScore.toFixed(3)}</span></div>
                            <div class="data-row"><span class="data-label">Edge Capture</span><span class="data-value">${(res.metrics.avgEdgeCapture * 100).toFixed(1)}%</span></div>
                        </div>
                        <div>
                            <div class="data-row"><span class="data-label">Avg Win</span><span class="data-value positive">+$${res.metrics.avgWin?.toFixed(2) || '0.00'}</span></div>
                            <div class="data-row"><span class="data-label">Avg Loss</span><span class="data-value negative">-$${res.metrics.avgLoss?.toFixed(2) || '0.00'}</span></div>
                            <div class="data-row"><span class="data-label">Wins/Losses</span><span class="data-value">${res.metrics.winCount || 0} / ${res.metrics.lossCount || 0}</span></div>
                            <div class="data-row"><span class="data-label">Avg Slippage</span><span class="data-value">${(res.metrics.avgSlippage * 100).toFixed(2)}%</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calibration Buckets -->
            ${res.calibration && res.calibration.length > 0 ? `
            <div class="panel" style="margin-bottom: 16px;">
                <div class="panel-header">KALIBRIERUNG (Predicted vs Actual)</div>
                <div class="panel-body" style="padding: 0;">
                    <div id="bt-calibration-chart" style="height: 150px; width: 100%;"></div>
                </div>
            </div>
            ` : ''}

            <!-- Top/Worst Trades Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="panel">
                    <div class="panel-header">TOP 5 TRADES</div>
                    <div class="panel-body" style="font-size: 10px;">
                        ${res.topTrades.slice(0, 5).map(t => `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border-dim);">
                                <span style="color: var(--text-muted); max-width: 100px; overflow: hidden; text-overflow: ellipsis;" title="${t.marketId}">${t.marketId.substring(0, 10)}...</span>
                                <span style="color: var(--${t.direction === 'yes' ? 'green-profit' : 'red-risk'});">${t.direction.toUpperCase()}</span>
                                <span class="positive">+$${t.pnl?.toFixed(2) || '0.00'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">WORST 5 TRADES</div>
                    <div class="panel-body" style="font-size: 10px;">
                        ${res.worstTrades.slice(0, 5).map(t => `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border-dim);">
                                <span style="color: var(--text-muted); max-width: 100px; overflow: hidden; text-overflow: ellipsis;" title="${t.marketId}">${t.marketId.substring(0, 10)}...</span>
                                <span style="color: var(--${t.direction === 'yes' ? 'green-profit' : 'red-risk'});">${t.direction.toUpperCase()}</span>
                                <span class="negative">$${t.pnl?.toFixed(2) || '0.00'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        // Equity Curve Chart rendern
        renderEquityCurveChart(res.equityCurve || []);

        // Calibration Chart rendern
        if (res.calibration && res.calibration.length > 0) {
            renderCalibrationChart(res.calibration);
        }

        addLog('info', 'Ergebnis: PnL=' + pnlSign + '$' + res.metrics.totalPnl.toFixed(2) + ', WinRate=' + (res.metrics.winRate * 100).toFixed(1) + '%');
        addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    } catch (err) {
        addLog('error', 'Ergebnisse laden fehlgeschlagen');
    }
}

// Equity Curve Chart mit Canvas (leichtgewichtig, keine externe Library)
function renderEquityCurveChart(data) {
    const container = document.getElementById('bt-equity-chart');
    if (!container || !data || data.length === 0) return;

    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth || 600;
    canvas.height = 200;
    container.innerHTML = '';
    container.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    const padding = { top: 20, right: 20, bottom: 30, left: 60 };
    const chartWidth = canvas.width - padding.left - padding.right;
    const chartHeight = canvas.height - padding.top - padding.bottom;

    // Min/Max berechnen
    const equities = data.map(d => d.equity);
    const minEquity = Math.min(...equities) * 0.98;
    const maxEquity = Math.max(...equities) * 1.02;
    const range = maxEquity - minEquity || 1;

    // Hintergrund
    ctx.fillStyle = '#0d0d0d';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Grid Lines
    ctx.strokeStyle = '#1a1a1a';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(canvas.width - padding.right, y);
        ctx.stroke();
    }

    // Y-Achsen Labels
    ctx.fillStyle = '#555555';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 4; i++) {
        const value = maxEquity - (range / 4) * i;
        const y = padding.top + (chartHeight / 4) * i;
        ctx.fillText('$' + value.toFixed(0), padding.left - 8, y + 4);
    }

    // Equity Line zeichnen
    if (data.length > 1) {
        ctx.beginPath();
        ctx.strokeStyle = '#00ff88';
        ctx.lineWidth = 2;
        ctx.lineJoin = 'round';

        for (let i = 0; i < data.length; i++) {
            const x = padding.left + (i / (data.length - 1)) * chartWidth;
            const y = padding.top + ((maxEquity - data[i].equity) / range) * chartHeight;
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();

        // Gradient Fill
        ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
        ctx.lineTo(padding.left, padding.top + chartHeight);
        ctx.closePath();
        const gradient = ctx.createLinearGradient(0, padding.top, 0, padding.top + chartHeight);
        gradient.addColorStop(0, 'rgba(0, 255, 136, 0.15)');
        gradient.addColorStop(1, 'rgba(0, 255, 136, 0)');
        ctx.fillStyle = gradient;
        ctx.fill();
    }

    // Baseline ($1000)
    const baselineY = padding.top + ((maxEquity - 1000) / range) * chartHeight;
    if (baselineY >= padding.top && baselineY <= padding.top + chartHeight) {
        ctx.strokeStyle = '#555555';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(padding.left, baselineY);
        ctx.lineTo(canvas.width - padding.right, baselineY);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // Final Equity Label
    if (data.length > 0) {
        const finalEquity = data[data.length - 1].equity;
        const finalY = padding.top + ((maxEquity - finalEquity) / range) * chartHeight;
        ctx.fillStyle = finalEquity >= 1000 ? '#00ff88' : '#ff3344';
        ctx.font = 'bold 11px JetBrains Mono';
        ctx.textAlign = 'left';
        ctx.fillText('$' + finalEquity.toFixed(0), canvas.width - padding.right + 5, finalY + 4);
    }
}

// Calibration Chart
function renderCalibrationChart(buckets) {
    const container = document.getElementById('bt-calibration-chart');
    if (!container || !buckets || buckets.length === 0) return;

    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth || 600;
    canvas.height = 150;
    container.innerHTML = '';
    container.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    const padding = { top: 20, right: 20, bottom: 40, left: 50 };
    const chartWidth = canvas.width - padding.left - padding.right;
    const chartHeight = canvas.height - padding.top - padding.bottom;
    const barWidth = chartWidth / buckets.length - 8;

    // Hintergrund
    ctx.fillStyle = '#0d0d0d';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Diagonal Line (perfekte Kalibrierung)
    ctx.strokeStyle = '#555555';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(padding.left, padding.top + chartHeight);
    ctx.lineTo(padding.left + chartWidth, padding.top);
    ctx.stroke();
    ctx.setLineDash([]);

    // Bars zeichnen
    buckets.forEach((bucket, i) => {
        const x = padding.left + i * (chartWidth / buckets.length) + 4;
        const predictedHeight = bucket.predictedAvg * chartHeight;
        const actualHeight = bucket.actualAvg * chartHeight;

        // Predicted (grau)
        ctx.fillStyle = '#333333';
        ctx.fillRect(x, padding.top + chartHeight - predictedHeight, barWidth / 2 - 2, predictedHeight);

        // Actual (grÃ¼n/rot basierend auf Abweichung)
        const diff = bucket.actualAvg - bucket.predictedAvg;
        ctx.fillStyle = Math.abs(diff) < 0.1 ? '#00ff88' : (diff > 0 ? '#00aaff' : '#ff3344');
        ctx.fillRect(x + barWidth / 2, padding.top + chartHeight - actualHeight, barWidth / 2 - 2, actualHeight);

        // Label
        ctx.fillStyle = '#555555';
        ctx.font = '9px JetBrains Mono';
        ctx.textAlign = 'center';
        const label = bucket.range[0].toFixed(1) + '-' + bucket.range[1].toFixed(1);
        ctx.fillText(label, x + barWidth / 2, padding.top + chartHeight + 12);
        ctx.fillText('n=' + bucket.count, x + barWidth / 2, padding.top + chartHeight + 24);
    });

    // Legend
    ctx.font = '9px JetBrains Mono';
    ctx.fillStyle = '#333333';
    ctx.fillRect(canvas.width - 100, 8, 10, 10);
    ctx.fillStyle = '#888888';
    ctx.fillText('Predicted', canvas.width - 85, 17);
    ctx.fillStyle = '#00ff88';
    ctx.fillRect(canvas.width - 100, 22, 10, 10);
    ctx.fillStyle = '#888888';
    ctx.fillText('Actual', canvas.width - 85, 31);
}

// Download Functions
function downloadBacktestJSON() {
    window.open('/api/backtest/results?format=json-file', '_blank');
}

function downloadBacktestCSV() {
    window.location.href = '/api/backtest/results?format=csv';
}

function downloadBacktestMarkdown() {
    window.open('/api/backtest/results?format=markdown', '_blank');
}

// WebSocket events for backtest
if (typeof socket !== 'undefined') {
    socket?.on('backtest_progress', (data) => {
        document.getElementById('bt-progress-bar').style.width = data.progress + '%';
        document.getElementById('bt-progress-text').textContent = data.phase;
    });

    socket?.on('backtest_completed', (data) => {
        addLog('success', 'Backtest: ' + data.tradeCount + ' Trades, PnL=$' + data.totalPnl.toFixed(2));
        loadBacktestResults();
    });

    socket?.on('backtest_error', (data) => {
        addLog('error', 'Backtest Fehler: ' + data.error);
    });
}

// Load data when switching views
const origShowView = showView;
showView = function(viewId) {
    origShowView(viewId);
    if (viewId === 'backtest') {
        loadBacktestData();
    } else if (viewId === 'markets') {
        loadPipelineHealth();
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        PIPELINE HEALTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let pipelineReconnects = 0;

async function loadPipelineHealth() {
    try {
        const res = await fetch('/api/pipelines/health', { credentials: 'include' }).then(r => r.json());

        // Overall status
        const overallDot = document.getElementById('pipeline-overall-status');
        const overallText = document.getElementById('pipeline-overall-text');
        overallDot.className = 'status-dot ' + (res.overall ? '' : 'error');
        overallText.textContent = res.overall ? 'ALL HEALTHY' : 'ISSUES DETECTED';

        // Update each pipeline
        res.pipelines.forEach(p => {
            updatePipelineCard(p.name, p);
        });

        // Scanner specific
        if (res.lastScan) {
            document.getElementById('pl-scanner-last').textContent = formatTimeAgo(new Date(res.lastScan));
        }
        if (res.lastSignal) {
            document.getElementById('pl-scanner-signal').textContent = formatTimeAgo(new Date(res.lastSignal));
        }

        // WebSocket status
        document.getElementById('pl-ws-status').textContent = socket?.connected ? 'CONNECTED' : 'DISCONNECTED';
        document.getElementById('pl-ws-dot').className = 'status-dot ' + (socket?.connected ? '' : 'error');
        document.getElementById('pl-ws-connected').textContent = socket?.connected ? 'Yes' : 'No';
        document.getElementById('pl-ws-reconnects').textContent = pipelineReconnects;

        addPipelineLog('info', 'Pipeline-Status aktualisiert');
    } catch (err) {
        addPipelineLog('error', 'Fehler beim Laden: ' + err.message);
    }
}

function updatePipelineCard(name, data) {
    const statusEl = document.getElementById(`pl-${name}-status`);
    const dotEl = document.getElementById(`pl-${name}-dot`);
    const lastEl = document.getElementById(`pl-${name}-last`);
    const errorsEl = document.getElementById(`pl-${name}-errors`);

    if (statusEl) {
        statusEl.textContent = data.status === 'ok' ? 'HEALTHY' : data.status === 'stale' ? 'STALE' : 'ERROR';
        statusEl.className = 'data-value ' + (data.status === 'ok' ? 'positive' : data.status === 'stale' ? 'warning' : 'negative');
    }
    if (dotEl) {
        dotEl.className = 'status-dot ' + (data.status === 'ok' ? '' : data.status === 'stale' ? 'warning' : 'error');
    }
    if (lastEl && data.lastSuccess) {
        lastEl.textContent = formatTimeAgo(new Date(data.lastSuccess));
    }
    if (errorsEl) {
        errorsEl.textContent = data.errorCount || 0;
        errorsEl.className = 'data-value ' + (data.errorCount > 0 ? 'negative' : '');
    }
}

function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHr = Math.floor(diffMin / 60);

    if (diffSec < 60) return diffSec + 's ago';
    if (diffMin < 60) return diffMin + 'm ago';
    if (diffHr < 24) return diffHr + 'h ago';
    return date.toLocaleDateString('de-DE');
}

function addPipelineLog(level, message) {
    const log = document.getElementById('pipeline-log');
    if (!log) return;

    const time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-level ${level}">${level.toUpperCase().padEnd(7)}</span>
        <span class="log-message">${message}</span>
    `;

    log.appendChild(entry);
    while (log.children.length > 100) log.removeChild(log.firstChild);
    log.scrollTop = log.scrollHeight;
}

// Track WebSocket reconnects
if (socket) {
    socket.on('connect', () => {
        document.getElementById('pl-ws-status').textContent = 'CONNECTED';
        document.getElementById('pl-ws-dot').className = 'status-dot';
        document.getElementById('pl-ws-connected').textContent = 'Yes';
    });
    socket.on('reconnect', () => {
        pipelineReconnects++;
        document.getElementById('pl-ws-reconnects').textContent = pipelineReconnects;
        addPipelineLog('warn', 'WebSocket reconnected');
    });
    socket.on('disconnect', () => {
        document.getElementById('pl-ws-status').textContent = 'DISCONNECTED';
        document.getElementById('pl-ws-dot').className = 'status-dot error';
        document.getElementById('pl-ws-connected').textContent = 'No';
        addPipelineLog('error', 'WebSocket disconnected');
    });

    // Pipeline alerts
    socket.on('pipeline_alert', (data) => {
        addPipelineLog('warn', `Pipeline ${data.pipeline} unhealthy (${data.errorCount} errors)`);
        loadPipelineHealth();
    });
}

// Auto-refresh pipeline health every 30 seconds when on that view
setInterval(() => {
    if (document.getElementById('view-markets').classList.contains('active')) {
        loadPipelineHealth();
    }
}, 30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        PERFORMANCE DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let performanceData = null;
let executionQualityData = null;

async function loadPerformanceData() {
    try {
        // Load multiple APIs in parallel
        const [tradingRes, equityRes, executionRes] = await Promise.all([
            fetch('/api/stats/trading', { credentials: 'include' }).then(r => r.json()),
            fetch('/api/stats/equity', { credentials: 'include' }).then(r => r.json()),
            fetch('/api/execution/quality', { credentials: 'include' }).then(r => r.json()).catch(() => null),
        ]);

        performanceData = { trading: tradingRes, equity: equityRes };
        executionQualityData = executionRes;

        // Update KPI Cards
        const daily = tradingRes.daily || {};
        const pnl = daily.pnl || 0;
        const pnlEl = document.getElementById('perf-pnl');
        pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
        pnlEl.className = pnl >= 0 ? 'positive' : 'negative';

        const winRate = (daily.winRate || 0) * 100;
        document.getElementById('perf-winrate').textContent = winRate.toFixed(1) + '%';

        const trades = daily.trades || 0;
        document.getElementById('perf-trades').textContent = trades;

        // Sharpe (estimated from daily data)
        const sharpe = calculateEstimatedSharpe(equityRes);
        document.getElementById('perf-sharpe').textContent = sharpe.toFixed(2);

        // Max Drawdown
        const maxDD = calculateMaxDrawdown(equityRes.equityCurve || []);
        const ddEl = document.getElementById('perf-drawdown');
        ddEl.textContent = '-' + (maxDD * 100).toFixed(1) + '%';

        // Execution Quality Score
        if (executionRes && executionRes.metrics) {
            document.getElementById('perf-quality').textContent = executionRes.metrics.executionQualityScore || '--';
        }

        // Update Equity Chart
        renderPerformanceEquityCurve(equityRes.equityCurve || []);

        // Update Streaks
        updateStreakStats(daily);

        // Update Execution Quality Details
        if (executionRes && executionRes.metrics) {
            updateExecutionQualityDisplay(executionRes.metrics);
            updateRecommendations(executionRes.recommendations || []);
        }

    } catch (err) {
        console.error('Performance load error:', err);
    }
}

function calculateEstimatedSharpe(equityData) {
    if (!equityData || !equityData.equityCurve || equityData.equityCurve.length < 2) return 0;

    const returns = [];
    for (let i = 1; i < equityData.equityCurve.length; i++) {
        const prevEquity = equityData.equityCurve[i - 1].cumulative || 1000;
        const currEquity = equityData.equityCurve[i].cumulative || 1000;
        returns.push((currEquity - prevEquity) / prevEquity);
    }

    if (returns.length === 0) return 0;

    const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
    const variance = returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / (returns.length - 1);
    const stdDev = Math.sqrt(variance);

    if (stdDev === 0) return avgReturn > 0 ? 99 : 0;

    // Annualized (assuming ~250 trades per year)
    const annualizedReturn = avgReturn * 250;
    const annualizedStdDev = stdDev * Math.sqrt(250);

    return (annualizedReturn - 0.05) / annualizedStdDev; // 5% risk-free
}

function calculateMaxDrawdown(equityCurve) {
    if (!equityCurve || equityCurve.length === 0) return 0;

    let peak = 1000;
    let maxDD = 0;

    for (const point of equityCurve) {
        const equity = point.equity || point.cumulative || 1000;
        if (equity > peak) peak = equity;
        const dd = (peak - equity) / peak;
        if (dd > maxDD) maxDD = dd;
    }

    return maxDD;
}

function renderPerformanceEquityCurve(data) {
    const container = document.getElementById('perf-equity-chart');
    if (!container || !data || data.length === 0) {
        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">Keine Daten verfÃ¼gbar</div>';
        return;
    }

    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth || 600;
    canvas.height = 200;
    container.innerHTML = '';
    container.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    const padding = { top: 20, right: 60, bottom: 30, left: 60 };
    const chartWidth = canvas.width - padding.left - padding.right;
    const chartHeight = canvas.height - padding.top - padding.bottom;

    // Prepare data
    const equities = data.map(d => d.equity || d.cumulative || 1000);
    const minEquity = Math.min(...equities) * 0.98;
    const maxEquity = Math.max(...equities) * 1.02;
    const range = maxEquity - minEquity || 1;

    // Background
    ctx.fillStyle = '#0d0d0d';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Grid
    ctx.strokeStyle = '#1a1a1a';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(canvas.width - padding.right, y);
        ctx.stroke();
    }

    // Y-Axis labels
    ctx.fillStyle = '#555555';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 4; i++) {
        const value = maxEquity - (range / 4) * i;
        const y = padding.top + (chartHeight / 4) * i;
        ctx.fillText('$' + value.toFixed(0), padding.left - 8, y + 4);
    }

    // Line
    if (data.length > 1) {
        ctx.beginPath();
        ctx.strokeStyle = '#00ff88';
        ctx.lineWidth = 2;

        for (let i = 0; i < data.length; i++) {
            const x = padding.left + (i / (data.length - 1)) * chartWidth;
            const equity = data[i].equity || data[i].cumulative || 1000;
            const y = padding.top + ((maxEquity - equity) / range) * chartHeight;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Fill
        ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
        ctx.lineTo(padding.left, padding.top + chartHeight);
        ctx.closePath();
        const gradient = ctx.createLinearGradient(0, padding.top, 0, padding.top + chartHeight);
        gradient.addColorStop(0, 'rgba(0, 255, 136, 0.15)');
        gradient.addColorStop(1, 'rgba(0, 255, 136, 0)');
        ctx.fillStyle = gradient;
        ctx.fill();
    }

    // Final value label
    if (data.length > 0) {
        const finalEquity = data[data.length - 1].equity || data[data.length - 1].cumulative || 1000;
        const finalY = padding.top + ((maxEquity - finalEquity) / range) * chartHeight;
        ctx.fillStyle = finalEquity >= 1000 ? '#00ff88' : '#ff3344';
        ctx.font = 'bold 11px JetBrains Mono';
        ctx.textAlign = 'left';
        ctx.fillText('$' + finalEquity.toFixed(0), canvas.width - padding.right + 5, finalY + 4);
    }
}

function updateStreakStats(daily) {
    // Current streak (simplified - would need trade history)
    const wins = daily.wins || 0;
    const losses = daily.losses || 0;

    if (wins > 0 && losses === 0) {
        document.getElementById('perf-streak').textContent = '+' + wins + ' W';
        document.getElementById('perf-streak').className = 'data-value positive';
    } else if (losses > 0 && wins === 0) {
        document.getElementById('perf-streak').textContent = '-' + losses + ' L';
        document.getElementById('perf-streak').className = 'data-value negative';
    } else {
        document.getElementById('perf-streak').textContent = 'Mixed';
        document.getElementById('perf-streak').className = 'data-value';
    }

    // Avg Win/Loss
    const avgWin = wins > 0 && daily.pnl > 0 ? daily.pnl / wins : 0;
    const avgLoss = losses > 0 && daily.pnl < 0 ? Math.abs(daily.pnl) / losses : 0;
    document.getElementById('perf-avg-win').textContent = '+$' + avgWin.toFixed(2);
    document.getElementById('perf-avg-loss').textContent = '-$' + avgLoss.toFixed(2);

    // Profit Factor
    const grossProfit = avgWin * wins;
    const grossLoss = avgLoss * losses;
    const profitFactor = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : (grossProfit > 0 ? 'âˆ' : '--');
    document.getElementById('perf-profit-factor').textContent = profitFactor;
}

function updateExecutionQualityDisplay(metrics) {
    document.getElementById('perf-fill-rate').textContent = (metrics.fillRate * 100).toFixed(1) + '%';
    document.getElementById('perf-avg-slippage').textContent = (metrics.avgActualSlippage * 100).toFixed(3) + '%';
    document.getElementById('perf-exp-slippage').textContent = (metrics.avgExpectedSlippage * 100).toFixed(3) + '%';
    document.getElementById('perf-slip-cost').textContent = '$' + (metrics.slippageCost || 0).toFixed(2);
    document.getElementById('perf-latency').textContent = Math.round(metrics.avgTotalLatency || 0) + 'ms';
    document.getElementById('perf-p95-latency').textContent = Math.round(metrics.p95Latency || 0) + 'ms';
    document.getElementById('perf-price-improve').textContent = ((metrics.priceImprovementRate || 0) * 100).toFixed(0) + '%';

    const accuracy = metrics.slippageAccuracy || 1;
    const accuracyDisplay = accuracy < 1.5 && accuracy > 0.5 ? 'Good' : (accuracy >= 1.5 ? 'Under' : 'Over');
    document.getElementById('perf-model-acc').textContent = accuracyDisplay;
}

function updateRecommendations(recommendations) {
    const container = document.getElementById('perf-recommendations');
    if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<div style="color: var(--green-profit);">âœ“ Alle Systeme optimal</div>';
        return;
    }

    container.innerHTML = recommendations.map((rec, i) => `
        <div style="padding: 4px 0; ${i > 0 ? 'border-top: 1px solid var(--border-dim);' : ''}">
            <span style="color: var(--amber-watch);">âš </span> ${rec}
        </div>
    `).join('');
}

// Load performance when switching to view
const origShowViewPerf = showView;
showView = function(viewId) {
    origShowViewPerf(viewId);
    if (viewId === 'performance') {
        loadPerformanceData();
    }
};

// Auto-refresh performance every 60 seconds when on that view
setInterval(() => {
    if (document.getElementById('view-performance')?.classList.contains('active')) {
        loadPerformanceData();
    }
}, 60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        PRICE CHARTS (Lightweight-Charts)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let priceChart = null;
let priceSeries = null;

// Load signal markers for the chart
async function loadSignalMarkers(marketId) {
    if (!priceSeries || !marketId) return;

    try {
        const res = await fetch(`/api/signals/market/${marketId}`, { credentials: 'include' }).then(r => r.json());

        if (!res.signals || res.signals.length === 0) return;

        // Convert signals to Lightweight-Charts marker format
        const markers = res.signals.map(s => {
            const time = Math.floor(new Date(s.createdAt).getTime() / 1000);
            const isUp = s.direction === 'BUY' || s.direction === 'YES';
            const isMispricing = s.alphaType === 'MISPRICING';
            const edgePct = (s.predictedEdge * 100).toFixed(1);

            return {
                time,
                position: isUp ? 'belowBar' : 'aboveBar',
                color: isMispricing ? '#00d4ff' : '#ff9900',
                shape: isUp ? 'arrowUp' : 'arrowDown',
                text: `${s.alphaType.substring(0, 3)} ${edgePct}%`,
            };
        });

        // Sort markers by time (Lightweight-Charts requirement)
        markers.sort((a, b) => a.time - b.time);

        priceSeries.setMarkers(markers);
        addLog('info', `Chart: ${markers.length} Signal-Marker geladen`);
    } catch (err) {
        console.warn('Marker laden fehlgeschlagen:', err);
    }
}

async function loadPriceChart(signal) {
    const container = document.getElementById('chart-container');
    const marketId = signal.market?.id;
    const tokenId = signal.market?.outcomes?.[0]?.id;
    const slug = signal.market?.slug;

    // Show loading state
    container.innerHTML = '<div class="chart-placeholder"><span style="color: var(--text-muted);">ğŸ“Š Loading chart...</span></div>';

    // Create chart
    if (typeof LightweightCharts === 'undefined') {
        container.innerHTML = `
            <div class="chart-placeholder" style="flex-direction: column; gap: 8px;">
                <span style="color: var(--amber-watch);">âš ï¸ Chart library not loaded</span>
                ${slug ? `<a href="https://polymarket.com/event/${slug}" target="_blank" style="color: var(--cyan-info); font-size: 10px;">View on Polymarket â†’</a>` : ''}
            </div>
        `;
        return;
    }

    // Clear previous chart properly
    if (priceChart) {
        try {
            priceChart.remove();
        } catch (e) {}
        priceChart = null;
        priceSeries = null;
    }
    container.innerHTML = '';

    try {
        // Create chart instance
        priceChart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 180,
            layout: {
                background: { type: 'solid', color: '#0a0a0a' },
                textColor: '#888888',
            },
            grid: {
                vertLines: { color: '#1a1a1a' },
                horzLines: { color: '#1a1a1a' },
            },
            timeScale: {
                borderColor: '#222222',
                timeVisible: true,
                secondsVisible: false,
            },
            rightPriceScale: {
                borderColor: '#222222',
                scaleMargins: { top: 0.1, bottom: 0.1 },
            },
            crosshair: {
                vertLine: { color: '#00ff88', width: 1, style: 2 },
                horzLine: { color: '#00ff88', width: 1, style: 2 },
            },
        });

        // Add area series for price
        priceSeries = priceChart.addAreaSeries({
            topColor: 'rgba(0, 255, 136, 0.3)',
            bottomColor: 'rgba(0, 255, 136, 0.02)',
            lineColor: '#00ff88',
            lineWidth: 2,
            priceFormat: { type: 'percent' },
        });

        let dataLoaded = false;

        // Try to load real price history
        if (tokenId) {
            const res = await fetch(`/api/polymarket/prices/${tokenId}`, { credentials: 'include' }).then(r => r.json());

            if (res.points && res.points.length > 0) {
                const chartData = res.points.map(p => ({
                    time: Math.floor(p.timestamp / 1000),
                    value: p.price * 100, // Convert to percentage
                }));
                priceSeries.setData(chartData);
                addLog('info', `Chart: ${chartData.length} Datenpunkte geladen`);
                dataLoaded = true;
            }
        }

        // Fallback: Generate synthetic data based on current price
        if (!dataLoaded) {
            const currentPrice = signal.market?.outcomes?.[0]?.price || 0.5;
            const syntheticData = generateSyntheticPriceData(currentPrice);
            priceSeries.setData(syntheticData);

            // Add info overlay for synthetic data
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: absolute; bottom: 8px; left: 8px; font-size: 9px; color: var(--text-muted); z-index: 10;';
            overlay.innerHTML = slug
                ? `<a href="https://polymarket.com/event/${slug}" target="_blank" style="color: var(--cyan-dim);">ğŸ“ˆ View on Polymarket</a>`
                : 'ğŸ“Š Simulated data';
            container.style.position = 'relative';
            container.appendChild(overlay);
        }

        // Load and display signal markers
        if (marketId) {
            await loadSignalMarkers(marketId);
        }

        priceChart.timeScale().fitContent();

    } catch (err) {
        container.innerHTML = `
            <div class="chart-placeholder" style="flex-direction: column; gap: 8px;">
                <span style="color: var(--red-risk);">Chart Error: ${err.message}</span>
                ${slug ? `<a href="https://polymarket.com/event/${slug}" target="_blank" style="color: var(--cyan-info); font-size: 10px;">View on Polymarket â†’</a>` : ''}
            </div>
        `;
    }
}

function generateSyntheticPriceData(currentPrice) {
    const data = [];
    const now = Math.floor(Date.now() / 1000);
    const hoursBack = 168; // 7 days

    let price = currentPrice * 100; // Start at current price (as percentage)

    for (let i = hoursBack; i >= 0; i--) {
        const time = now - i * 3600;

        // Random walk toward current price
        const targetDiff = (currentPrice * 100) - price;
        const drift = targetDiff * 0.02; // Mean reversion
        const noise = (Math.random() - 0.5) * 3; // Random noise

        price = Math.max(1, Math.min(99, price + drift + noise));

        data.push({ time, value: price });
    }

    // Ensure last point is current price
    data[data.length - 1].value = currentPrice * 100;

    return data;
}

// Resize chart on window resize
window.addEventListener('resize', () => {
    if (priceChart) {
        const container = document.getElementById('chart-container');
        priceChart.resize(container.clientWidth, 180);
    }
    if (equityChart) {
        const container = document.getElementById('equity-chart-container');
        equityChart.resize(container.clientWidth, 150);
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        EQUITY CURVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let equityChart = null;
let equitySeries = null;

async function loadEquityCurve() {
    const container = document.getElementById('equity-chart-container');
    if (!container) return;

    try {
        const data = await fetch('/api/stats/equity', { credentials: 'include' }).then(r => r.json());

        // Wenn keine Trades, Platzhalter zeigen
        if (!data.equityCurve || data.equityCurve.length === 0) {
            container.innerHTML = '<span style="color: var(--text-muted); font-size: 11px;">Keine Trades - Chart erscheint nach erstem Trade</span>';
            return;
        }

        // Chart erstellen wenn noch nicht existiert
        if (!equityChart && typeof LightweightCharts !== 'undefined') {
            container.innerHTML = '';
            equityChart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 150,
                layout: {
                    background: { type: 'solid', color: '#080808' },
                    textColor: '#888888',
                },
                grid: {
                    vertLines: { color: '#1a1a1a' },
                    horzLines: { color: '#1a1a1a' },
                },
                timeScale: {
                    borderColor: '#222222',
                    timeVisible: true,
                },
                rightPriceScale: {
                    borderColor: '#222222',
                },
            });

            equitySeries = equityChart.addAreaSeries({
                topColor: 'rgba(0, 255, 136, 0.3)',
                bottomColor: 'rgba(0, 255, 136, 0.02)',
                lineColor: '#00ff88',
                lineWidth: 2,
            });
        }

        if (equitySeries && data.equityCurve.length > 0) {
            // Konvertiere zu Chart-Format
            const chartData = data.equityCurve.map((p, i) => ({
                time: Math.floor(Date.now() / 1000) - (data.equityCurve.length - i) * 3600,
                value: p.cumulative,
            }));
            equitySeries.setData(chartData);
            equityChart.timeScale().fitContent();
        }
    } catch (err) {
        console.error('Equity Curve Fehler:', err);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        AUDIT LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadAuditLog() {
    const container = document.getElementById('audit-log-container');
    if (!container) return;

    try {
        const data = await fetch('/api/audit?limit=20', { credentials: 'include' }).then(r => r.json());

        if (!data.entries || data.entries.length === 0) {
            container.innerHTML = '<div style="color: var(--text-muted); padding: 8px;">Keine Audit-Eintraege vorhanden</div>';
            return;
        }

        const html = data.entries.map(entry => {
            const typeColors = {
                trade: 'var(--cyan-info)',
                mode_change: 'var(--amber-watch)',
                kill_switch: 'var(--red-risk)',
                settings: 'var(--text-secondary)',
                daily_reset: 'var(--green-dim)',
            };
            const color = typeColors[entry.eventType] || 'var(--text-muted)';

            return `
                <div style="padding: 4px 8px; border-bottom: 1px solid var(--border-dim);">
                    <span style="color: ${color}; font-weight: 500;">[${entry.eventType.toUpperCase()}]</span>
                    <span style="color: var(--text-secondary);">${entry.action}</span>
                    ${entry.pnlImpact ? `<span style="color: ${entry.pnlImpact >= 0 ? 'var(--green-profit)' : 'var(--red-risk)'}; margin-left: 8px;">${entry.pnlImpact >= 0 ? '+' : ''}$${entry.pnlImpact.toFixed(2)}</span>` : ''}
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    } catch (err) {
        container.innerHTML = '<div style="color: var(--red-risk); padding: 8px;">Fehler beim Laden</div>';
    }
}

// Lade Equity Curve und Audit Log beim Start und alle 30 Sekunden
loadEquityCurve();
loadAuditLog();
setInterval(() => {
    loadEquityCurve();
    loadAuditLog();
}, 30000);
    </script>
</body>
</html>
