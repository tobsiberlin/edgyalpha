<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0a">
    <title>EDGY ALPHA CONSOLE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDGY ALPHA CONSOLE - TRADING DESK INTERFACE
   Bloomberg/Palantir-inspired dark terminal aesthetic
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
    /* BACKGROUNDS */
    --bg-terminal:    #0a0a0a;
    --bg-panel:       #0d0d0d;
    --bg-elevated:    #111111;
    --bg-input:       #080808;

    /* BORDERS */
    --border-dim:     #1a1a1a;
    --border-mid:     #222222;
    --border-bright:  #2a2a2a;

    /* ACCENT COLORS */
    --green-profit:   #00ff88;
    --green-dim:      #00aa66;
    --green-dark:     #004422;
    --amber-watch:    #ffaa00;
    --amber-dim:      #996600;
    --red-risk:       #ff3344;
    --red-dim:        #aa2233;
    --cyan-info:      #00ccff;
    --cyan-dim:       #0088aa;

    /* TEXT */
    --text-primary:   #e0e0e0;
    --text-secondary: #888888;
    --text-muted:     #555555;
    --text-dim:       #333333;

    /* TYPOGRAPHY */
    --font-mono:      'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    --fs-xs:          9px;
    --fs-sm:          11px;
    --fs-md:          13px;
    --fs-lg:          18px;
    --fs-xl:          24px;
    --fs-xxl:         32px;

    /* SPACING */
    --sp-xs:          4px;
    --sp-sm:          8px;
    --sp-md:          16px;
    --sp-lg:          24px;
    --sp-xl:          32px;
}

/* BRIGHT MODE */
[data-theme="light"] {
    --bg-terminal:    #f5f5f5;
    --bg-panel:       #ffffff;
    --bg-elevated:    #fafafa;
    --bg-input:       #f0f0f0;

    --border-dim:     #e0e0e0;
    --border-mid:     #d0d0d0;
    --border-bright:  #c0c0c0;

    --green-profit:   #00aa44;
    --green-dim:      #008833;
    --green-dark:     #e8f5e9;
    --amber-watch:    #ff8800;
    --amber-dim:      #cc6600;
    --red-risk:       #dd2233;
    --red-dim:        #aa1122;
    --cyan-info:      #0088cc;
    --cyan-dim:       #006699;

    --text-primary:   #1a1a1a;
    --text-secondary: #555555;
    --text-muted:     #888888;
    --text-dim:       #aaaaaa;
}

.logout-btn:hover {
    border-color: var(--red-risk) !important;
    color: var(--red-risk) !important;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    height: 100%;
    overflow: hidden;
}

body {
    font-family: var(--font-mono);
    font-size: var(--fs-sm);
    background: var(--bg-terminal);
    color: var(--text-primary);
    line-height: 1.4;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT - THREE COLUMN TRADING DESK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.console-app {
    display: grid;
    grid-template-columns: 180px 1fr;
    grid-template-rows: 36px 1fr 28px;
    height: 100vh;
    gap: 1px;
    background: var(--border-dim);
}

/* Mit Drilldown-Panel (3 Spalten) */
.console-app.show-drilldown {
    grid-template-columns: 180px 1fr 320px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.header-bar {
    grid-column: 1 / -1;
    background: var(--bg-panel);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--sp-md);
    border-bottom: 1px solid var(--border-mid);
}

.header-brand {
    display: flex;
    align-items: center;
    gap: var(--sp-md);
}

.brand-logo {
    font-size: var(--fs-md);
    font-weight: 700;
    color: var(--green-profit);
    letter-spacing: 2px;
    text-shadow: 0 0 10px var(--green-dark);
}

.brand-logo::before {
    content: 'â–Œ';
    margin-right: 4px;
    animation: cursor-blink 0.7s step-end infinite;
}

@keyframes cursor-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}

.header-status {
    display: flex;
    align-items: center;
    gap: var(--sp-lg);
}

.status-badge {
    display: flex;
    align-items: center;
    gap: var(--sp-xs);
    padding: 4px 10px;
    background: var(--bg-elevated);
    border: 1px solid var(--border-mid);
    font-size: var(--fs-xs);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s;
}

.status-badge:hover {
    border-color: var(--green-dim);
    color: var(--green-profit);
}

.status-badge.mode-paper { border-color: var(--cyan-dim); color: var(--cyan-info); }
.status-badge.mode-shadow { border-color: var(--amber-dim); color: var(--amber-watch); }
.status-badge.mode-live {
    border-color: var(--green-dim);
    color: var(--green-profit);
    background: var(--green-dark);
}

.status-badge.killswitch-active {
    border-color: var(--red-dim);
    background: rgba(255,51,68,0.15);
    color: var(--red-risk);
    animation: killswitch-pulse 1s infinite;
}

@keyframes killswitch-pulse {
    0%, 100% { box-shadow: 0 0 5px transparent; }
    50% { box-shadow: 0 0 10px var(--red-dim); }
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green-profit);
    box-shadow: 0 0 6px var(--green-profit);
}

.status-dot.warning { background: var(--amber-watch); box-shadow: 0 0 6px var(--amber-watch); }
.status-dot.error { background: var(--red-risk); box-shadow: 0 0 6px var(--red-risk); }
.status-dot.offline { background: var(--text-muted); box-shadow: none; }

.header-metrics {
    display: flex;
    align-items: center;
    gap: var(--sp-lg);
    font-size: var(--fs-sm);
}

.metric {
    display: flex;
    align-items: center;
    gap: var(--sp-xs);
}

.metric-label {
    color: var(--text-muted);
    font-size: var(--fs-xs);
}

.metric-value {
    color: var(--text-primary);
    font-weight: 600;
}

.metric-value.positive { color: var(--green-profit); }
.metric-value.negative { color: var(--red-risk); }
.metric-value.warning { color: var(--amber-watch); }

.clock {
    font-size: var(--fs-sm);
    color: var(--text-secondary);
    font-variant-numeric: tabular-nums;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEFT SIDEBAR - NAVIGATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.sidebar-nav {
    background: var(--bg-panel);
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-dim);
    overflow-y: auto;
}

.nav-section {
    padding: var(--sp-sm) 0;
    border-bottom: 1px solid var(--border-dim);
}

.nav-section:last-child {
    border-bottom: none;
}

.nav-header {
    padding: var(--sp-xs) var(--sp-md);
    font-size: var(--fs-xs);
    color: var(--text-muted);
    letter-spacing: 1px;
    text-transform: uppercase;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: var(--sp-sm);
    padding: var(--sp-sm) var(--sp-md);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.1s;
    border-left: 2px solid transparent;
}

.nav-item:hover {
    background: var(--bg-elevated);
    color: var(--text-primary);
}

.nav-item.active {
    background: var(--bg-elevated);
    color: var(--green-profit);
    border-left-color: var(--green-profit);
}

.nav-item .nav-icon {
    width: 16px;
    text-align: center;
    font-size: var(--fs-sm);
}

.nav-item .nav-count {
    margin-left: auto;
    padding: 1px 6px;
    background: var(--bg-terminal);
    border-radius: 2px;
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

.nav-item.active .nav-count {
    background: var(--green-dark);
    color: var(--green-profit);
}

/* Pipeline Status */
.pipeline-status {
    padding: var(--sp-sm) var(--sp-md);
}

.pipeline-item {
    display: flex;
    align-items: center;
    gap: var(--sp-sm);
    padding: var(--sp-xs) 0;
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

.pipeline-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--green-profit);
}

.pipeline-dot.stale { background: var(--amber-watch); }
.pipeline-dot.error { background: var(--red-risk); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN VIEWPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.main-viewport {
    background: var(--bg-terminal);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Viewport Header */
.viewport-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--sp-sm) var(--sp-md);
    background: var(--bg-panel);
    border-bottom: 1px solid var(--border-dim);
}

.viewport-title {
    display: flex;
    align-items: center;
    gap: var(--sp-sm);
    font-size: var(--fs-sm);
    color: var(--text-primary);
    letter-spacing: 1px;
}

.viewport-title::before {
    content: '>';
    color: var(--green-dim);
}

.viewport-actions {
    display: flex;
    gap: var(--sp-sm);
}

/* Content Panels */
.viewport-content {
    flex: 1;
    overflow: hidden;
    display: none;
    flex-direction: column;
}

.viewport-content.active {
    display: flex;
}

/* Panel Styling */
.panel {
    background: var(--bg-panel);
    border: 1px solid var(--border-dim);
    margin: var(--sp-sm);
}

.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--sp-sm) var(--sp-md);
    border-bottom: 1px solid var(--border-dim);
    font-size: var(--fs-xs);
    color: var(--text-secondary);
    letter-spacing: 1px;
}

.panel-header::before {
    content: 'â”€â”€â”€ ';
    color: var(--border-bright);
}

.panel-header::after {
    content: ' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
    color: var(--border-bright);
    flex: 1;
    overflow: hidden;
    margin-left: var(--sp-sm);
}

.panel-body {
    padding: var(--sp-md);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGNAL LIST
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.signal-list {
    flex: 1;
    overflow-y: auto;
    padding: var(--sp-sm);
}

.signal-item {
    display: grid;
    grid-template-columns: 60px 1fr 80px 80px 60px;
    align-items: center;
    gap: var(--sp-md);
    padding: var(--sp-sm) var(--sp-md);
    background: var(--bg-panel);
    border: 1px solid var(--border-dim);
    margin-bottom: var(--sp-xs);
    cursor: pointer;
    transition: all 0.1s;
}

.signal-item:hover {
    border-color: var(--border-bright);
    background: var(--bg-elevated);
}

.signal-item.selected {
    border-color: var(--green-dim);
    border-left-width: 3px;
}

.signal-item.high-alpha {
    border-left: 3px solid var(--green-profit);
}

.signal-score {
    font-size: var(--fs-lg);
    font-weight: 700;
    color: var(--green-profit);
}

.signal-score.medium { color: var(--amber-watch); }
.signal-score.low { color: var(--text-muted); }

.signal-info {
    overflow: hidden;
}

.signal-question {
    font-size: var(--fs-sm);
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.signal-meta {
    display: flex;
    gap: var(--sp-sm);
    margin-top: 2px;
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

.signal-tag {
    padding: 1px 4px;
    background: var(--bg-terminal);
    color: var(--text-secondary);
}

.signal-tag.german { color: var(--amber-watch); }
.signal-tag.politics { color: var(--cyan-info); }

.signal-direction {
    font-size: var(--fs-md);
    font-weight: 600;
}

.signal-direction.yes { color: var(--green-profit); }
.signal-direction.no { color: var(--red-risk); }

.signal-edge {
    font-size: var(--fs-sm);
    font-weight: 500;
    color: var(--green-profit);
}

.signal-size {
    font-size: var(--fs-sm);
    color: var(--text-secondary);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSOLE LOG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.console-log {
    flex: 1;
    overflow-y: auto;
    padding: var(--sp-sm);
    background: var(--bg-terminal);
    font-size: var(--fs-xs);
}

.console-log::-webkit-scrollbar {
    width: 6px;
}

.console-log::-webkit-scrollbar-track {
    background: var(--bg-terminal);
}

.console-log::-webkit-scrollbar-thumb {
    background: var(--border-mid);
}

.log-entry {
    display: flex;
    gap: var(--sp-sm);
    padding: 2px 0;
    border-bottom: 1px solid var(--border-dim);
}

.log-time {
    color: var(--text-muted);
    flex-shrink: 0;
    width: 70px;
}

.log-level {
    width: 50px;
    flex-shrink: 0;
    font-weight: 500;
}

.log-level.info { color: var(--cyan-info); }
.log-level.success { color: var(--green-profit); }
.log-level.warn { color: var(--amber-watch); }
.log-level.error { color: var(--red-risk); }
.log-level.system { color: var(--text-muted); }

.log-message {
    color: var(--text-secondary);
    word-break: break-word;
}

.console-input {
    display: flex;
    align-items: center;
    padding: var(--sp-sm) var(--sp-md);
    background: var(--bg-panel);
    border-top: 1px solid var(--border-dim);
}

.console-prompt {
    color: var(--green-profit);
    margin-right: var(--sp-sm);
}

.console-cursor {
    display: inline-block;
    width: 8px;
    height: 14px;
    background: var(--green-profit);
    animation: cursor-blink 0.7s step-end infinite;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RIGHT SIDEBAR - DRILLDOWN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.drilldown-panel {
    background: var(--bg-panel);
    display: none;
    flex-direction: column;
    border-left: 1px solid var(--border-dim);
    overflow-y: auto;
}

/* Drilldown nur auf Signals-Seite anzeigen */
.console-app.show-drilldown .drilldown-panel {
    display: flex;
}

/* Close Button fÃ¼r Drilldown */
.drilldown-close {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: var(--bg-terminal);
    border: 1px solid var(--border-mid);
    color: var(--text-muted);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.drilldown-close:hover {
    border-color: var(--red-dim);
    color: var(--red-risk);
}

.drilldown-header {
    padding: var(--sp-md);
    border-bottom: 1px solid var(--border-dim);
    position: relative;
}

.drilldown-title {
    font-size: var(--fs-sm);
    color: var(--green-profit);
    letter-spacing: 1px;
    margin-bottom: var(--sp-xs);
}

.drilldown-subtitle {
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

/* Chart Container */
.chart-container {
    height: 200px;
    padding: var(--sp-md);
    background: var(--bg-terminal);
    border-bottom: 1px solid var(--border-dim);
    position: relative;
}

.chart-placeholder {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    font-size: var(--fs-xs);
    border: 1px dashed var(--border-mid);
}

.chart-overlay {
    position: absolute;
    top: var(--sp-sm);
    right: var(--sp-sm);
    display: flex;
    gap: var(--sp-xs);
}

.chart-marker {
    padding: 2px 6px;
    font-size: var(--fs-xs);
    background: var(--bg-panel);
    border: 1px solid var(--border-mid);
}

.chart-marker.signal { border-color: var(--green-dim); color: var(--green-profit); }
.chart-marker.entry { border-color: var(--cyan-dim); color: var(--cyan-info); }

/* Drilldown Sections */
.drilldown-section {
    padding: var(--sp-md);
    border-bottom: 1px solid var(--border-dim);
}

.drilldown-section:last-child {
    border-bottom: none;
}

.section-label {
    font-size: var(--fs-xs);
    color: var(--text-muted);
    letter-spacing: 1px;
    margin-bottom: var(--sp-sm);
}

.section-label::before {
    content: 'â”€â”€ ';
    color: var(--border-bright);
}

/* Data Rows */
.data-row {
    display: flex;
    justify-content: space-between;
    padding: var(--sp-xs) 0;
    font-size: var(--fs-sm);
}

.data-label {
    color: var(--text-muted);
}

.data-value {
    color: var(--text-primary);
    font-weight: 500;
}

.data-value.positive { color: var(--green-profit); }
.data-value.negative { color: var(--red-risk); }
.data-value.warning { color: var(--amber-watch); }

/* Feature List */
.feature-list {
    font-size: var(--fs-xs);
}

.feature-item {
    display: flex;
    align-items: center;
    gap: var(--sp-sm);
    padding: var(--sp-xs) 0;
    color: var(--text-secondary);
}

.feature-bar {
    flex: 1;
    height: 4px;
    background: var(--bg-terminal);
    position: relative;
}

.feature-fill {
    height: 100%;
    background: var(--green-dim);
}

.feature-value {
    width: 40px;
    text-align: right;
    font-variant-numeric: tabular-nums;
}

/* Risk Gates */
.gate-list {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--sp-xs);
}

.gate-item {
    display: flex;
    align-items: center;
    gap: var(--sp-xs);
    padding: var(--sp-xs);
    background: var(--bg-terminal);
    font-size: var(--fs-xs);
}

.gate-icon {
    width: 14px;
    text-align: center;
}

.gate-icon.pass { color: var(--green-profit); }
.gate-icon.fail { color: var(--red-risk); }

/* Reasoning Section */
.reasoning-summary {
    font-size: var(--fs-sm);
    color: var(--text-primary);
    padding: var(--sp-sm);
    background: var(--bg-terminal);
    border-left: 2px solid var(--green-dim);
    margin-bottom: var(--sp-sm);
    line-height: 1.5;
}

.reasoning-factors {
    display: flex;
    flex-direction: column;
    gap: var(--sp-xs);
}

.reasoning-factor {
    display: flex;
    flex-direction: column;
    padding: var(--sp-xs) var(--sp-sm);
    background: var(--bg-terminal);
    font-size: var(--fs-xs);
}

.factor-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2px;
}

.factor-name {
    color: var(--cyan-info);
    font-weight: 500;
}

.factor-value {
    color: var(--green-profit);
    font-variant-numeric: tabular-nums;
}

.factor-explanation {
    color: var(--text-secondary);
    font-size: var(--fs-xs);
}

.news-match {
    margin-top: var(--sp-sm);
    padding: var(--sp-sm);
    background: var(--bg-terminal);
    border: 1px solid var(--border-dim);
}

.news-match-title {
    font-size: var(--fs-xs);
    color: var(--text-primary);
    margin-bottom: var(--sp-xs);
}

.news-match-source {
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

/* Action Buttons */
.drilldown-actions {
    padding: var(--sp-md);
    display: flex;
    gap: var(--sp-sm);
    margin-top: auto;
}

.btn {
    flex: 1;
    padding: var(--sp-sm) var(--sp-md);
    border: 1px solid var(--border-mid);
    background: var(--bg-terminal);
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.15s;
}

.btn:hover {
    border-color: var(--green-dim);
    color: var(--green-profit);
}

.btn.primary {
    border-color: var(--green-dim);
    color: var(--green-profit);
}

.btn.primary:hover {
    background: var(--green-dark);
}

.btn.danger {
    border-color: var(--red-dim);
    color: var(--red-risk);
}

.btn.danger:hover {
    background: rgba(255,51,68,0.15);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.footer-bar {
    grid-column: 1 / -1;
    background: var(--bg-panel);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 var(--sp-md);
    border-top: 1px solid var(--border-dim);
    font-size: var(--fs-xs);
}

.footer-left {
    color: var(--text-muted);
}

.footer-center {
    display: flex;
    align-items: center;
    gap: var(--sp-md);
}

.footer-right {
    display: flex;
    align-items: center;
    gap: var(--sp-md);
}

.scan-btn {
    padding: var(--sp-xs) var(--sp-md);
    background: var(--green-dim);
    border: none;
    color: var(--bg-terminal);
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    font-weight: 600;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.15s;
}

.scan-btn:hover {
    background: var(--green-profit);
    box-shadow: 0 0 10px var(--green-dark);
}

.scan-btn:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
}

.scan-btn.scanning {
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RISK DASHBOARD VIEW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.risk-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--sp-md);
    padding: var(--sp-md);
}

.risk-card {
    background: var(--bg-panel);
    border: 1px solid var(--border-dim);
    padding: var(--sp-md);
}

.risk-card-header {
    font-size: var(--fs-xs);
    color: var(--text-muted);
    letter-spacing: 1px;
    margin-bottom: var(--sp-md);
    padding-bottom: var(--sp-sm);
    border-bottom: 1px solid var(--border-dim);
}

.risk-big-number {
    font-size: var(--fs-xxl);
    font-weight: 700;
    line-height: 1;
}

.risk-big-number.positive { color: var(--green-profit); }
.risk-big-number.negative { color: var(--red-risk); }
.risk-big-number.neutral { color: var(--text-primary); }

.risk-progress {
    margin-top: var(--sp-md);
}

.risk-progress-bar {
    height: 8px;
    background: var(--bg-terminal);
    border: 1px solid var(--border-dim);
    overflow: hidden;
}

.risk-progress-fill {
    height: 100%;
    background: var(--green-dim);
    transition: width 0.3s;
}

.risk-progress-fill.warning { background: var(--amber-watch); }
.risk-progress-fill.danger { background: var(--red-risk); }

.risk-progress-labels {
    display: flex;
    justify-content: space-between;
    margin-top: var(--sp-xs);
    font-size: var(--fs-xs);
    color: var(--text-muted);
}

/* Mode Selector */
.mode-selector {
    display: flex;
    gap: var(--sp-sm);
}

.mode-btn {
    flex: 1;
    padding: var(--sp-md);
    background: var(--bg-terminal);
    border: 1px solid var(--border-dim);
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: var(--fs-sm);
    cursor: pointer;
    transition: all 0.15s;
}

.mode-btn:hover {
    border-color: var(--border-bright);
}

.mode-btn.active {
    border-color: var(--green-dim);
    color: var(--green-profit);
    background: var(--green-dark);
}

.mode-btn.active.shadow {
    border-color: var(--amber-dim);
    color: var(--amber-watch);
    background: rgba(255,170,0,0.1);
}

.mode-btn.active.live {
    border-color: var(--green-profit);
    color: var(--bg-terminal);
    background: var(--green-profit);
}

/* Kill Switch */
.killswitch-big {
    padding: var(--sp-lg);
    background: var(--bg-terminal);
    border: 2px solid var(--green-dim);
    color: var(--green-profit);
    text-align: center;
    font-size: var(--fs-md);
    cursor: pointer;
    transition: all 0.15s;
}

.killswitch-big:hover {
    background: var(--green-dark);
}

.killswitch-big.active {
    border-color: var(--red-risk);
    background: rgba(255,51,68,0.2);
    color: var(--red-risk);
    animation: killswitch-pulse 1s infinite;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ASCII ELEMENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

.ascii-divider {
    color: var(--border-bright);
    font-size: var(--fs-xs);
    padding: var(--sp-xs) 0;
    user-select: none;
}

.ascii-box {
    border: 1px solid var(--border-mid);
    padding: var(--sp-md);
    position: relative;
}

.ascii-box::before {
    content: 'â”Œ';
    position: absolute;
    top: -1px;
    left: -1px;
    color: var(--border-bright);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

@media (max-width: 1200px) {
    .console-app {
        grid-template-columns: 60px 1fr 280px;
    }

    .nav-item span:not(.nav-icon):not(.nav-count) {
        display: none;
    }

    .nav-header {
        display: none;
    }
}

@media (max-width: 900px) {
    .console-app,
    .console-app.show-drilldown {
        grid-template-columns: 1fr;
        grid-template-rows: 36px 1fr auto 28px;
    }

    .drilldown-panel,
    .console-app.show-drilldown .drilldown-panel {
        display: none;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE STYLES (768px und kleiner)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

@media (max-width: 768px) {
    /* Sidebar als Slide-In MenÃ¼ */
    .sidebar-nav {
        position: fixed;
        left: -280px;
        top: max(36px, env(safe-area-inset-top, 36px));
        width: min(260px, 80vw);
        height: calc(100vh - max(36px, env(safe-area-inset-top, 36px)));
        z-index: 1002; /* ÃœBER Overlay (1001) */
        transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: var(--bg-panel);
        border-right: 1px solid var(--border-mid);
        box-shadow: 4px 0 20px rgba(0,0,0,0.5);
        display: flex !important;
        flex-direction: column;
        padding-bottom: env(safe-area-inset-bottom, 0);
    }

    .sidebar-nav.open {
        left: 0;
    }

    /* Overlay wenn MenÃ¼ offen */
    .mobile-overlay {
        display: none;
        position: fixed;
        top: max(36px, env(safe-area-inset-top, 36px));
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 1001; /* ÃœBER Sidebar (1000) */
        -webkit-backdrop-filter: blur(2px);
        backdrop-filter: blur(2px);
    }

    .mobile-overlay.active {
        display: block;
    }

    /* Hamburger Button - Touch-Target 44x44 */
    .mobile-menu-btn {
        display: flex !important;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        min-width: 44px;
        min-height: 44px;
        background: var(--bg-elevated);
        border: 1px solid var(--border-mid);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        color: var(--text-secondary);
        font-size: 18px;
        -webkit-tap-highlight-color: transparent;
    }

    .mobile-menu-btn:hover,
    .mobile-menu-btn.active {
        border-color: var(--green-dim);
        color: var(--green-profit);
    }

    /* Header kompakter */
    .header-bar {
        padding: 0 var(--sp-sm);
        gap: var(--sp-sm);
    }

    .header-brand {
        gap: var(--sp-sm);
    }

    .brand-logo {
        font-size: var(--fs-sm);
        letter-spacing: 1px;
    }

    /* Header Status auf Mobile vereinfachen */
    .header-status {
        gap: var(--sp-sm);
    }

    .header-status .metric {
        display: none;
    }

    /* Header Metrics vereinfachen */
    .header-metrics {
        gap: var(--sp-sm);
    }

    .header-metrics .status-badge span:last-child:not(#theme-icon):not(.status-dot) {
        display: none;
    }

    .clock {
        display: none;
    }

    /* Main Viewport volle Breite */
    .main-viewport {
        padding: 0;
    }

    /* Viewport Header kompakter */
    .viewport-header {
        padding: var(--sp-xs) var(--sp-sm);
        flex-wrap: wrap;
        gap: var(--sp-xs);
    }

    .viewport-title {
        font-size: var(--fs-xs);
        flex: 1;
        min-width: 0;
    }

    .viewport-actions {
        flex-wrap: wrap;
        gap: var(--sp-xs);
    }

    /* Signal Liste scrollbar */
    .signal-list {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        padding: var(--sp-xs);
    }

    /* Signal Items auf Mobile */
    .signal-item {
        grid-template-columns: 50px 1fr;
        grid-template-rows: auto auto;
        gap: var(--sp-xs) var(--sp-sm);
        padding: var(--sp-sm);
    }

    .signal-score {
        font-size: var(--fs-md);
        grid-row: 1 / 3;
    }

    .signal-info {
        grid-column: 2;
    }

    .signal-question {
        font-size: var(--fs-xs);
        white-space: normal;
        line-height: 1.3;
    }

    .signal-meta {
        flex-wrap: wrap;
        gap: var(--sp-xs);
    }

    .signal-price,
    .signal-edge,
    .signal-time {
        display: none;
    }

    /* Buttons grÃ¶ÃŸer fÃ¼r Touch - Apple HIG 44px minimum */
    .btn, .status-badge {
        min-height: 44px;
        min-width: 44px;
        padding: var(--sp-sm) var(--sp-md);
        -webkit-tap-highlight-color: transparent;
    }

    /* Input/Select Font 16px verhindert iOS Auto-Zoom */
    input, select, textarea {
        font-size: 16px !important;
        min-height: 44px;
    }

    /* Panel kompakter */
    .panel {
        margin: var(--sp-xs);
    }

    .panel-body {
        padding: var(--sp-sm);
    }

    /* Filter kompakter */
    .filter-bar {
        flex-wrap: wrap;
        gap: var(--sp-xs);
        padding: var(--sp-xs) var(--sp-sm);
    }

    .filter-group {
        flex-wrap: wrap;
    }

    /* Tabellen horizontal scrollbar */
    .data-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .data-table {
        min-width: 600px;
    }

    /* Stats Grid zu Stack */
    .stats-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: var(--sp-xs);
    }

    /* Chart kleiner */
    .chart-container {
        height: 180px;
    }

    /* Footer kompakter */
    .footer-bar {
        padding: 0 var(--sp-sm);
        font-size: var(--fs-xs);
    }

    .footer-stats {
        gap: var(--sp-sm);
    }

    .footer-stats > span:nth-child(n+4) {
        display: none;
    }

    /* Nav Items grÃ¶ÃŸer fÃ¼r Touch */
    .nav-item {
        padding: var(--sp-md);
        min-height: 44px;
    }

    /* Settings Form */
    .setting-row {
        flex-direction: column;
        align-items: stretch;
        gap: var(--sp-xs);
    }

    .setting-row label {
        width: 100%;
    }

    .setting-row input,
    .setting-row select {
        width: 100%;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IPHONE SPECIFIC STYLES (max-width: 480px)
   Optimiert fÃ¼r iPhone SE, iPhone 12/13/14/15 Mini und Standard
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

@media (max-width: 480px) {
    /* Safe Area fÃ¼r iPhone Notch */
    .header-bar {
        padding-top: env(safe-area-inset-top, 0);
        padding-left: max(var(--sp-xs), env(safe-area-inset-left, 0));
        padding-right: max(var(--sp-xs), env(safe-area-inset-right, 0));
    }

    .footer-bar {
        padding-bottom: env(safe-area-inset-bottom, 0);
    }

    /* Header ultra-kompakt */
    .header-bar {
        height: auto;
        min-height: 40px;
        flex-wrap: wrap;
        gap: var(--sp-xs);
    }

    .brand-logo {
        font-size: 11px;
        letter-spacing: 0.5px;
    }

    .brand-tag {
        display: none;
    }

    /* Alle Header Metrics minimieren */
    .header-metrics .status-badge:not(:first-child) {
        display: none;
    }

    .header-status .metric {
        display: none;
    }

    .header-status .status-badge:nth-child(n+2) {
        display: none;
    }

    /* Signal Items noch kompakter */
    .signal-item {
        grid-template-columns: 40px 1fr;
        padding: var(--sp-xs);
        gap: var(--sp-xs);
    }

    .signal-score {
        font-size: 14px;
        width: 40px;
        height: 40px;
    }

    .signal-question {
        font-size: 11px;
        -webkit-line-clamp: 2;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .signal-tags {
        gap: 2px;
    }

    .signal-tag {
        font-size: 9px;
        padding: 1px 4px;
    }

    /* Buttons fÃ¼r Daumen optimiert */
    .btn {
        min-height: 44px;
        min-width: 44px;
        font-size: 12px;
        padding: var(--sp-sm);
    }

    /* Panels volle Breite */
    .panel {
        margin: var(--sp-xs) 0;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }

    .panel-header {
        font-size: 10px;
        padding: var(--sp-xs) var(--sp-sm);
    }

    /* Data Rows kompakter */
    .data-row {
        padding: var(--sp-xs) var(--sp-sm);
        font-size: 11px;
    }

    /* Stats Grid single column */
    .stats-grid {
        grid-template-columns: 1fr !important;
    }

    /* Chart noch kleiner */
    .chart-container {
        height: 150px;
    }

    /* Viewport Header */
    .viewport-header {
        padding: var(--sp-xs);
    }

    .viewport-title {
        font-size: 11px;
    }

    /* Filter als Dropdown statt inline */
    .filter-bar {
        display: none;
    }

    /* Footer minimal */
    .footer-bar {
        font-size: 9px;
        height: 24px;
    }

    .footer-stats > span:nth-child(n+2) {
        display: none;
    }

    /* Tabellen vertikal statt horizontal */
    .data-table th,
    .data-table td {
        padding: var(--sp-xs);
        font-size: 10px;
    }

    /* Input Felder grÃ¶ÃŸer fÃ¼r Touch */
    input, select, textarea {
        font-size: 16px !important; /* Verhindert Zoom auf iOS */
        min-height: 44px;
    }

    /* Sidebar volle Breite */
    .sidebar-nav {
        width: 100vw;
        left: -100vw;
    }

    .sidebar-nav.open {
        left: 0;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IPHONE SE / MINI STYLES (max-width: 375px)
   Ultra-kompakt fÃ¼r kleinste iPhones
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

@media (max-width: 375px) {
    .brand-logo {
        font-size: 10px;
    }

    .signal-item {
        grid-template-columns: 36px 1fr;
    }

    .signal-score {
        font-size: 12px;
        width: 36px;
        height: 36px;
    }

    .signal-question {
        font-size: 10px;
    }

    .btn {
        font-size: 11px;
        padding: var(--sp-xs);
    }

    .panel-header {
        font-size: 9px;
    }

    .data-row {
        font-size: 10px;
    }

    /* Verstecke mehr Status-Elemente */
    .header-metrics {
        display: none;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLET STYLES (769px - 1024px)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

@media (max-width: 1024px) and (min-width: 769px) {
    .sidebar-nav {
        width: 180px;
    }

    .console-app {
        grid-template-columns: 180px 1fr;
    }

    .console-app.show-drilldown {
        grid-template-columns: 180px 1fr 280px;
    }

    .header-status .metric:nth-child(n+3) {
        display: none;
    }
}

/* Desktop: Hamburger verstecken */
@media (min-width: 769px) {
    .mobile-menu-btn {
        display: none !important;
    }

    .mobile-overlay {
        display: none !important;
    }
}
    </style>
</head>
<body>
    <!-- Mobile Overlay fÃ¼r MenÃ¼ -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="console-app">
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             HEADER BAR
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <header class="header-bar">
            <div class="header-brand">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="MenÃ¼ Ã¶ffnen">
                    <span id="menu-icon">â˜°</span>
                </button>
                <span class="brand-logo">EDGY ALPHA</span>
            </div>

            <div class="header-status">
                <div class="status-badge mode-paper" id="mode-badge" onclick="showView('risk')">
                    <span>ğŸ“</span>
                    <span id="mode-text">PAPER</span>
                </div>

                <div class="status-badge" id="killswitch-badge" onclick="toggleKillSwitch()">
                    <span class="status-dot" id="killswitch-dot"></span>
                    <span id="killswitch-text">AKTIV</span>
                </div>

                <div class="metric">
                    <span class="metric-label">PnL</span>
                    <span class="metric-value positive" id="header-pnl">+$0.00</span>
                </div>

                <div class="metric">
                    <span class="metric-label">TRADES</span>
                    <span class="metric-value" id="header-trades">0</span>
                </div>
            </div>

            <div class="header-metrics">
                <div class="status-badge" onclick="toggleTheme()" title="Theme wechseln">
                    <span id="theme-icon">ğŸŒ™</span>
                </div>
                <a href="/docs.html" class="status-badge" style="text-decoration: none;">
                    <span>ğŸ“–</span>
                    <span>DOCS</span>
                </a>
                <div class="status-badge">
                    <span class="status-dot" id="ws-status"></span>
                    <span>WS</span>
                </div>
                <span class="clock" id="clock">--:--:--</span>
                <a href="/logout" class="status-badge logout-btn" style="text-decoration: none;" title="Logout">
                    <span>â»</span>
                </a>
            </div>
        </header>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             LEFT SIDEBAR - NAVIGATION
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-header">TRADING</div>
                <div class="nav-item active" data-view="signals" onclick="showView('signals')">
                    <span class="nav-icon">â—‰</span>
                    <span>SIGNALS</span>
                    <span class="nav-count" id="signal-count">0</span>
                </div>
                <div class="nav-item" data-view="markets" onclick="showView('markets')">
                    <span class="nav-icon">â—ˆ</span>
                    <span>PIPELINES</span>
                </div>
                <div class="nav-item" data-view="risk" onclick="showView('risk')">
                    <span class="nav-icon">â—†</span>
                    <span>RISK</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-header">ANALYSIS</div>
                <div class="nav-item" data-view="performance" onclick="showView('performance')">
                    <span class="nav-icon">ğŸ“ˆ</span>
                    <span>PERFORMANCE</span>
                </div>
                <div class="nav-item" data-view="backtest" onclick="showView('backtest')">
                    <span class="nav-icon">â–¤</span>
                    <span>BACKTEST</span>
                </div>
                <div class="nav-item" data-view="history" onclick="showView('history')">
                    <span class="nav-icon">â–¥</span>
                    <span>HISTORY</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-header">SOURCES</div>
                <div class="nav-item" data-view="almanien" onclick="showView('almanien')">
                    <span class="nav-icon">ğŸ‡©ğŸ‡ª</span>
                    <span>ALMANIEN</span>
                </div>
                <div class="nav-item" data-view="ticker" onclick="showView('ticker')">
                    <span class="nav-icon">â—</span>
                    <span>LIVE TICKER</span>
                </div>
            </div>

            <div class="nav-section" style="margin-top: auto;">
                <div class="nav-header">PIPELINES</div>
                <div class="pipeline-status">
                    <div class="pipeline-item">
                        <span class="pipeline-dot" id="pipe-poly"></span>
                        <span>Polymarket</span>
                    </div>
                    <div class="pipeline-item">
                        <span class="pipeline-dot" id="pipe-rss"></span>
                        <span>RSS Feeds</span>
                    </div>
                    <div class="pipeline-item">
                        <span class="pipeline-dot" id="pipe-dawum"></span>
                        <span>Dawum</span>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-item" data-view="console" onclick="showView('console')">
                    <span class="nav-icon">â–¸</span>
                    <span>CONSOLE</span>
                </div>
                <div class="nav-item" data-view="settings" onclick="showView('settings')">
                    <span class="nav-icon">âš™</span>
                    <span>SETTINGS</span>
                </div>
            </div>
        </nav>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             MAIN VIEWPORT
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <main class="main-viewport">
            <!-- SIGNALS VIEW -->
            <div class="viewport-content active" id="view-signals">
                <div class="viewport-header">
                    <div class="viewport-title">ACTIVE SIGNALS</div>
                    <div class="viewport-actions">
                        <button class="btn" onclick="refreshSignals()">REFRESH</button>
                    </div>
                </div>
                <div class="signal-list" id="signal-list">
                    <div class="log-entry" style="justify-content: center; padding: 40px; color: var(--text-muted);">
                        <span>> Keine aktiven Signale. Starte Scan...</span>
                        <span class="console-cursor"></span>
                    </div>
                </div>
            </div>

            <!-- CONSOLE VIEW -->
            <div class="viewport-content" id="view-console">
                <div class="viewport-header">
                    <div class="viewport-title">SYSTEM CONSOLE</div>
                </div>
                <div class="console-log" id="console-log"></div>
                <div class="console-input">
                    <span class="console-prompt">></span>
                    <span class="console-cursor"></span>
                </div>
            </div>

            <!-- RISK VIEW -->
            <div class="viewport-content" id="view-risk">
                <div class="viewport-header">
                    <div class="viewport-title">RISK DASHBOARD</div>
                </div>
                <div class="risk-grid">
                    <div class="risk-card">
                        <div class="risk-card-header">EXECUTION MODE</div>
                        <div class="mode-selector">
                            <button class="mode-btn active" id="btn-paper" onclick="setMode('paper')">ğŸ“ PAPER</button>
                            <button class="mode-btn" id="btn-shadow" onclick="setMode('shadow')">ğŸ‘» SHADOW</button>
                            <button class="mode-btn" id="btn-live" onclick="setMode('live')">ğŸš€ LIVE</button>
                        </div>
                    </div>

                    <div class="risk-card">
                        <div class="risk-card-header">KILL-SWITCH</div>
                        <div class="killswitch-big" id="killswitch-big" onclick="toggleKillSwitch()">
                            ğŸŸ¢ TRADING AKTIV<br>
                            <span style="font-size: 10px; color: var(--text-muted);">Klicken zum Stoppen</span>
                        </div>
                    </div>

                    <div class="risk-card">
                        <div class="risk-card-header">DAILY PnL</div>
                        <div class="risk-big-number positive" id="risk-pnl">+$0.00</div>
                        <div class="risk-progress">
                            <div class="risk-progress-bar">
                                <div class="risk-progress-fill" id="loss-limit-bar" style="width: 100%"></div>
                            </div>
                            <div class="risk-progress-labels">
                                <span>Loss Limit</span>
                                <span id="loss-limit-text">$100 remaining</span>
                            </div>
                        </div>
                    </div>

                    <div class="risk-card">
                        <div class="risk-card-header">POSITIONS</div>
                        <div class="risk-big-number neutral" id="risk-positions">0<span style="font-size: 16px; color: var(--text-muted);">/10</span></div>
                        <div class="data-row" style="margin-top: 16px;">
                            <span class="data-label">Total Exposure</span>
                            <span class="data-value" id="risk-exposure">$0.00</span>
                        </div>
                    </div>

                    <div class="risk-card" style="grid-column: 1 / -1;">
                        <div class="risk-card-header">DAILY STATS</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700;" id="stat-trades">0</div>
                                <div style="font-size: 10px; color: var(--text-muted);">TRADES</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--green-profit);" id="stat-wins">0</div>
                                <div style="font-size: 10px; color: var(--text-muted);">WINS</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--red-risk);" id="stat-losses">0</div>
                                <div style="font-size: 10px; color: var(--text-muted);">LOSSES</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700;" id="stat-winrate">--</div>
                                <div style="font-size: 10px; color: var(--text-muted);">WIN RATE</div>
                            </div>
                        </div>
                    </div>

                    <div class="risk-card" style="grid-column: 1 / -1;">
                        <div class="risk-card-header">EQUITY CURVE</div>
                        <div id="equity-chart-container" style="height: 150px; background: var(--bg-input); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                            <span style="color: var(--text-muted); font-size: 11px;">Keine Trades - Chart erscheint nach erstem Trade</span>
                        </div>
                    </div>

                    <div class="risk-card" style="grid-column: 1 / -1;">
                        <div class="risk-card-header">AUDIT LOG (LETZTE AKTIONEN)</div>
                        <div id="audit-log-container" style="max-height: 150px; overflow-y: auto; font-size: 10px;">
                            <div style="color: var(--text-muted); padding: 8px;">Lade Audit-Log...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TICKER VIEW -->
            <div class="viewport-content" id="view-ticker">
                <div class="viewport-header">
                    <div class="viewport-title">LIVE NEWS TICKER</div>
                    <div class="viewport-actions">
                        <div class="metric">
                            <span class="metric-label">NEWS</span>
                            <span class="metric-value" id="ticker-news">0</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">MATCHES</span>
                            <span class="metric-value positive" id="ticker-matches">0</span>
                        </div>
                    </div>
                </div>
                <div class="console-log" id="ticker-log"></div>
            </div>

            <!-- ALMANIEN VIEW -->
            <div class="viewport-content" id="view-almanien">
                <div class="viewport-header">
                    <div class="viewport-title">ALMANIEN INTELLIGENCE</div>
                    <div class="viewport-actions">
                        <div class="metric">
                            <span class="metric-label">MATCHES</span>
                            <span class="metric-value positive" id="almanien-match-count">0</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">NEWS</span>
                            <span class="metric-value" id="almanien-news-count">0</span>
                        </div>
                        <button class="btn" onclick="loadAlmanienMatches()" style="font-size: 10px;">REFRESH</button>
                    </div>
                </div>
                <div style="padding: 16px; overflow-y: auto; height: calc(100% - 44px);">
                    <!-- Matches Panel (Hauptbereich) -->
                    <div class="panel" style="margin-bottom: 16px;">
                        <div class="panel-header">NEWS-MARKT MATCHES</div>
                        <div class="panel-body" id="almanien-matches" style="padding: 0;">
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <div style="font-size: 24px; margin-bottom: 12px;">Lade Matches...</div>
                                <div style="font-size: 10px;">Deutsche News werden mit Polymarket-Maerkten abgeglichen</div>
                            </div>
                        </div>
                    </div>

                    <!-- Umfragen Panel (klein) -->
                    <div class="panel">
                        <div class="panel-header">SONNTAGSFRAGE (DAWUM)</div>
                        <div class="panel-body" id="polls-data">
                            <span style="color: var(--text-muted);">Lade...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MARKETS VIEW -->
            <div class="viewport-content" id="view-markets">
                <div class="viewport-header">
                    <div class="viewport-title">PIPELINE HEALTH</div>
                    <div class="viewport-actions">
                        <div class="metric">
                            <span class="status-dot" id="pipeline-overall-status"></span>
                            <span class="metric-label" id="pipeline-overall-text">CHECKING</span>
                        </div>
                    </div>
                </div>
                <div style="padding: 16px; overflow-y: auto;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                        <!-- RSS Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-rss">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“¡ RSS FEEDS</span>
                                <span class="status-dot" id="pl-rss-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-rss-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Success</span><span class="data-value" id="pl-rss-last">--</span></div>
                                <div class="data-row"><span class="data-label">Error Count</span><span class="data-value" id="pl-rss-errors">--</span></div>
                            </div>
                        </div>

                        <!-- Dawum Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-dawum">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“Š DAWUM UMFRAGEN</span>
                                <span class="status-dot" id="pl-dawum-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-dawum-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Success</span><span class="data-value" id="pl-dawum-last">--</span></div>
                                <div class="data-row"><span class="data-label">Error Count</span><span class="data-value" id="pl-dawum-errors">--</span></div>
                            </div>
                        </div>

                        <!-- Polymarket Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-polymarket">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“ˆ POLYMARKET API</span>
                                <span class="status-dot" id="pl-polymarket-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-polymarket-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Success</span><span class="data-value" id="pl-polymarket-last">--</span></div>
                                <div class="data-row"><span class="data-label">Error Count</span><span class="data-value" id="pl-polymarket-errors">--</span></div>
                            </div>
                        </div>

                        <!-- Scanner Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-scanner">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ” SCANNER ENGINE</span>
                                <span class="status-dot" id="pl-scanner-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-scanner-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Scan</span><span class="data-value" id="pl-scanner-last">--</span></div>
                                <div class="data-row"><span class="data-label">Last Signal</span><span class="data-value" id="pl-scanner-signal">--</span></div>
                            </div>
                        </div>

                        <!-- Ticker Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-ticker">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ“° NEWS TICKER</span>
                                <span class="status-dot" id="pl-ticker-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-ticker-status">--</span></div>
                                <div class="data-row"><span class="data-label">Last Success</span><span class="data-value" id="pl-ticker-last">--</span></div>
                                <div class="data-row"><span class="data-label">Error Count</span><span class="data-value" id="pl-ticker-errors">--</span></div>
                            </div>
                        </div>

                        <!-- WebSocket Pipeline -->
                        <div class="panel pipeline-card" id="pipeline-websocket">
                            <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>ğŸ”Œ WEBSOCKET</span>
                                <span class="status-dot" id="pl-ws-dot"></span>
                            </div>
                            <div class="panel-body">
                                <div class="data-row"><span class="data-label">Status</span><span class="data-value" id="pl-ws-status">--</span></div>
                                <div class="data-row"><span class="data-label">Connected</span><span class="data-value" id="pl-ws-connected">--</span></div>
                                <div class="data-row"><span class="data-label">Reconnects</span><span class="data-value" id="pl-ws-reconnects">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Logs -->
                    <div class="panel" style="margin-top: 16px;">
                        <div class="panel-header">PIPELINE EVENTS</div>
                        <div class="panel-body console-log" id="pipeline-log" style="height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- BACKTEST VIEW -->
            <div class="viewport-content" id="view-backtest">
                <div class="viewport-header">
                    <div class="viewport-title">BACKTEST RUNNER</div>
                    <div class="viewport-actions">
                        <div class="metric" id="bt-data-status">
                            <span class="metric-label">DATA</span>
                            <span class="metric-value" id="bt-trade-count">--</span>
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 1px; background: var(--border-dim); height: calc(100% - 44px);">
                    <!-- Backtest Config Panel -->
                    <div style="background: var(--bg-panel); padding: 16px; overflow-y: auto;">
                        <div class="panel" style="margin-bottom: 16px;">
                            <div class="panel-header">KONFIGURATION</div>
                            <div class="panel-body">
                                <div style="margin-bottom: 12px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">ENGINE</label>
                                    <select id="bt-engine" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 11px;">
                                        <option value="timeDelay">âš¡ TIME_DELAY (News-Vorsprung)</option>
                                        <option value="meta">ğŸ“Š ALLE STRATEGIEN</option>
                                    </select>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                                    <div>
                                        <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">VON</label>
                                        <input type="date" id="bt-from" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 10px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">BIS</label>
                                        <input type="date" id="bt-to" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 10px;">
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">BANKROLL ($)</label>
                                    <input type="number" id="bt-bankroll" value="1000" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 11px;">
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="bt-slippage" checked style="accent-color: var(--green-profit);">
                                        Slippage-Modell aktivieren
                                    </label>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="bt-walkforward" checked style="accent-color: var(--cyan-info);">
                                        Walk-Forward (Out-of-Sample)
                                    </label>
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px; margin-left: 24px;">
                                        Meta-Combiner lernt wÃ¤hrend des Tests
                                    </div>
                                </div>
                                <button class="btn primary" style="width: 100%;" id="bt-run-btn" onclick="runBacktest()">
                                    â–¶ BACKTEST STARTEN
                                </button>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="panel" id="bt-progress-panel" style="display: none;">
                            <div class="panel-header">FORTSCHRITT</div>
                            <div class="panel-body">
                                <div style="margin-bottom: 8px;">
                                    <div style="height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden;">
                                        <div id="bt-progress-bar" style="height: 100%; background: var(--green-profit); width: 0%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                <div style="font-size: 10px; color: var(--text-secondary);" id="bt-progress-text">Initialisiere...</div>
                            </div>
                        </div>

                        <!-- Data Info -->
                        <div class="panel">
                            <div class="panel-header">HISTORISCHE DATEN</div>
                            <div class="panel-body" id="bt-data-info">
                                <span style="color: var(--text-muted);">Lade...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Backtest Results -->
                    <div style="background: var(--bg-panel); overflow-y: auto;">
                        <div id="bt-results" style="padding: 16px;">
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <div style="font-size: 32px; margin-bottom: 16px;">ğŸ“Š</div>
                                <div>Konfiguriere und starte einen Backtest</div>
                                <div style="font-size: 10px; margin-top: 8px;">Ergebnisse werden hier angezeigt</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PERFORMANCE DASHBOARD VIEW -->
            <div class="viewport-content" id="view-performance">
                <div class="viewport-header">
                    <div class="viewport-title">ROLLING PERFORMANCE DASHBOARD</div>
                    <div class="viewport-actions">
                        <select id="perf-window" onchange="loadPerformanceData()" style="background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 4px 8px; font-family: var(--font-mono); font-size: 10px;">
                            <option value="7">7 TAGE</option>
                            <option value="30" selected>30 TAGE</option>
                            <option value="90">90 TAGE</option>
                            <option value="all">ALL TIME</option>
                        </select>
                        <button class="btn" onclick="loadPerformanceData()" style="font-size: 10px;">â†» REFRESH</button>
                    </div>
                </div>
                <div style="padding: 16px; overflow-y: auto; height: calc(100% - 44px);">
                    <!-- KPI Cards -->
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-pnl" style="font-size: 24px; font-weight: 700;" class="positive">$0.00</div>
                            <div style="font-size: 10px; color: var(--text-muted);">TOTAL PnL</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-winrate" style="font-size: 24px; font-weight: 700;">0%</div>
                            <div style="font-size: 10px; color: var(--text-muted);">WIN RATE</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-trades" style="font-size: 24px; font-weight: 700;">0</div>
                            <div style="font-size: 10px; color: var(--text-muted);">TRADES</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-sharpe" style="font-size: 24px; font-weight: 700;">0.00</div>
                            <div style="font-size: 10px; color: var(--text-muted);">SHARPE</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-drawdown" style="font-size: 24px; font-weight: 700;" class="negative">0%</div>
                            <div style="font-size: 10px; color: var(--text-muted);">MAX DD</div>
                        </div>
                        <div class="panel" style="text-align: center; padding: 16px;">
                            <div id="perf-quality" style="font-size: 24px; font-weight: 700;">--</div>
                            <div style="font-size: 10px; color: var(--text-muted);">EXEC QUALITY</div>
                        </div>
                    </div>

                    <!-- Equity Curve -->
                    <div class="panel" style="margin-bottom: 16px;">
                        <div class="panel-header">EQUITY CURVE (ROLLING)</div>
                        <div class="panel-body" style="padding: 0;">
                            <div id="perf-equity-chart" style="height: 200px; width: 100%;"></div>
                        </div>
                    </div>

                    <!-- Zwei-Spalten Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <!-- Engine Performance V4.0 -->
                        <div class="panel">
                            <div class="panel-header">STRATEGY PERFORMANCE (V4.0)</div>
                            <div class="panel-body" id="perf-engines">
                                <div class="data-row">
                                    <span class="data-label">ğŸ’° ARBITRAGE</span>
                                    <span class="data-value" id="perf-arbitrage">-- trades, $--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">â±ï¸ LATE-ENTRY</span>
                                    <span class="data-value" id="perf-lateentry">-- trades, $--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">âš¡ TIME_DELAY</span>
                                    <span class="data-value" id="perf-timedelay">-- trades, $--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">ğŸ“ PAPER/LIVE</span>
                                    <span class="data-value" id="perf-mode">--</span>
                                </div>
                            </div>
                        </div>

                        <!-- Streaks -->
                        <div class="panel">
                            <div class="panel-header">STREAKS & STATS</div>
                            <div class="panel-body">
                                <div class="data-row">
                                    <span class="data-label">Current Streak</span>
                                    <span class="data-value" id="perf-streak">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Best Win Streak</span>
                                    <span class="data-value positive" id="perf-best-streak">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Worst Loss Streak</span>
                                    <span class="data-value negative" id="perf-worst-streak">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Avg Win</span>
                                    <span class="data-value positive" id="perf-avg-win">$--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Avg Loss</span>
                                    <span class="data-value negative" id="perf-avg-loss">$--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Profit Factor</span>
                                    <span class="data-value" id="perf-profit-factor">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Execution Quality -->
                    <div class="panel" style="margin-bottom: 16px;">
                        <div class="panel-header">EXECUTION QUALITY ANALYSIS</div>
                        <div class="panel-body">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                <div>
                                    <div class="data-row"><span class="data-label">Fill Rate</span><span class="data-value" id="perf-fill-rate">--%</span></div>
                                    <div class="data-row"><span class="data-label">Avg Slippage</span><span class="data-value" id="perf-avg-slippage">--%</span></div>
                                </div>
                                <div>
                                    <div class="data-row"><span class="data-label">Expected Slip</span><span class="data-value" id="perf-exp-slippage">--%</span></div>
                                    <div class="data-row"><span class="data-label">Slippage Cost</span><span class="data-value negative" id="perf-slip-cost">$--</span></div>
                                </div>
                                <div>
                                    <div class="data-row"><span class="data-label">Avg Latency</span><span class="data-value" id="perf-latency">--ms</span></div>
                                    <div class="data-row"><span class="data-label">P95 Latency</span><span class="data-value" id="perf-p95-latency">--ms</span></div>
                                </div>
                                <div>
                                    <div class="data-row"><span class="data-label">Price Improve</span><span class="data-value" id="perf-price-improve">--%</span></div>
                                    <div class="data-row"><span class="data-label">Model Accuracy</span><span class="data-value" id="perf-model-acc">--%</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="panel">
                        <div class="panel-header">SYSTEM RECOMMENDATIONS</div>
                        <div class="panel-body" id="perf-recommendations" style="font-size: 11px;">
                            <div style="color: var(--text-muted);">Lade Empfehlungen...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORY VIEW -->
            <div class="viewport-content" id="view-history">
                <div class="viewport-header">
                    <div class="viewport-title">TRADE HISTORY</div>
                    <div class="viewport-actions">
                        <button class="btn" onclick="exportHistoryCSV()">CSV EXPORT</button>
                        <button class="btn primary" onclick="refreshHistory()">AKTUALISIEREN</button>
                    </div>
                </div>
                <div style="padding: 16px; overflow-y: auto; height: calc(100% - 44px);">
                    <!-- Filters -->
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 120px;">
                            <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">STATUS</label>
                            <select id="history-filter-status" onchange="refreshHistory()" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 11px;">
                                <option value="">Alle</option>
                                <option value="pending">Offen</option>
                                <option value="won">Gewonnen</option>
                                <option value="lost">Verloren</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">STRATEGIE</label>
                            <select id="history-filter-strategy" onchange="refreshHistory()" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 11px;">
                                <option value="">Alle</option>
                                <option value="arbitrage">Arbitrage</option>
                                <option value="lateEntry">Late-Entry</option>
                                <option value="timeDelay">Time-Delay</option>
                                <option value="manual">Manual</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">MODE</label>
                            <select id="history-filter-mode" onchange="refreshHistory()" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 8px; font-family: var(--font-mono); font-size: 11px;">
                                <option value="">Alle</option>
                                <option value="paper">Paper</option>
                                <option value="live">Live</option>
                            </select>
                        </div>
                    </div>

                    <!-- Stats Summary -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div class="stat-card" style="background: var(--bg-terminal); padding: 12px; border: 1px solid var(--border-dim);">
                            <div style="font-size: 9px; color: var(--text-muted);">TOTAL TRADES</div>
                            <div id="history-total-trades" style="font-size: 20px; font-weight: bold; color: var(--text-primary);">--</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-terminal); padding: 12px; border: 1px solid var(--border-dim);">
                            <div style="font-size: 9px; color: var(--text-muted);">WIN RATE</div>
                            <div id="history-win-rate" style="font-size: 20px; font-weight: bold; color: var(--green-profit);">--</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-terminal); padding: 12px; border: 1px solid var(--border-dim);">
                            <div style="font-size: 9px; color: var(--text-muted);">TOTAL P/L</div>
                            <div id="history-total-pnl" style="font-size: 20px; font-weight: bold;">--</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-terminal); padding: 12px; border: 1px solid var(--border-dim);">
                            <div style="font-size: 9px; color: var(--text-muted);">VOLUME</div>
                            <div id="history-volume" style="font-size: 20px; font-weight: bold; color: var(--text-primary);">--</div>
                        </div>
                    </div>

                    <!-- Trade Table -->
                    <div class="panel" style="overflow: hidden;">
                        <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>TRADES</span>
                            <span id="history-count" style="font-size: 10px; color: var(--text-muted);">0 Trades</span>
                        </div>
                        <div class="panel-body" style="padding: 0; overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                <thead>
                                    <tr style="background: var(--bg-terminal); border-bottom: 1px solid var(--border-mid);">
                                        <th style="padding: 10px 8px; text-align: left; font-weight: 500; color: var(--text-muted);">DATUM</th>
                                        <th style="padding: 10px 8px; text-align: left; font-weight: 500; color: var(--text-muted);">MARKT</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 500; color: var(--text-muted);">DIR</th>
                                        <th style="padding: 10px 8px; text-align: right; font-weight: 500; color: var(--text-muted);">SIZE</th>
                                        <th style="padding: 10px 8px; text-align: right; font-weight: 500; color: var(--text-muted);">ENTRY</th>
                                        <th style="padding: 10px 8px; text-align: right; font-weight: 500; color: var(--text-muted);">EXIT</th>
                                        <th style="padding: 10px 8px; text-align: right; font-weight: 500; color: var(--text-muted);">P/L</th>
                                        <th style="padding: 10px 8px; text-align: center; font-weight: 500; color: var(--text-muted);">STATUS</th>
                                        <th style="padding: 10px 8px; text-align: left; font-weight: 500; color: var(--text-muted);">STRATEGIE</th>
                                    </tr>
                                </thead>
                                <tbody id="history-tbody">
                                    <tr>
                                        <td colspan="9" style="padding: 40px; text-align: center; color: var(--text-muted);">
                                            Lade Trade History...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="history-pagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;">
                        <!-- Pagination buttons werden dynamisch eingefuegt -->
                    </div>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div class="viewport-content" id="view-settings">
                <div class="viewport-header">
                    <div class="viewport-title">EINSTELLUNGEN</div>
                    <div class="viewport-actions">
                        <button class="btn" onclick="resetSettingsToDefaults()">DEFAULTS</button>
                        <button class="btn primary" onclick="saveAllSettings()">SPEICHERN</button>
                    </div>
                </div>
                <div style="padding: 16px; overflow-y: auto; height: calc(100% - 44px);">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">

                        <!-- TRADING SETTINGS -->
                        <div class="panel">
                            <div class="panel-header">TRADING</div>
                            <div class="panel-body">
                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">EXECUTION MODE</label>
                                    <select id="settings-execution-mode" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                        <option value="paper">PAPER - Nur Simulation</option>
                                        <option value="shadow">SHADOW - Log ohne Trade</option>
                                        <option value="live">LIVE - Echte Trades</option>
                                    </select>
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Paper = sicher testen, Shadow = reale Signale ohne Risiko, Live = echtes Geld</div>
                                </div>

                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">MAX DAILY LOSS ($)</label>
                                    <input type="number" id="settings-max-daily-loss" value="100" min="10" max="10000" step="10" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Stop-Loss fuer den Tag. Trading stoppt automatisch bei Erreichen.</div>
                                </div>

                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">MAX POSITIONS</label>
                                    <input type="number" id="settings-max-positions" value="10" min="1" max="50" step="1" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Maximale gleichzeitig offene Positionen.</div>
                                </div>

                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">MAX PRO MARKT ($)</label>
                                    <input type="number" id="settings-max-per-market" value="50" min="5" max="1000" step="5" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Maximales Exposure pro einzelnem Markt.</div>
                                </div>

                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">KELLY FRACTION (%)</label>
                                    <input type="number" id="settings-kelly-fraction" value="25" min="5" max="100" step="5" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Anteil des Kelly-Kriteriums. 25% = konservativ, 50% = aggressiv.</div>
                                </div>

                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">BANKROLL ($)</label>
                                    <input type="number" id="settings-bankroll" value="1000" min="100" max="100000" step="100" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Gesamtes Trading-Kapital fuer Positionsgroessen-Berechnung.</div>
                                </div>

                                <div>
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">MAX BET PRO TRADE ($)</label>
                                    <input type="number" id="settings-max-bet" value="10" min="1" max="500" step="1" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Absolutes Maximum pro einzelnem Trade.</div>
                                </div>
                            </div>
                        </div>

                        <!-- SIGNAL SETTINGS -->
                        <div class="panel">
                            <div class="panel-header">SIGNALE</div>
                            <div class="panel-body">
                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">MIN ALPHA THRESHOLD (%)</label>
                                    <input type="number" id="settings-min-alpha" value="15" min="1" max="50" step="1" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Minimales Alpha fuer Trade-Signale. Hoeherer Wert = weniger aber bessere Signale.</div>
                                </div>

                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">MIN EDGE (%)</label>
                                    <input type="number" id="settings-min-edge" value="5" min="1" max="30" step="1" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Minimale Preisdifferenz (Edge) zum Marktpreis.</div>
                                </div>

                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 10px; color: var(--text-muted); display: block; margin-bottom: 4px;">MIN VOLUMEN ($)</label>
                                    <input type="number" id="settings-min-volume" value="10000" min="1000" max="1000000" step="1000" style="width: 100%; background: var(--bg-input); border: 1px solid var(--border-mid); color: var(--text-primary); padding: 10px; font-family: var(--font-mono); font-size: 11px;">
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px;">Minimales Handelsvolumen des Marktes fuer Liquiditaet.</div>
                                </div>

                                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-terminal); border: 1px solid var(--border-dim);">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="settings-auto-trade" style="accent-color: var(--green-profit); width: 16px; height: 16px;">
                                        <span>Auto-Trade bei "breaking_confirmed"</span>
                                    </label>
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px; margin-left: 24px;">Automatisch traden wenn News als "breaking" bestaetigt wird. Vorsicht!</div>
                                </div>
                            </div>
                        </div>

                        <!-- NOTIFICATIONS SETTINGS -->
                        <div class="panel">
                            <div class="panel-header">BENACHRICHTIGUNGEN</div>
                            <div class="panel-body">
                                <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-terminal); border: 1px solid var(--border-dim);">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="settings-browser-notifications" style="accent-color: var(--green-profit); width: 16px; height: 16px;">
                                        <span>Browser-Benachrichtigungen</span>
                                    </label>
                                    <div style="font-size: 9px; color: var(--text-muted); margin-top: 4px; margin-left: 24px;">Desktop-Notifications bei wichtigen Events.</div>
                                </div>

                                <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 8px;">EVENTS AUSWAEHLEN:</div>

                                <div style="margin-bottom: 8px; padding: 8px; background: var(--bg-terminal);">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="settings-notify-signal" checked style="accent-color: var(--green-profit);">
                                        <span>Neues Signal gefunden</span>
                                    </label>
                                </div>

                                <div style="margin-bottom: 8px; padding: 8px; background: var(--bg-terminal);">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="settings-notify-trade" checked style="accent-color: var(--green-profit);">
                                        <span>Trade ausgefuehrt</span>
                                    </label>
                                </div>

                                <div style="margin-bottom: 8px; padding: 8px; background: var(--bg-terminal);">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="settings-notify-killswitch" checked style="accent-color: var(--red-risk);">
                                        <span>Kill-Switch aktiviert</span>
                                    </label>
                                </div>

                                <div style="margin-bottom: 8px; padding: 8px; background: var(--bg-terminal);">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="settings-notify-daily-reset" style="accent-color: var(--cyan-info);">
                                        <span>Taeglicher Reset</span>
                                    </label>
                                </div>

                                <div style="padding: 8px; background: var(--bg-terminal);">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-secondary); cursor: pointer;">
                                        <input type="checkbox" id="settings-notify-high-alpha" checked style="accent-color: var(--amber-watch);">
                                        <span>High-Alpha Signal (>70%)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- SYSTEM STATUS -->
                        <div class="panel">
                            <div class="panel-header">SYSTEM STATUS</div>
                            <div class="panel-body">
                                <div class="data-row">
                                    <span class="data-label">Telegram Bot</span>
                                    <span class="data-value" id="settings-telegram-status">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Wallet</span>
                                    <span class="data-value" id="settings-wallet-status">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Deutschland-Modus</span>
                                    <span class="data-value" id="settings-germany-status">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">Dawum API</span>
                                    <span class="data-value" id="settings-dawum-status">--</span>
                                </div>
                                <div class="data-row">
                                    <span class="data-label">RSS Feeds</span>
                                    <span class="data-value" id="settings-rss-status">--</span>
                                </div>

                                <div style="margin-top: 16px; padding: 12px; background: var(--bg-terminal); border: 1px solid var(--border-dim); font-size: 10px; color: var(--text-muted);">
                                    Einige Einstellungen (Telegram, Wallet, API-Keys) koennen nur ueber die .env Datei geaendert werden. Aenderungen erfordern einen Server-Neustart.
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Save Status -->
                    <div id="settings-save-status" style="margin-top: 16px; padding: 12px; background: var(--green-dark); border: 1px solid var(--green-dim); color: var(--green-profit); text-align: center; display: none;">
                        Einstellungen gespeichert!
                    </div>
                </div>
            </div>
        </main>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             RIGHT SIDEBAR - DRILLDOWN
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <aside class="drilldown-panel" id="drilldown-panel">
            <div class="drilldown-header">
                <button class="drilldown-close" onclick="closeDrilldown()" title="Schliessen">Ã—</button>
                <div class="drilldown-title" id="drilldown-title">SELECT SIGNAL</div>
                <div class="drilldown-subtitle" id="drilldown-subtitle">Waehle ein Signal fuer Details</div>
            </div>

            <div class="chart-container" id="chart-container">
                <div class="chart-placeholder">
                    <span>ğŸ“ˆ Chart loads when signal selected</span>
                </div>
            </div>

            <div class="drilldown-section">
                <div class="section-label">SIGNAL DATA</div>
                <div class="data-row">
                    <span class="data-label">Direction</span>
                    <span class="data-value" id="dd-direction">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Edge</span>
                    <span class="data-value positive" id="dd-edge">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Confidence</span>
                    <span class="data-value" id="dd-confidence">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Size (Kelly)</span>
                    <span class="data-value" id="dd-size">--</span>
                </div>
            </div>

            <div class="drilldown-section" id="dd-reasoning-section" style="display: none;">
                <div class="section-label">WARUM INTERESSANT?</div>
                <div class="reasoning-summary" id="dd-reasoning-summary">--</div>
                <div class="reasoning-factors" id="dd-reasoning-factors">
                    <!-- Faktoren werden dynamisch eingefuegt -->
                </div>
                <div class="news-match" id="dd-news-match" style="display: none;">
                    <div class="news-match-title" id="dd-news-title">--</div>
                    <div class="news-match-source" id="dd-news-source">--</div>
                </div>
            </div>

            <div class="drilldown-section">
                <div class="section-label">TOP FEATURES</div>
                <div class="feature-list" id="dd-features">
                    <div class="feature-item">
                        <span style="width: 80px;">--</span>
                        <div class="feature-bar"><div class="feature-fill" style="width: 0%"></div></div>
                        <span class="feature-value">--</span>
                    </div>
                </div>
            </div>

            <div class="drilldown-section">
                <div class="section-label">RISK GATES</div>
                <div class="gate-list" id="dd-gates">
                    <div class="gate-item">
                        <span class="gate-icon">--</span>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>

            <div class="drilldown-section">
                <div class="section-label">TRADE BETRAG</div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" id="trade-amount" value="10" min="1" max="100" step="1"
                           style="width: 80px; padding: 6px 8px; background: var(--bg-input, #1a1a2e); border: 1px solid var(--border-mid, #333); color: var(--text-primary, #fff); font-family: var(--font-mono, monospace); font-size: 12px; border-radius: 4px;">
                    <span style="color: var(--text-secondary, #888); font-size: 11px;">USDC</span>
                </div>
            </div>

            <div class="drilldown-actions">
                <button class="btn primary" id="btn-trade-yes" onclick="executeTrade('YES')" disabled>BUY YES</button>
                <button class="btn danger" id="btn-trade-no" onclick="executeTrade('NO')" disabled>BUY NO</button>
            </div>
        </aside>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             FOOTER BAR
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <footer class="footer-bar">
            <div class="footer-left">
                <span id="scan-status">BEREIT</span>
            </div>
            <div class="footer-center">
                <span style="color: var(--text-muted);">v2.1.0 | MIT ALMANIEN-VORSPRUNG</span>
            </div>
            <div class="footer-right">
                <button class="scan-btn" id="scan-btn" onclick="startScan()">â–¶ SCAN STARTEN</button>
            </div>
        </footer>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        EDGY ALPHA CONSOLE - CLIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let socket = null;
let signals = [];
let selectedSignal = null;
let riskDashboard = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        THEME TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme) {
    const icon = document.getElementById('theme-icon');
    if (icon) {
        icon.textContent = theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';
    }
}

function initTheme() {
    const saved = localStorage.getItem('theme') || 'dark';
    if (saved === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
    }
    updateThemeIcon(saved);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    initSocket();
    initClock();
    loadInitialData();
    bootSequence();
    // Initial Drilldown-Panel fuer Signals-Seite aktivieren
    document.querySelector('.console-app').classList.add('show-drilldown');
});

function bootSequence() {
    const msgs = [
        ['system', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
        ['system', '  EDGY ALPHA CONSOLE v2.1.0'],
        ['system', '  Trading Desk Interface | MIT ALMANIEN-VORSPRUNG'],
        ['system', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'],
        ['info', 'Initialisiere Systeme...'],
        ['success', 'WebSocket verbunden'],
        ['info', 'Lade Pipeline-Status...'],
        ['success', 'Polymarket API online'],
        ['success', 'RSS Feeds aktiv (40 Quellen)'],
        ['success', 'Dawum Umfragen geladen'],
        ['info', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'],
        ['info', 'System bereit. Warte auf Befehle...'],
    ];

    let i = 0;
    const interval = setInterval(() => {
        if (i < msgs.length) {
            addLog(msgs[i][0], msgs[i][1]);
            i++;
        } else {
            clearInterval(interval);
        }
    }, 200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Reconnect-State fÃ¼r Exponential Backoff
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 10;
const BASE_RECONNECT_DELAY = 1000; // 1 Sekunde

function initSocket() {
    socket = io({
        reconnection: true,
        reconnectionAttempts: MAX_RECONNECT_ATTEMPTS,
        reconnectionDelay: BASE_RECONNECT_DELAY,
        reconnectionDelayMax: 30000, // Max 30 Sekunden
    });

    socket.on('connect', () => {
        document.getElementById('ws-status').classList.remove('offline', 'error');
        reconnectAttempts = 0; // Reset bei erfolgreicher Verbindung
        addLog('success', 'WebSocket verbunden');
    });

    socket.on('disconnect', (reason) => {
        document.getElementById('ws-status').classList.add('error');
        addLog('error', 'WebSocket getrennt: ' + reason);
    });

    socket.on('reconnect_attempt', (attemptNumber) => {
        reconnectAttempts = attemptNumber;
        const delay = Math.min(BASE_RECONNECT_DELAY * Math.pow(2, attemptNumber - 1), 30000);
        addLog('info', `Reconnect Versuch ${attemptNumber}/${MAX_RECONNECT_ATTEMPTS} (${delay/1000}s)...`);
    });

    socket.on('reconnect', (attemptNumber) => {
        addLog('success', `WebSocket reconnected nach ${attemptNumber} Versuchen`);
        reconnectAttempts = 0;
        // Daten neu laden nach Reconnect
        loadInitialData();
    });

    socket.on('reconnect_failed', () => {
        addLog('error', 'WebSocket Reconnect fehlgeschlagen - Seite neu laden');
        document.getElementById('ws-status').title = 'Verbindung verloren - Seite neu laden';
    });

    socket.on('scan_started', () => {
        document.getElementById('scan-btn').disabled = true;
        document.getElementById('scan-btn').classList.add('scanning');
        document.getElementById('scan-btn').textContent = 'â—Œ SCANNT...';
        document.getElementById('scan-status').textContent = 'SCANNING';
        addLog('info', 'Scan gestartet...');
    });

    socket.on('scan_completed', (result) => {
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('scan-btn').classList.remove('scanning');
        document.getElementById('scan-btn').textContent = 'â–¶ SCAN STARTEN';
        document.getElementById('scan-status').textContent = 'BEREIT';
        handleScanResult(result);
    });

    socket.on('signal_found', (signal) => {
        addLog('success', `SIGNAL: ${signal.market?.question?.substring(0, 50)}...`);
    });

    socket.on('ticker', (event) => {
        handleTickerEvent(event);
    });

    socket.on('runtime_state_change', (event) => {
        addLog('info', `State: ${event.field} â†’ ${JSON.stringify(event.newValue)}`);
        loadRiskDashboard();
    });

    socket.on('kill_switch', (data) => {
        updateKillSwitchUI(data.active);
        addLog(data.active ? 'warn' : 'success',
            data.active ? 'KILL-SWITCH AKTIVIERT' : 'Kill-Switch deaktiviert');
    });

    socket.on('risk_update', (data) => {
        riskDashboard = data;
        updateRiskUI();
    });

    socket.on('trade_executed', (data) => {
        const modeEmoji = { paper: '[PAPER]', shadow: '[SHADOW]', live: '[LIVE]' };
        const prefix = modeEmoji[data.mode] || '';
        addLog('success', prefix + ' Trade: ' + data.direction + ' $' + data.amount + ' auf ' + (data.market || ''));
        if (data.orderId) {
            addLog('success', 'Order: ' + data.orderId.substring(0, 12) + '...');
        }
        // Risk Dashboard aktualisieren
        loadRiskDashboard();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadInitialData() {
    const opts = { credentials: 'include' };

    try {
        const [signalsData, riskData, polls, news] = await Promise.all([
            fetch('/api/signals', opts).then(r => r.ok ? r.json() : []).catch(() => []),
            fetch('/api/risk/dashboard', opts).then(r => r.ok ? r.json() : null).catch(() => null),
            fetch('/api/germany/polls', opts).then(r => r.ok ? r.json() : []).catch(() => []),
            fetch('/api/germany/news', opts).then(r => r.ok ? r.json() : []).catch(() => []),
        ]);

        if (signalsData.length) {
            signals = signalsData;
            renderSignals();
        }

        if (riskData) {
            riskDashboard = riskData;
            updateRiskUI();
            updateModeUI(riskData.mode);
            updateKillSwitchUI(riskData.killSwitch.active);
        }

        renderPolls(polls);
        renderNews(news);
    } catch (err) {
        addLog('error', 'Fehler beim Laden: ' + err.message);
    }
}

async function loadRiskDashboard() {
    try {
        const data = await fetch('/api/risk/dashboard', { credentials: 'include' }).then(r => r.json());
        riskDashboard = data;
        updateRiskUI();
        updateModeUI(data.mode);
        updateKillSwitchUI(data.killSwitch.active);
    } catch (err) {
        addLog('error', 'Risk Dashboard Fehler');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        UI UPDATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateRiskUI() {
    if (!riskDashboard) return;

    const d = riskDashboard;

    // Header
    const pnlEl = document.getElementById('header-pnl');
    pnlEl.textContent = (d.daily.pnl >= 0 ? '+' : '') + '$' + d.daily.pnl.toFixed(2);
    pnlEl.className = 'metric-value ' + (d.daily.pnl >= 0 ? 'positive' : 'negative');
    document.getElementById('header-trades').textContent = d.daily.trades;

    // Risk View
    const riskPnl = document.getElementById('risk-pnl');
    if (riskPnl) {
        riskPnl.textContent = (d.daily.pnl >= 0 ? '+' : '') + '$' + d.daily.pnl.toFixed(2);
        riskPnl.className = 'risk-big-number ' + (d.daily.pnl >= 0 ? 'positive' : 'negative');
    }

    const lossBar = document.getElementById('loss-limit-bar');
    const lossText = document.getElementById('loss-limit-text');
    if (lossBar && lossText) {
        const pct = Math.max(0, (d.limits.dailyLossRemaining / d.limits.dailyLossLimit) * 100);
        lossBar.style.width = pct + '%';
        lossBar.className = 'risk-progress-fill' + (pct < 30 ? ' danger' : pct < 60 ? ' warning' : '');
        lossText.textContent = '$' + d.limits.dailyLossRemaining.toFixed(0) + ' remaining';
    }

    const posEl = document.getElementById('risk-positions');
    if (posEl) posEl.innerHTML = d.positions.open + '<span style="font-size: 16px; color: var(--text-muted);">/' + d.positions.max + '</span>';

    const expEl = document.getElementById('risk-exposure');
    if (expEl) expEl.textContent = '$' + d.positions.totalExposure.toFixed(2);

    // Stats
    const statEls = {
        'stat-trades': d.daily.trades,
        'stat-wins': d.daily.wins,
        'stat-losses': d.daily.losses,
        'stat-winrate': d.daily.trades > 0 ? d.daily.winRate.toFixed(0) + '%' : '--',
    };
    for (const [id, val] of Object.entries(statEls)) {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    }
}

function updateModeUI(mode) {
    // Header badge
    const badge = document.getElementById('mode-badge');
    badge.className = 'status-badge mode-' + mode;
    document.getElementById('mode-text').textContent = mode.toUpperCase();

    // Mode buttons
    ['paper', 'shadow', 'live'].forEach(m => {
        const btn = document.getElementById('btn-' + m);
        if (btn) {
            btn.classList.toggle('active', m === mode);
            if (m === mode) btn.classList.add(m);
        }
    });
}

function updateKillSwitchUI(active) {
    const badge = document.getElementById('killswitch-badge');
    const dot = document.getElementById('killswitch-dot');
    const text = document.getElementById('killswitch-text');
    const big = document.getElementById('killswitch-big');

    badge.classList.toggle('killswitch-active', active);
    dot.classList.toggle('error', active);
    text.textContent = active ? 'STOP' : 'AKTIV';

    if (big) {
        big.classList.toggle('active', active);
        big.innerHTML = active
            ? 'ğŸ”´ TRADING GESTOPPT<br><span style="font-size: 10px; color: var(--text-muted);">Klicken zum Aktivieren</span>'
            : 'ğŸŸ¢ TRADING AKTIV<br><span style="font-size: 10px; color: var(--text-muted);">Klicken zum Stoppen</span>';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        VIEWS (Zentrales Hook-System)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Zentrales Registry fÃ¼r View-spezifische Handler
const viewHandlers = {
    signals: [],
    markets: [],
    risk: [],
    performance: [],
    backtest: [],
    history: [],
    almanien: [],
    ticker: [],
    console: [],
    settings: []
};

// Handler registrieren (statt showView zu Ã¼berschreiben)
function registerViewHandler(viewId, handler) {
    if (!viewHandlers[viewId]) {
        viewHandlers[viewId] = [];
    }
    viewHandlers[viewId].push(handler);
}

// Zentrale showView Funktion - EINMALIG definiert
function showView(viewId) {
    // Update nav
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewId);
    });

    // Update content
    document.querySelectorAll('.viewport-content').forEach(content => {
        content.classList.toggle('active', content.id === 'view-' + viewId);
    });

    // Drilldown-Panel nur auf der Signals-Seite anzeigen
    const consoleApp = document.querySelector('.console-app');
    if (viewId === 'signals') {
        consoleApp.classList.add('show-drilldown');
    } else {
        consoleApp.classList.remove('show-drilldown');
        // Reset Drilldown-Zustand beim Verlassen
        resetDrilldown();
    }

    // Mobile MenÃ¼ schlieÃŸen wenn View gewechselt wird
    if (window.innerWidth <= 768) {
        closeMobileMenu();
    }

    // Alle registrierten Handler fÃ¼r diese View ausfÃ¼hren
    const handlers = viewHandlers[viewId] || [];
    handlers.forEach(handler => {
        try {
            handler();
        } catch (e) {
            console.error('View handler error for', viewId, e);
        }
    });
}

// Global verfÃ¼gbar machen
window.showView = showView;

// Standard-Handler registrieren
registerViewHandler('almanien', () => loadAlmanienMatches());

// Drilldown schliessen und zuruecksetzen
function closeDrilldown() {
    const consoleApp = document.querySelector('.console-app');
    consoleApp.classList.remove('show-drilldown');
    resetDrilldown();
}

// Drilldown-Panel zuruecksetzen
function resetDrilldown() {
    selectedSignal = null;

    // Chart entfernen falls vorhanden
    if (typeof priceChart !== 'undefined' && priceChart) {
        try {
            priceChart.remove();
        } catch (e) {}
        priceChart = null;
    }

    // Chart-Container zuruecksetzen
    const chartContainer = document.getElementById('chart-container');
    if (chartContainer) {
        chartContainer.innerHTML = '<div class="chart-placeholder"><span>Waehle ein Signal fuer Chart</span></div>';
    }

    // Drilldown-Felder zuruecksetzen
    document.getElementById('drilldown-title').textContent = 'SELECT SIGNAL';
    document.getElementById('drilldown-subtitle').textContent = 'Waehle ein Signal fuer Details';
    document.getElementById('dd-direction').textContent = '--';
    document.getElementById('dd-direction').className = 'data-value';
    document.getElementById('dd-edge').textContent = '--';
    document.getElementById('dd-confidence').textContent = '--';
    document.getElementById('dd-size').textContent = '--';

    // Reasoning-Section zuruecksetzen
    document.getElementById('dd-reasoning-section').style.display = 'none';
    document.getElementById('dd-reasoning-summary').textContent = '--';
    document.getElementById('dd-reasoning-factors').innerHTML = '';
    document.getElementById('dd-news-match').style.display = 'none';

    // Trade-Buttons deaktivieren
    document.getElementById('btn-trade-yes').disabled = true;
    document.getElementById('btn-trade-no').disabled = true;

    // Signal-Selektion aufheben
    document.querySelectorAll('.signal-item').forEach(el => {
        el.classList.remove('selected');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        SIGNALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Keywords fÃ¼r Deutschland-relevante MÃ¤rkte (synchron mit Backend alpha.ts)
const GERMANY_MARKET_KEYWORDS = [
    // Deutsche Politik
    'germany', 'german', 'deutschland', 'bundestag', 'bundesregierung',
    'bundeskanzler', 'bundesminister', 'bundeswahl',
    // Deutsche Politiker
    'merz', 'scholz', 'habeck', 'lindner', 'weidel', 'wagenknecht',
    'sÃ¶der', 'laschet', 'baerbock', 'pistorius',
    // Deutsche Parteien
    'cdu', 'csu', 'spd', 'grÃ¼ne', 'fdp', 'afd', 'bsw', 'linke',
    // Deutsche Wirtschaft
    'volkswagen', 'mercedes', 'bmw', 'siemens', 'deutsche bank', 'dax',
    'basf', 'bayer', 'allianz', 'sap',
    // Deutsche StÃ¤dte/Regionen
    'berlin', 'munich', 'frankfurt', 'hamburg', 'bavaria', 'bayern',
    // Sport
    'bundesliga', 'dfb', 'german national team',
];

function isGermanyRelevantMarket(marketQuestion) {
    if (!marketQuestion) return false;
    const lower = marketQuestion.toLowerCase();
    return GERMANY_MARKET_KEYWORDS.some(kw => lower.includes(kw));
}

// XSS-Schutz: Escape HTML-Entities in User-Content
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function renderSignals() {
    const container = document.getElementById('signal-list');
    document.getElementById('signal-count').textContent = signals.length;

    if (!signals.length) {
        container.innerHTML = `
            <div class="log-entry" style="justify-content: center; padding: 40px; color: var(--text-muted);">
                <span>> Keine aktiven Signale. Starte Scan...</span>
                <span class="console-cursor"></span>
            </div>
        `;
        return;
    }

    container.innerHTML = signals.map((s, i) => {
        const scoreClass = s.score > 0.7 ? '' : s.score > 0.5 ? 'medium' : 'low';
        const isGerman = s.germanSource !== undefined;
        // XSS-Schutz: Escape market.question da es von externer Quelle kommt
        const safeQuestion = escapeHtml(s.market?.question || 'Unknown');
        const safeCategory = escapeHtml(s.market?.category || 'MARKET');
        const safeDirection = escapeHtml(s.direction || '--');

        return `
            <div class="signal-item ${s.score > 0.7 ? 'high-alpha' : ''}" onclick="selectSignal(${i})">
                <div class="signal-score ${scoreClass}">${(s.score * 100).toFixed(0)}%</div>
                <div class="signal-info">
                    <div class="signal-question">${safeQuestion}</div>
                    <div class="signal-meta">
                        ${isGerman ? '<span class="signal-tag german">DE</span>' : ''}
                        <span class="signal-tag">${safeCategory}</span>
                    </div>
                </div>
                <div class="signal-direction ${safeDirection.toLowerCase()}">${safeDirection}</div>
                <div class="signal-edge">+${(s.edge * 100).toFixed(1)}%</div>
                <div class="signal-size">$${s.kellyBet?.toFixed(0) || '--'}</div>
            </div>
        `;
    }).join('');
}

function selectSignal(index) {
    selectedSignal = signals[index];

    // Update selection UI
    document.querySelectorAll('.signal-item').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });

    // Update drilldown
    const s = selectedSignal;
    document.getElementById('drilldown-title').textContent = 'SIGNAL #' + s.id?.substring(0, 8);
    document.getElementById('drilldown-subtitle').textContent = s.market?.question?.substring(0, 50) + '...';

    document.getElementById('dd-direction').textContent = s.direction;
    document.getElementById('dd-direction').className = 'data-value ' + (s.direction === 'YES' ? 'positive' : 'negative');
    document.getElementById('dd-edge').textContent = '+' + (s.edge * 100).toFixed(1) + '%';
    document.getElementById('dd-confidence').textContent = (s.confidence * 100).toFixed(0) + '%';
    document.getElementById('dd-size').textContent = '$' + (s.kellyBet?.toFixed(2) || '--');

    // Reasoning anzeigen
    updateReasoningSection(s);

    // Enable trade buttons
    document.getElementById('btn-trade-yes').disabled = false;
    document.getElementById('btn-trade-no').disabled = false;

    // Load price chart
    loadPriceChart(s);
}

// Reasoning-Section im Drilldown aktualisieren
function updateReasoningSection(signal) {
    const section = document.getElementById('dd-reasoning-section');
    const summary = document.getElementById('dd-reasoning-summary');
    const factorsContainer = document.getElementById('dd-reasoning-factors');
    const newsMatch = document.getElementById('dd-news-match');
    const newsTitle = document.getElementById('dd-news-title');
    const newsSource = document.getElementById('dd-news-source');

    const reasoning = signal.structuredReasoning;

    if (!reasoning) {
        // Fallback auf altes reasoning-Feld
        if (signal.reasoning) {
            section.style.display = 'block';
            summary.textContent = signal.reasoning;
            factorsContainer.innerHTML = '';
            newsMatch.style.display = 'none';
        } else {
            section.style.display = 'none';
        }
        return;
    }

    // Strukturiertes Reasoning anzeigen
    section.style.display = 'block';
    summary.textContent = reasoning.summary || '--';

    // Faktoren rendern (mit XSS-Schutz)
    if (reasoning.factors && reasoning.factors.length > 0) {
        factorsContainer.innerHTML = reasoning.factors.map(f => {
            const pct = Math.round(f.value * 100);
            const safeName = escapeHtml(f.name);
            const safeExplanation = escapeHtml(f.explanation);
            return `
                <div class="reasoning-factor">
                    <div class="factor-header">
                        <span class="factor-name">${safeName}</span>
                        <span class="factor-value">${pct}%</span>
                    </div>
                    <div class="factor-explanation">${safeExplanation}</div>
                </div>
            `;
        }).join('');
    } else {
        factorsContainer.innerHTML = '';
    }

    // News Match anzeigen
    if (reasoning.newsMatch) {
        newsMatch.style.display = 'block';
        newsTitle.textContent = reasoning.newsMatch.title;
        newsSource.textContent = reasoning.newsMatch.source + ' (' + Math.round(reasoning.newsMatch.confidence * 100) + '% Match)';
    } else {
        newsMatch.style.display = 'none';
    }
}

async function refreshSignals() {
    try {
        const data = await fetch('/api/signals', { credentials: 'include' }).then(r => r.json());
        signals = data;
        renderSignals();
        addLog('info', signals.length + ' Signale geladen');
    } catch (err) {
        addLog('error', 'Signals Refresh fehlgeschlagen');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        SCANNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function startScan() {
    document.getElementById('scan-btn').disabled = true;
    document.getElementById('scan-btn').classList.add('scanning');
    document.getElementById('scan-btn').textContent = 'â—Œ SCANNT...';
    document.getElementById('scan-status').textContent = 'SCANNING';

    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    addLog('info', 'STARTE MARKT-SCAN');
    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    try {
        const result = await fetch('/api/scan', { method: 'POST', credentials: 'include' }).then(r => r.json());
        handleScanResult(result);
    } catch (err) {
        addLog('error', 'Scan fehlgeschlagen: ' + err.message);
    } finally {
        document.getElementById('scan-btn').disabled = false;
        document.getElementById('scan-btn').classList.remove('scanning');
        document.getElementById('scan-btn').textContent = 'â–¶ SCAN STARTEN';
        document.getElementById('scan-status').textContent = 'BEREIT';
    }
}

function handleScanResult(result) {
    const count = result.signalsFound?.length || 0;
    const highAlpha = result.signalsFound?.filter(s => s.score > 0.7).length || 0;

    addLog('info', result.marketsScanned + ' MÃ¤rkte gescannt');
    addLog('success', count + ' Signale gefunden (' + highAlpha + ' High Alpha)');
    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    if (count > 0) {
        signals = result.signalsFound;
        renderSignals();
        showView('signals');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        RISK CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function setMode(mode) {
    try {
        const res = await fetch('/api/execution/mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ mode })
        }).then(r => r.json());

        if (res.success) {
            updateModeUI(res.mode);
            addLog('success', 'Mode: ' + res.mode.toUpperCase());
        } else {
            addLog('error', res.error || 'Mode change failed');
        }
    } catch (err) {
        addLog('error', 'Mode Fehler: ' + err.message);
    }
}

async function toggleKillSwitch() {
    try {
        const res = await fetch('/api/risk/killswitch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ action: 'toggle' })
        }).then(r => r.json());

        if (res.success) {
            updateKillSwitchUI(res.killSwitchActive);
        }
    } catch (err) {
        addLog('error', 'Kill-Switch Fehler');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        TRADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function executeTrade(direction) {
    if (!selectedSignal) return;

    const amount = parseFloat(document.getElementById('trade-amount').value) || 10;

    // Bei Live Mode: Warnung anzeigen
    try {
        const modeRes = await fetch('/api/execution/mode', { credentials: 'include' }).then(r => r.json());
        if (modeRes.mode === 'live') {
            if (!confirm('LIVE MODE!\n\nEchter Trade: ' + direction + ' fÃ¼r $' + amount + '\n\nFortfahren?')) {
                addLog('info', 'Trade abgebrochen');
                return;
            }
        }
    } catch (e) {
        // Mode-Check fehlgeschlagen, trotzdem fortfahren
    }

    addLog('info', 'Trade ' + direction + ' $' + amount + ' fÃ¼r ' + selectedSignal.id?.substring(0, 8) + '...');

    // Buttons deaktivieren wÃ¤hrend Trade
    document.getElementById('btn-trade-yes').disabled = true;
    document.getElementById('btn-trade-no').disabled = true;

    try {
        const res = await fetch('/api/trade/' + selectedSignal.id, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ direction, amount })
        }).then(r => r.json());

        if (res.success) {
            const modeEmoji = { paper: '[PAPER]', shadow: '[SHADOW]', live: '[LIVE]' };
            const prefix = modeEmoji[res.mode] || '';
            addLog('success', prefix + ' Trade: ' + direction + ' $' + res.amount + (res.fillPrice ? ' @ ' + (res.fillPrice * 100).toFixed(1) + 'c' : ''));

            if (res.orderId) {
                addLog('success', 'Order ID: ' + res.orderId.substring(0, 12) + '...');
            }

            // Risk Dashboard neu laden
            if (typeof loadRiskDashboard === 'function') {
                loadRiskDashboard();
            }
        } else {
            addLog('error', res.error || 'Trade fehlgeschlagen');
        }
    } catch (err) {
        addLog('error', 'Trade Fehler: ' + err.message);
    } finally {
        // Buttons wieder aktivieren
        document.getElementById('btn-trade-yes').disabled = false;
        document.getElementById('btn-trade-no').disabled = false;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        TICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let tickerStats = { news: 0, matches: 0 };

function handleTickerEvent(event) {
    const log = document.getElementById('ticker-log');
    const time = new Date(event.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

    if (event.type === 'match_found' || event.type === 'no_match') {
        tickerStats.news++;
        if (event.type === 'match_found') tickerStats.matches++;
        document.getElementById('ticker-news').textContent = tickerStats.news;
        document.getElementById('ticker-matches').textContent = tickerStats.matches;
    }

    const entry = document.createElement('div');
    entry.className = 'log-entry';

    if (event.type === 'match_found') {
        const market = event.matchResult?.markets?.[0];
        const score = ((market?.matchScore || 0) * 100).toFixed(0);
        const bar = 'â–ˆ'.repeat(Math.round(score / 10)) + 'â–‘'.repeat(10 - Math.round(score / 10));
        const marketId = market?.id || '';
        const marketUrl = marketId ? `https://polymarket.com/event/${marketId}` : '#';
        const newsTitle = event.title?.substring(0, 30) || 'News';
        const marketQuestion = market?.question?.substring(0, 30) || 'Markt';

        entry.innerHTML = `
            <span class="log-time">[${time}]</span>
            <span class="log-level success">MATCH</span>
            <span class="log-message">
                "${newsTitle}..." â†’
                <a href="${marketUrl}" target="_blank" style="color: var(--accent-primary); text-decoration: none;">"${marketQuestion}..."</a>
                <span style="color: var(--green-profit); font-family: monospace; margin-left: 8px;">${bar} ${score}%</span>
            </span>
        `;
    } else if (event.type === 'news_in') {
        entry.innerHTML = `
            <span class="log-time">[${time}]</span>
            <span class="log-level info">NEWS</span>
            <span class="log-message">${event.source}: ${event.title?.substring(0, 60)}...</span>
        `;
    } else {
        entry.innerHTML = `
            <span class="log-time">[${time}]</span>
            <span class="log-level system">â”€â”€</span>
            <span class="log-message" style="color: var(--text-muted);">no match</span>
        `;
    }

    log.appendChild(entry);
    while (log.children.length > 100) log.removeChild(log.firstChild);
    log.scrollTop = log.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        ALMANIEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderPolls(polls) {
    const container = document.getElementById('polls-data');
    if (!polls?.length) {
        container.innerHTML = '<span style="color: var(--text-muted);">Keine Umfragen</span>';
        return;
    }

    const poll = polls[0];
    const parties = ['CDU/CSU', 'AfD', 'SPD', 'GrÃ¼ne', 'BSW', 'FDP'];
    const colors = { 'CDU/CSU': '#666', 'AfD': '#00aaff', 'SPD': '#ff3333', 'GrÃ¼ne': '#22cc33', 'BSW': '#ff6600', 'FDP': '#ffdd00' };

    let html = `<div style="font-size: 9px; color: var(--text-muted); margin-bottom: 12px;">${poll.institute} | ${poll.date}</div>`;

    html += parties.map(party => {
        const val = poll.results?.[party] || 0;
        if (!val) return '';
        return `
            <div style="display: flex; align-items: center; gap: 8px; margin: 4px 0;">
                <span style="width: 60px; font-size: 10px; color: var(--text-muted);">${party}</span>
                <div style="flex: 1; height: 12px; background: var(--bg-terminal);">
                    <div style="width: ${val * 2}%; height: 100%; background: ${colors[party] || 'var(--green-dim)'}; position: relative;">
                        <div style="position: absolute; right: 0; top: 0; bottom: 0; width: 2px; background: ${colors[party]}; box-shadow: 0 0 4px ${colors[party]};"></div>
                    </div>
                </div>
                <span style="width: 30px; text-align: right; font-size: 10px;">${val}%</span>
            </div>
        `;
    }).filter(x => x).join('');

    container.innerHTML = html;
}

function renderNews(news) {
    const container = document.getElementById('news-data');
    if (!container) return;
    if (!news?.length) {
        container.innerHTML = '<span style="color: var(--text-muted);">Keine News</span>';
        return;
    }

    container.innerHTML = news.slice(0, 10).map(item => `
        <div style="padding: 8px 0; border-bottom: 1px solid var(--border-dim);">
            <div style="font-size: 9px; color: var(--text-muted);">${item.data?.source || 'NEWS'}</div>
            <div style="font-size: 11px; color: var(--text-secondary);">${item.title}</div>
        </div>
    `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        ALMANIEN MATCHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadAlmanienMatches() {
    const container = document.getElementById('almanien-matches');
    const matchCount = document.getElementById('almanien-match-count');
    const newsCount = document.getElementById('almanien-news-count');

    if (!container) return;

    container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <div style="font-size: 14px;">Lade Matches...</div>
        </div>
    `;

    try {
        const res = await fetch('/api/germany/matches', { credentials: 'include' }).then(r => r.json());

        if (matchCount) matchCount.textContent = res.matchedNews || 0;
        if (newsCount) newsCount.textContent = res.totalNews || 0;

        if (!res.matches?.length) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div style="font-size: 18px; margin-bottom: 12px;">Keine Matches gefunden</div>
                    <div style="font-size: 10px;">${res.totalNews || 0} News geprueft, ${res.marketsChecked || 0} Maerkte</div>
                </div>
            `;
            return;
        }

        container.innerHTML = res.matches.map(item => {
            const bestMatch = item.marketMatches[0];
            const confidencePercent = (bestMatch.confidence * 100).toFixed(0);
            const confidenceColor = bestMatch.confidence >= 0.7 ? 'var(--green-profit)' :
                                   bestMatch.confidence >= 0.4 ? 'var(--amber-watch)' : 'var(--text-muted)';

            // Zeitvorsprung formatieren
            let timeAdvantage = '';
            if (bestMatch.timeAdvantageMinutes !== undefined) {
                if (bestMatch.timeAdvantageMinutes < 60) {
                    timeAdvantage = `${bestMatch.timeAdvantageMinutes}m`;
                } else if (bestMatch.timeAdvantageMinutes < 1440) {
                    timeAdvantage = `${Math.floor(bestMatch.timeAdvantageMinutes / 60)}h`;
                } else {
                    timeAdvantage = `${Math.floor(bestMatch.timeAdvantageMinutes / 1440)}d`;
                }
            }

            // Confidence Bar
            const barFilled = Math.round(confidencePercent / 10);
            const bar = 'â–ˆ'.repeat(barFilled) + 'â–‘'.repeat(10 - barFilled);

            return `
                <div style="padding: 16px; border-bottom: 1px solid var(--border-mid); background: var(--bg-panel);">
                    <!-- News Header -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <div style="font-size: 9px; color: var(--text-muted); margin-bottom: 4px;">
                                ${item.news.source} | ${new Date(item.news.publishedAt).toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}
                                ${timeAdvantage ? `<span style="color: var(--green-profit); margin-left: 8px;">ZEIT: ${timeAdvantage}</span>` : ''}
                            </div>
                            <div style="font-size: 12px; color: var(--text-primary); font-weight: 500;">
                                ${item.news.url ? `<a href="${item.news.url}" target="_blank" style="color: inherit; text-decoration: none;">${item.news.title}</a>` : item.news.title}
                            </div>
                        </div>
                    </div>

                    <!-- Market Match -->
                    <div style="background: var(--bg-terminal); padding: 12px; border-radius: 4px; margin-top: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-size: 10px; color: var(--cyan-info);">POLYMARKET MATCH</div>
                            <div style="font-size: 10px; font-family: monospace; color: ${confidenceColor};">
                                ${bar} ${confidencePercent}%
                            </div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
                            ${bestMatch.question}
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 9px; color: var(--text-muted);">
                                ${bestMatch.matchedEntities.length > 0 ? `<span style="color: var(--green-dim);">Entities: ${bestMatch.matchedEntities.slice(0, 3).join(', ')}</span>` : ''}
                                ${bestMatch.matchedKeywords.length > 0 ? `<span style="margin-left: 8px;">Keywords: ${bestMatch.matchedKeywords.slice(0, 3).join(', ')}</span>` : ''}
                            </div>
                            <a href="${bestMatch.polymarketUrl}" target="_blank"
                               style="background: var(--green-dim); color: var(--bg-terminal); padding: 4px 12px;
                                      font-size: 10px; text-decoration: none; border-radius: 3px; font-weight: 600;">
                                MARKT OEFFNEN
                            </a>
                        </div>
                        ${bestMatch.currentPrice !== undefined ? `
                            <div style="font-size: 9px; color: var(--text-muted); margin-top: 6px;">
                                Aktueller Preis: <span style="color: var(--amber-watch);">${(bestMatch.currentPrice * 100).toFixed(1)}%</span>
                            </div>
                        ` : ''}
                    </div>

                    ${item.marketMatches.length > 1 ? `
                        <div style="font-size: 9px; color: var(--text-muted); margin-top: 8px;">
                            +${item.marketMatches.length - 1} weitere Matches
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');

        addLog('success', `Almanien: ${res.matchedNews} Matches gefunden`);
    } catch (err) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--red-risk);">
                <div style="font-size: 14px;">Fehler beim Laden</div>
                <div style="font-size: 10px; margin-top: 8px;">${err.message}</div>
            </div>
        `;
        addLog('error', 'Almanien Matches: ' + err.message);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        CONSOLE LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function addLog(level, message) {
    const log = document.getElementById('console-log');
    const time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-level ${level}">${level.toUpperCase().padEnd(7)}</span>
        <span class="log-message">${message}</span>
    `;

    log.appendChild(entry);
    while (log.children.length > 500) log.removeChild(log.firstChild);
    log.scrollTop = log.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initClock() {
    function update() {
        document.getElementById('clock').textContent = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    update();
    setInterval(update, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        BACKTEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadBacktestData() {
    try {
        const res = await fetch('/api/backtest/data', { credentials: 'include' }).then(r => r.json());
        const container = document.getElementById('bt-data-info');

        if (res.available) {
            document.getElementById('bt-trade-count').textContent = res.tradeCount.toLocaleString();

            // Set default dates from data range
            if (res.dateRange?.from) {
                document.getElementById('bt-from').value = res.dateRange.from.substring(0, 10);
            }
            if (res.dateRange?.to) {
                document.getElementById('bt-to').value = res.dateRange.to.substring(0, 10);
            }

            container.innerHTML = `
                <div class="data-row"><span class="data-label">Trades</span><span class="data-value">${res.tradeCount.toLocaleString()}</span></div>
                <div class="data-row"><span class="data-label">MÃ¤rkte</span><span class="data-value">${res.marketCount.toLocaleString()}</span></div>
                <div class="data-row"><span class="data-label">Resolved</span><span class="data-value">${res.resolvedCount.toLocaleString()}</span></div>
                <div class="data-row"><span class="data-label">Von</span><span class="data-value">${res.dateRange?.from?.substring(0, 10) || '--'}</span></div>
                <div class="data-row"><span class="data-label">Bis</span><span class="data-value">${res.dateRange?.to?.substring(0, 10) || '--'}</span></div>
            `;
        } else {
            document.getElementById('bt-trade-count').textContent = '0';
            container.innerHTML = `
                <div style="color: var(--amber-watch); font-size: 10px;">
                    ${res.error || 'Keine Daten'}<br><br>
                    <span style="color: var(--text-muted);">${res.hint || 'Importiere mit npm run import:polydata'}</span>
                </div>
            `;
        }
    } catch (err) {
        document.getElementById('bt-data-info').innerHTML = '<span style="color: var(--red-risk);">Fehler beim Laden</span>';
    }
}

async function runBacktest() {
    const btn = document.getElementById('bt-run-btn');
    const progressPanel = document.getElementById('bt-progress-panel');

    btn.disabled = true;
    btn.textContent = 'â—Œ LÃ„UFT...';
    progressPanel.style.display = 'block';

    const params = {
        engine: document.getElementById('bt-engine').value,
        from: document.getElementById('bt-from').value || undefined,
        to: document.getElementById('bt-to').value || undefined,
        bankroll: parseFloat(document.getElementById('bt-bankroll').value) || 1000,
        slippage: document.getElementById('bt-slippage').checked
    };

    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    addLog('info', 'STARTE BACKTEST: ' + params.engine.toUpperCase());
    addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    try {
        const res = await fetch('/api/backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(params)
        }).then(r => r.json());

        if (res.error) {
            throw new Error(res.error);
        }

        addLog('success', 'Backtest gestartet');

        // Poll for completion
        pollBacktestStatus();
    } catch (err) {
        addLog('error', 'Backtest Fehler: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'â–¶ BACKTEST STARTEN';
        progressPanel.style.display = 'none';
    }
}

async function pollBacktestStatus() {
    const btn = document.getElementById('bt-run-btn');
    const progressBar = document.getElementById('bt-progress-bar');
    const progressText = document.getElementById('bt-progress-text');
    const progressPanel = document.getElementById('bt-progress-panel');

    try {
        const status = await fetch('/api/backtest/status', { credentials: 'include' }).then(r => r.json());

        progressBar.style.width = status.progress + '%';
        progressText.textContent = status.currentPhase;

        if (status.running) {
            setTimeout(pollBacktestStatus, 500);
        } else if (status.error) {
            addLog('error', 'Backtest fehlgeschlagen: ' + status.error);
            btn.disabled = false;
            btn.textContent = 'â–¶ BACKTEST STARTEN';
            progressPanel.style.display = 'none';
        } else if (status.hasResult) {
            addLog('success', 'Backtest abgeschlossen');
            btn.disabled = false;
            btn.textContent = 'â–¶ BACKTEST STARTEN';
            progressPanel.style.display = 'none';
            loadBacktestResults();
        }
    } catch (err) {
        addLog('error', 'Status-Abfrage fehlgeschlagen');
        btn.disabled = false;
        btn.textContent = 'â–¶ BACKTEST STARTEN';
    }
}

async function loadBacktestResults() {
    try {
        const res = await fetch('/api/backtest/results', { credentials: 'include' }).then(r => r.json());

        const container = document.getElementById('bt-results');
        const pnlClass = res.metrics.totalPnl >= 0 ? 'positive' : 'negative';
        const pnlSign = res.metrics.totalPnl >= 0 ? '+' : '';
        const profitFactorStr = res.metrics.profitFactor === Infinity ? 'âˆ' : res.metrics.profitFactor?.toFixed(2) || '--';

        container.innerHTML = `
            <!-- Header mit Download-Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div style="font-size: 14px; font-weight: 600; color: var(--green-profit);">
                    ${res.engine.toUpperCase()} ENGINE BACKTEST
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="downloadBacktestJSON()" class="btn" style="font-size: 10px; padding: 6px 12px;">
                        â†“ JSON
                    </button>
                    <button onclick="downloadBacktestCSV()" class="btn" style="font-size: 10px; padding: 6px 12px;">
                        â†“ CSV
                    </button>
                    <button onclick="downloadBacktestMarkdown()" class="btn" style="font-size: 10px; padding: 6px 12px;">
                        â†“ MD
                    </button>
                </div>
            </div>

            <!-- Haupt-KPIs -->
            <div class="panel" style="margin-bottom: 16px;">
                <div class="panel-header">PERFORMANCE</div>
                <div class="panel-body">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center; margin-bottom: 16px;">
                        <div>
                            <div style="font-size: 28px; font-weight: 700;" class="${pnlClass}">${pnlSign}$${res.metrics.totalPnl.toFixed(2)}</div>
                            <div style="font-size: 10px; color: var(--text-muted);">TOTAL PnL</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: 700;">${(res.metrics.winRate * 100).toFixed(1)}%</div>
                            <div style="font-size: 10px; color: var(--text-muted);">WIN RATE</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: 700;">${res.metrics.sharpeRatio.toFixed(2)}</div>
                            <div style="font-size: 10px; color: var(--text-muted);">SHARPE</div>
                        </div>
                        <div>
                            <div style="font-size: 28px; font-weight: 700;">${res.tradeCount}</div>
                            <div style="font-size: 10px; color: var(--text-muted);">TRADES</div>
                        </div>
                    </div>
                    <div style="font-size: 10px; color: var(--text-muted);">
                        Zeitraum: ${res.period.from.substring(0, 10)} bis ${res.period.to.substring(0, 10)}
                    </div>
                </div>
            </div>

            <!-- Equity Curve Chart -->
            <div class="panel" style="margin-bottom: 16px;">
                <div class="panel-header">EQUITY CURVE</div>
                <div class="panel-body" style="padding: 0;">
                    <div id="bt-equity-chart" style="height: 200px; width: 100%;"></div>
                </div>
            </div>

            <!-- Erweiterte Metriken -->
            <div class="panel" style="margin-bottom: 16px;">
                <div class="panel-header">METRIKEN</div>
                <div class="panel-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <div class="data-row"><span class="data-label">Max Drawdown</span><span class="data-value negative">-$${Math.abs(res.metrics.maxDrawdown).toFixed(2)}</span></div>
                            <div class="data-row"><span class="data-label">Profit Factor</span><span class="data-value">${profitFactorStr}</span></div>
                            <div class="data-row"><span class="data-label">Brier Score</span><span class="data-value">${res.metrics.brierScore.toFixed(3)}</span></div>
                            <div class="data-row"><span class="data-label">Edge Capture</span><span class="data-value">${(res.metrics.avgEdgeCapture * 100).toFixed(1)}%</span></div>
                        </div>
                        <div>
                            <div class="data-row"><span class="data-label">Avg Win</span><span class="data-value positive">+$${res.metrics.avgWin?.toFixed(2) || '0.00'}</span></div>
                            <div class="data-row"><span class="data-label">Avg Loss</span><span class="data-value negative">-$${res.metrics.avgLoss?.toFixed(2) || '0.00'}</span></div>
                            <div class="data-row"><span class="data-label">Wins/Losses</span><span class="data-value">${res.metrics.winCount || 0} / ${res.metrics.lossCount || 0}</span></div>
                            <div class="data-row"><span class="data-label">Avg Slippage</span><span class="data-value">${(res.metrics.avgSlippage * 100).toFixed(2)}%</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calibration Buckets -->
            ${res.calibration && res.calibration.length > 0 ? `
            <div class="panel" style="margin-bottom: 16px;">
                <div class="panel-header">KALIBRIERUNG (Predicted vs Actual)</div>
                <div class="panel-body" style="padding: 0;">
                    <div id="bt-calibration-chart" style="height: 150px; width: 100%;"></div>
                </div>
            </div>
            ` : ''}

            <!-- Top/Worst Trades Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="panel">
                    <div class="panel-header">TOP 5 TRADES</div>
                    <div class="panel-body" style="font-size: 10px;">
                        ${res.topTrades.slice(0, 5).map(t => `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border-dim);">
                                <span style="color: var(--text-muted); max-width: 100px; overflow: hidden; text-overflow: ellipsis;" title="${t.marketId}">${t.marketId.substring(0, 10)}...</span>
                                <span style="color: var(--${t.direction === 'yes' ? 'green-profit' : 'red-risk'});">${t.direction.toUpperCase()}</span>
                                <span class="positive">+$${t.pnl?.toFixed(2) || '0.00'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header">WORST 5 TRADES</div>
                    <div class="panel-body" style="font-size: 10px;">
                        ${res.worstTrades.slice(0, 5).map(t => `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border-dim);">
                                <span style="color: var(--text-muted); max-width: 100px; overflow: hidden; text-overflow: ellipsis;" title="${t.marketId}">${t.marketId.substring(0, 10)}...</span>
                                <span style="color: var(--${t.direction === 'yes' ? 'green-profit' : 'red-risk'});">${t.direction.toUpperCase()}</span>
                                <span class="negative">$${t.pnl?.toFixed(2) || '0.00'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        // Equity Curve Chart rendern
        renderEquityCurveChart(res.equityCurve || []);

        // Calibration Chart rendern
        if (res.calibration && res.calibration.length > 0) {
            renderCalibrationChart(res.calibration);
        }

        addLog('info', 'Ergebnis: PnL=' + pnlSign + '$' + res.metrics.totalPnl.toFixed(2) + ', WinRate=' + (res.metrics.winRate * 100).toFixed(1) + '%');
        addLog('info', 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    } catch (err) {
        addLog('error', 'Ergebnisse laden fehlgeschlagen');
    }
}

// Equity Curve Chart mit Canvas (leichtgewichtig, keine externe Library)
function renderEquityCurveChart(data) {
    const container = document.getElementById('bt-equity-chart');
    if (!container || !data || data.length === 0) return;

    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth || 600;
    canvas.height = 200;
    container.innerHTML = '';
    container.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    const padding = { top: 20, right: 20, bottom: 30, left: 60 };
    const chartWidth = canvas.width - padding.left - padding.right;
    const chartHeight = canvas.height - padding.top - padding.bottom;

    // Min/Max berechnen
    const equities = data.map(d => d.equity);
    const minEquity = Math.min(...equities) * 0.98;
    const maxEquity = Math.max(...equities) * 1.02;
    const range = maxEquity - minEquity || 1;

    // Hintergrund
    ctx.fillStyle = '#0d0d0d';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Grid Lines
    ctx.strokeStyle = '#1a1a1a';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(canvas.width - padding.right, y);
        ctx.stroke();
    }

    // Y-Achsen Labels
    ctx.fillStyle = '#555555';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 4; i++) {
        const value = maxEquity - (range / 4) * i;
        const y = padding.top + (chartHeight / 4) * i;
        ctx.fillText('$' + value.toFixed(0), padding.left - 8, y + 4);
    }

    // Equity Line zeichnen
    if (data.length > 1) {
        ctx.beginPath();
        ctx.strokeStyle = '#00ff88';
        ctx.lineWidth = 2;
        ctx.lineJoin = 'round';

        for (let i = 0; i < data.length; i++) {
            const x = padding.left + (i / (data.length - 1)) * chartWidth;
            const y = padding.top + ((maxEquity - data[i].equity) / range) * chartHeight;
            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();

        // Gradient Fill
        ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
        ctx.lineTo(padding.left, padding.top + chartHeight);
        ctx.closePath();
        const gradient = ctx.createLinearGradient(0, padding.top, 0, padding.top + chartHeight);
        gradient.addColorStop(0, 'rgba(0, 255, 136, 0.15)');
        gradient.addColorStop(1, 'rgba(0, 255, 136, 0)');
        ctx.fillStyle = gradient;
        ctx.fill();
    }

    // Baseline ($1000)
    const baselineY = padding.top + ((maxEquity - 1000) / range) * chartHeight;
    if (baselineY >= padding.top && baselineY <= padding.top + chartHeight) {
        ctx.strokeStyle = '#555555';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(padding.left, baselineY);
        ctx.lineTo(canvas.width - padding.right, baselineY);
        ctx.stroke();
        ctx.setLineDash([]);
    }

    // Final Equity Label
    if (data.length > 0) {
        const finalEquity = data[data.length - 1].equity;
        const finalY = padding.top + ((maxEquity - finalEquity) / range) * chartHeight;
        ctx.fillStyle = finalEquity >= 1000 ? '#00ff88' : '#ff3344';
        ctx.font = 'bold 11px JetBrains Mono';
        ctx.textAlign = 'left';
        ctx.fillText('$' + finalEquity.toFixed(0), canvas.width - padding.right + 5, finalY + 4);
    }
}

// Calibration Chart
function renderCalibrationChart(buckets) {
    const container = document.getElementById('bt-calibration-chart');
    if (!container || !buckets || buckets.length === 0) return;

    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth || 600;
    canvas.height = 150;
    container.innerHTML = '';
    container.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    const padding = { top: 20, right: 20, bottom: 40, left: 50 };
    const chartWidth = canvas.width - padding.left - padding.right;
    const chartHeight = canvas.height - padding.top - padding.bottom;
    const barWidth = chartWidth / buckets.length - 8;

    // Hintergrund
    ctx.fillStyle = '#0d0d0d';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Diagonal Line (perfekte Kalibrierung)
    ctx.strokeStyle = '#555555';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(padding.left, padding.top + chartHeight);
    ctx.lineTo(padding.left + chartWidth, padding.top);
    ctx.stroke();
    ctx.setLineDash([]);

    // Bars zeichnen
    buckets.forEach((bucket, i) => {
        const x = padding.left + i * (chartWidth / buckets.length) + 4;
        const predictedHeight = bucket.predictedAvg * chartHeight;
        const actualHeight = bucket.actualAvg * chartHeight;

        // Predicted (grau)
        ctx.fillStyle = '#333333';
        ctx.fillRect(x, padding.top + chartHeight - predictedHeight, barWidth / 2 - 2, predictedHeight);

        // Actual (grÃ¼n/rot basierend auf Abweichung)
        const diff = bucket.actualAvg - bucket.predictedAvg;
        ctx.fillStyle = Math.abs(diff) < 0.1 ? '#00ff88' : (diff > 0 ? '#00aaff' : '#ff3344');
        ctx.fillRect(x + barWidth / 2, padding.top + chartHeight - actualHeight, barWidth / 2 - 2, actualHeight);

        // Label
        ctx.fillStyle = '#555555';
        ctx.font = '9px JetBrains Mono';
        ctx.textAlign = 'center';
        const label = bucket.range[0].toFixed(1) + '-' + bucket.range[1].toFixed(1);
        ctx.fillText(label, x + barWidth / 2, padding.top + chartHeight + 12);
        ctx.fillText('n=' + bucket.count, x + barWidth / 2, padding.top + chartHeight + 24);
    });

    // Legend
    ctx.font = '9px JetBrains Mono';
    ctx.fillStyle = '#333333';
    ctx.fillRect(canvas.width - 100, 8, 10, 10);
    ctx.fillStyle = '#888888';
    ctx.fillText('Predicted', canvas.width - 85, 17);
    ctx.fillStyle = '#00ff88';
    ctx.fillRect(canvas.width - 100, 22, 10, 10);
    ctx.fillStyle = '#888888';
    ctx.fillText('Actual', canvas.width - 85, 31);
}

// Download Functions
function downloadBacktestJSON() {
    window.open('/api/backtest/results?format=json-file', '_blank');
}

function downloadBacktestCSV() {
    window.location.href = '/api/backtest/results?format=csv';
}

function downloadBacktestMarkdown() {
    window.open('/api/backtest/results?format=markdown', '_blank');
}

// WebSocket events for backtest
if (typeof socket !== 'undefined') {
    socket?.on('backtest_progress', (data) => {
        document.getElementById('bt-progress-bar').style.width = data.progress + '%';
        document.getElementById('bt-progress-text').textContent = data.phase;
    });

    socket?.on('backtest_completed', (data) => {
        addLog('success', 'Backtest: ' + data.tradeCount + ' Trades, PnL=$' + data.totalPnl.toFixed(2));
        loadBacktestResults();
    });

    socket?.on('backtest_error', (data) => {
        addLog('error', 'Backtest Fehler: ' + data.error);
    });
}

// Handler fÃ¼r Backtest und Markets Views registrieren
registerViewHandler('backtest', () => loadBacktestData());
registerViewHandler('markets', () => loadPipelineHealth());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        PIPELINE HEALTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let pipelineReconnects = 0;

async function loadPipelineHealth() {
    try {
        const response = await fetch('/api/pipelines/health', { credentials: 'include' });

        // JSON Parse Error abfangen (wenn HTML zurÃ¼ckkommt statt JSON)
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response (possibly HTML error page)');
        }

        const res = await response.json();

        // Overall status - jetzt mit overallStatus Feld
        const overallDot = document.getElementById('pipeline-overall-status');
        const overallText = document.getElementById('pipeline-overall-text');

        // Ehrliches Status-Mapping
        const statusText = {
            'healthy': 'ALL HEALTHY',
            'degraded': 'DEGRADED',
            'error': 'ERRORS',
            'unknown': 'INITIALIZING'
        };
        const statusClass = {
            'healthy': '',
            'degraded': 'warning',
            'error': 'error',
            'unknown': 'warning'
        };

        const overallStatus = res.overallStatus || (res.overall ? 'healthy' : 'error');
        overallDot.className = 'status-dot ' + (statusClass[overallStatus] || 'error');
        overallText.textContent = statusText[overallStatus] || 'UNKNOWN';

        // Update each pipeline (defensiv gegen undefined)
        (res.pipelines || []).forEach(p => {
            updatePipelineCard(p.name, p);
        });

        // Scanner specific
        const scannerLast = document.getElementById('pl-scanner-last');
        const scannerSignal = document.getElementById('pl-scanner-signal');
        if (scannerLast) {
            scannerLast.textContent = res.lastScan ? formatTimeAgo(new Date(res.lastScan)) : '--';
        }
        if (scannerSignal) {
            scannerSignal.textContent = res.lastSignal ? formatTimeAgo(new Date(res.lastSignal)) : '--';
        }

        // WebSocket status
        document.getElementById('pl-ws-status').textContent = socket?.connected ? 'CONNECTED' : 'DISCONNECTED';
        document.getElementById('pl-ws-dot').className = 'status-dot ' + (socket?.connected ? '' : 'error');
        document.getElementById('pl-ws-connected').textContent = socket?.connected ? 'Yes' : 'No';
        document.getElementById('pl-ws-reconnects').textContent = pipelineReconnects;

        addPipelineLog('info', 'Pipeline-Status aktualisiert');
    } catch (err) {
        addPipelineLog('error', 'Fehler beim Laden: ' + err.message);
        console.error('Pipeline Health Error:', err);
    }
}

function updatePipelineCard(name, data) {
    const statusEl = document.getElementById(`pl-${name}-status`);
    const dotEl = document.getElementById(`pl-${name}-dot`);
    const lastEl = document.getElementById(`pl-${name}-last`);
    const errorsEl = document.getElementById(`pl-${name}-errors`);

    // Ehrliches Status-Mapping inkl. 'unknown'
    const statusTextMap = {
        'ok': 'HEALTHY',
        'stale': 'STALE',
        'error': 'ERROR',
        'unknown': 'NO DATA'
    };
    const statusClassMap = {
        'ok': 'positive',
        'stale': 'warning',
        'error': 'negative',
        'unknown': 'muted'
    };
    const dotClassMap = {
        'ok': '',
        'stale': 'warning',
        'error': 'error',
        'unknown': 'warning'
    };

    if (statusEl) {
        statusEl.textContent = statusTextMap[data.status] || 'UNKNOWN';
        statusEl.className = 'data-value ' + (statusClassMap[data.status] || 'negative');
    }
    if (dotEl) {
        dotEl.className = 'status-dot ' + (dotClassMap[data.status] || 'error');
    }
    if (lastEl) {
        // Zeige '--' wenn keine lastSuccess vorhanden (ehrliches Reporting)
        lastEl.textContent = data.lastSuccess ? formatTimeAgo(new Date(data.lastSuccess)) : '--';
    }
    if (errorsEl) {
        errorsEl.textContent = data.errorCount || 0;
        errorsEl.className = 'data-value ' + (data.errorCount > 0 ? 'negative' : '');
    }
}

function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHr = Math.floor(diffMin / 60);

    if (diffSec < 60) return diffSec + 's ago';
    if (diffMin < 60) return diffMin + 'm ago';
    if (diffHr < 24) return diffHr + 'h ago';
    return date.toLocaleDateString('de-DE');
}

function addPipelineLog(level, message) {
    const log = document.getElementById('pipeline-log');
    if (!log) return;

    const time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-level ${level}">${level.toUpperCase().padEnd(7)}</span>
        <span class="log-message">${message}</span>
    `;

    log.appendChild(entry);
    while (log.children.length > 100) log.removeChild(log.firstChild);
    log.scrollTop = log.scrollHeight;
}

// Track WebSocket reconnects
if (socket) {
    socket.on('connect', () => {
        document.getElementById('pl-ws-status').textContent = 'CONNECTED';
        document.getElementById('pl-ws-dot').className = 'status-dot';
        document.getElementById('pl-ws-connected').textContent = 'Yes';
    });
    socket.on('reconnect', () => {
        pipelineReconnects++;
        document.getElementById('pl-ws-reconnects').textContent = pipelineReconnects;
        addPipelineLog('warn', 'WebSocket reconnected');
    });
    socket.on('disconnect', () => {
        document.getElementById('pl-ws-status').textContent = 'DISCONNECTED';
        document.getElementById('pl-ws-dot').className = 'status-dot error';
        document.getElementById('pl-ws-connected').textContent = 'No';
        addPipelineLog('error', 'WebSocket disconnected');
    });

    // Pipeline alerts
    socket.on('pipeline_alert', (data) => {
        addPipelineLog('warn', `Pipeline ${data.pipeline} unhealthy (${data.errorCount} errors)`);
        loadPipelineHealth();
    });
}

// Auto-refresh pipeline health every 30 seconds when on that view
setInterval(() => {
    if (document.getElementById('view-markets').classList.contains('active')) {
        loadPipelineHealth();
    }
}, 30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        PERFORMANCE DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let performanceData = null;
let executionQualityData = null;

async function loadPerformanceData() {
    try {
        // Load multiple APIs in parallel (including V4.0 Performance API)
        const [tradingRes, equityRes, executionRes, v4StatsRes] = await Promise.all([
            fetch('/api/stats/trading', { credentials: 'include' }).then(r => r.json()),
            fetch('/api/stats/equity', { credentials: 'include' }).then(r => r.json()),
            fetch('/api/execution/quality', { credentials: 'include' }).then(r => r.json()).catch(() => null),
            fetch('/api/performance/stats', { credentials: 'include' }).then(r => r.json()).catch(() => null),
        ]);

        performanceData = { trading: tradingRes, equity: equityRes };
        executionQualityData = executionRes;

        // V4.0: Update Strategy Performance from Tracker
        if (v4StatsRes && v4StatsRes.byStrategy) {
            const arb = v4StatsRes.byStrategy.arbitrage || {};
            const late = v4StatsRes.byStrategy.lateEntry || {};
            const td = v4StatsRes.byStrategy.timeDelay || {};

            document.getElementById('perf-arbitrage').textContent =
                `${arb.trades || 0} trades, $${(arb.profit || 0).toFixed(2)}`;
            document.getElementById('perf-lateentry').textContent =
                `${late.trades || 0} trades, $${(late.profit || 0).toFixed(2)}`;
            document.getElementById('perf-timedelay').textContent =
                `${td.trades || 0} trades, $${(td.profit || 0).toFixed(2)}`;
            document.getElementById('perf-mode').textContent =
                `${v4StatsRes.paperTrades || 0} Paper / ${v4StatsRes.liveTrades || 0} Live`;
        }

        // Update KPI Cards
        const daily = tradingRes.daily || {};
        const pnl = daily.pnl || 0;
        const pnlEl = document.getElementById('perf-pnl');
        pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
        pnlEl.className = pnl >= 0 ? 'positive' : 'negative';

        const winRate = (daily.winRate || 0) * 100;
        document.getElementById('perf-winrate').textContent = winRate.toFixed(1) + '%';

        const trades = daily.trades || 0;
        document.getElementById('perf-trades').textContent = trades;

        // Sharpe (estimated from daily data)
        const sharpe = calculateEstimatedSharpe(equityRes);
        document.getElementById('perf-sharpe').textContent = sharpe.toFixed(2);

        // Max Drawdown
        const maxDD = calculateMaxDrawdown(equityRes.equityCurve || []);
        const ddEl = document.getElementById('perf-drawdown');
        ddEl.textContent = '-' + (maxDD * 100).toFixed(1) + '%';

        // Execution Quality Score
        if (executionRes && executionRes.metrics) {
            document.getElementById('perf-quality').textContent = executionRes.metrics.executionQualityScore || '--';
        }

        // Update Equity Chart
        renderPerformanceEquityCurve(equityRes.equityCurve || []);

        // Update Streaks
        updateStreakStats(daily);

        // Update Execution Quality Details
        if (executionRes && executionRes.metrics) {
            updateExecutionQualityDisplay(executionRes.metrics);
            updateRecommendations(executionRes.recommendations || []);
        }

    } catch (err) {
        console.error('Performance load error:', err);
    }
}

function calculateEstimatedSharpe(equityData) {
    if (!equityData || !equityData.equityCurve || equityData.equityCurve.length < 2) return 0;

    const returns = [];
    for (let i = 1; i < equityData.equityCurve.length; i++) {
        const prevEquity = equityData.equityCurve[i - 1].cumulative || 1000;
        const currEquity = equityData.equityCurve[i].cumulative || 1000;
        returns.push((currEquity - prevEquity) / prevEquity);
    }

    if (returns.length === 0) return 0;

    const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
    const variance = returns.reduce((sum, r) => sum + Math.pow(r - avgReturn, 2), 0) / (returns.length - 1);
    const stdDev = Math.sqrt(variance);

    if (stdDev === 0) return avgReturn > 0 ? 99 : 0;

    // Annualized (assuming ~250 trades per year)
    const annualizedReturn = avgReturn * 250;
    const annualizedStdDev = stdDev * Math.sqrt(250);

    return (annualizedReturn - 0.05) / annualizedStdDev; // 5% risk-free
}

function calculateMaxDrawdown(equityCurve) {
    if (!equityCurve || equityCurve.length === 0) return 0;

    let peak = 1000;
    let maxDD = 0;

    for (const point of equityCurve) {
        const equity = point.equity || point.cumulative || 1000;
        if (equity > peak) peak = equity;
        const dd = (peak - equity) / peak;
        if (dd > maxDD) maxDD = dd;
    }

    return maxDD;
}

function renderPerformanceEquityCurve(data) {
    const container = document.getElementById('perf-equity-chart');
    if (!container || !data || data.length === 0) {
        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">Keine Daten verfÃ¼gbar</div>';
        return;
    }

    const canvas = document.createElement('canvas');
    canvas.width = container.clientWidth || 600;
    canvas.height = 200;
    container.innerHTML = '';
    container.appendChild(canvas);

    const ctx = canvas.getContext('2d');
    const padding = { top: 20, right: 60, bottom: 30, left: 60 };
    const chartWidth = canvas.width - padding.left - padding.right;
    const chartHeight = canvas.height - padding.top - padding.bottom;

    // Prepare data
    const equities = data.map(d => d.equity || d.cumulative || 1000);
    const minEquity = Math.min(...equities) * 0.98;
    const maxEquity = Math.max(...equities) * 1.02;
    const range = maxEquity - minEquity || 1;

    // Background
    ctx.fillStyle = '#0d0d0d';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Grid
    ctx.strokeStyle = '#1a1a1a';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(canvas.width - padding.right, y);
        ctx.stroke();
    }

    // Y-Axis labels
    ctx.fillStyle = '#555555';
    ctx.font = '10px JetBrains Mono';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 4; i++) {
        const value = maxEquity - (range / 4) * i;
        const y = padding.top + (chartHeight / 4) * i;
        ctx.fillText('$' + value.toFixed(0), padding.left - 8, y + 4);
    }

    // Line
    if (data.length > 1) {
        ctx.beginPath();
        ctx.strokeStyle = '#00ff88';
        ctx.lineWidth = 2;

        for (let i = 0; i < data.length; i++) {
            const x = padding.left + (i / (data.length - 1)) * chartWidth;
            const equity = data[i].equity || data[i].cumulative || 1000;
            const y = padding.top + ((maxEquity - equity) / range) * chartHeight;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // Fill
        ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
        ctx.lineTo(padding.left, padding.top + chartHeight);
        ctx.closePath();
        const gradient = ctx.createLinearGradient(0, padding.top, 0, padding.top + chartHeight);
        gradient.addColorStop(0, 'rgba(0, 255, 136, 0.15)');
        gradient.addColorStop(1, 'rgba(0, 255, 136, 0)');
        ctx.fillStyle = gradient;
        ctx.fill();
    }

    // Final value label
    if (data.length > 0) {
        const finalEquity = data[data.length - 1].equity || data[data.length - 1].cumulative || 1000;
        const finalY = padding.top + ((maxEquity - finalEquity) / range) * chartHeight;
        ctx.fillStyle = finalEquity >= 1000 ? '#00ff88' : '#ff3344';
        ctx.font = 'bold 11px JetBrains Mono';
        ctx.textAlign = 'left';
        ctx.fillText('$' + finalEquity.toFixed(0), canvas.width - padding.right + 5, finalY + 4);
    }
}

function updateStreakStats(daily) {
    // Current streak (simplified - would need trade history)
    const wins = daily.wins || 0;
    const losses = daily.losses || 0;

    if (wins > 0 && losses === 0) {
        document.getElementById('perf-streak').textContent = '+' + wins + ' W';
        document.getElementById('perf-streak').className = 'data-value positive';
    } else if (losses > 0 && wins === 0) {
        document.getElementById('perf-streak').textContent = '-' + losses + ' L';
        document.getElementById('perf-streak').className = 'data-value negative';
    } else {
        document.getElementById('perf-streak').textContent = 'Mixed';
        document.getElementById('perf-streak').className = 'data-value';
    }

    // Avg Win/Loss
    const avgWin = wins > 0 && daily.pnl > 0 ? daily.pnl / wins : 0;
    const avgLoss = losses > 0 && daily.pnl < 0 ? Math.abs(daily.pnl) / losses : 0;
    document.getElementById('perf-avg-win').textContent = '+$' + avgWin.toFixed(2);
    document.getElementById('perf-avg-loss').textContent = '-$' + avgLoss.toFixed(2);

    // Profit Factor
    const grossProfit = avgWin * wins;
    const grossLoss = avgLoss * losses;
    const profitFactor = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : (grossProfit > 0 ? 'âˆ' : '--');
    document.getElementById('perf-profit-factor').textContent = profitFactor;
}

function updateExecutionQualityDisplay(metrics) {
    document.getElementById('perf-fill-rate').textContent = (metrics.fillRate * 100).toFixed(1) + '%';
    document.getElementById('perf-avg-slippage').textContent = (metrics.avgActualSlippage * 100).toFixed(3) + '%';
    document.getElementById('perf-exp-slippage').textContent = (metrics.avgExpectedSlippage * 100).toFixed(3) + '%';
    document.getElementById('perf-slip-cost').textContent = '$' + (metrics.slippageCost || 0).toFixed(2);
    document.getElementById('perf-latency').textContent = Math.round(metrics.avgTotalLatency || 0) + 'ms';
    document.getElementById('perf-p95-latency').textContent = Math.round(metrics.p95Latency || 0) + 'ms';
    document.getElementById('perf-price-improve').textContent = ((metrics.priceImprovementRate || 0) * 100).toFixed(0) + '%';

    const accuracy = metrics.slippageAccuracy || 1;
    const accuracyDisplay = accuracy < 1.5 && accuracy > 0.5 ? 'Good' : (accuracy >= 1.5 ? 'Under' : 'Over');
    document.getElementById('perf-model-acc').textContent = accuracyDisplay;
}

function updateRecommendations(recommendations) {
    const container = document.getElementById('perf-recommendations');
    if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<div style="color: var(--green-profit);">âœ“ Alle Systeme optimal</div>';
        return;
    }

    container.innerHTML = recommendations.map((rec, i) => `
        <div style="padding: 4px 0; ${i > 0 ? 'border-top: 1px solid var(--border-dim);' : ''}">
            <span style="color: var(--amber-watch);">âš </span> ${rec}
        </div>
    `).join('');
}

// Handler fÃ¼r Performance View registrieren
registerViewHandler('performance', () => loadPerformanceData());

// Auto-refresh performance every 60 seconds when on that view
setInterval(() => {
    if (document.getElementById('view-performance')?.classList.contains('active')) {
        loadPerformanceData();
    }
}, 60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        PRICE CHARTS (Lightweight-Charts)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let priceChart = null;
let priceSeries = null;

// Load signal markers for the chart
async function loadSignalMarkers(marketId) {
    if (!priceSeries || !marketId) return;

    try {
        const res = await fetch(`/api/signals/market/${marketId}`, { credentials: 'include' }).then(r => r.json());

        if (!res.signals || res.signals.length === 0) return;

        // Convert signals to Lightweight-Charts marker format
        // V4.2: Nur noch 3 Strategien - TimeDelay (News), Arbitrage, Late-Entry
        const markers = res.signals.map(s => {
            const time = Math.floor(new Date(s.createdAt).getTime() / 1000);
            const isUp = s.direction === 'BUY' || s.direction === 'YES';
            const edgePct = (s.predictedEdge * 100).toFixed(1);

            // Strategie-basierte Farben
            const strategyColors = {
                'timeDelay': '#ff9900',    // Orange - News-Vorsprung
                'arbitrage': '#00ff88',    // GrÃ¼n - Arbitrage
                'lateEntry': '#00d4ff',    // Cyan - Late-Entry
            };
            const color = strategyColors[s.alphaType] || strategyColors[s.strategy] || '#ff9900';

            return {
                time,
                position: isUp ? 'belowBar' : 'aboveBar',
                color,
                shape: isUp ? 'arrowUp' : 'arrowDown',
                text: `${(s.alphaType || s.strategy || 'SIG').substring(0, 3).toUpperCase()} ${edgePct}%`,
            };
        });

        // Sort markers by time (Lightweight-Charts requirement)
        markers.sort((a, b) => a.time - b.time);

        priceSeries.setMarkers(markers);
        addLog('info', `Chart: ${markers.length} Signal-Marker geladen`);
    } catch (err) {
        console.warn('Marker laden fehlgeschlagen:', err);
    }
}

async function loadPriceChart(signal) {
    const container = document.getElementById('chart-container');
    const marketId = signal.market?.id;
    const tokenId = signal.market?.outcomes?.[0]?.id;
    const slug = signal.market?.slug;

    // Show loading state
    container.innerHTML = '<div class="chart-placeholder"><span style="color: var(--text-muted);">ğŸ“Š Loading chart...</span></div>';

    // Create chart
    if (typeof LightweightCharts === 'undefined') {
        container.innerHTML = `
            <div class="chart-placeholder" style="flex-direction: column; gap: 8px;">
                <span style="color: var(--amber-watch);">âš ï¸ Chart library not loaded</span>
                ${slug ? `<a href="https://polymarket.com/event/${slug}" target="_blank" style="color: var(--cyan-info); font-size: 10px;">View on Polymarket â†’</a>` : ''}
            </div>
        `;
        return;
    }

    // Clear previous chart properly
    if (priceChart) {
        try {
            priceChart.remove();
        } catch (e) {}
        priceChart = null;
        priceSeries = null;
    }
    container.innerHTML = '';

    try {
        // Create chart instance
        priceChart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: 180,
            layout: {
                background: { type: 'solid', color: '#0a0a0a' },
                textColor: '#888888',
            },
            grid: {
                vertLines: { color: '#1a1a1a' },
                horzLines: { color: '#1a1a1a' },
            },
            timeScale: {
                borderColor: '#222222',
                timeVisible: true,
                secondsVisible: false,
            },
            rightPriceScale: {
                borderColor: '#222222',
                scaleMargins: { top: 0.1, bottom: 0.1 },
            },
            crosshair: {
                vertLine: { color: '#00ff88', width: 1, style: 2 },
                horzLine: { color: '#00ff88', width: 1, style: 2 },
            },
        });

        // Add area series for price
        priceSeries = priceChart.addAreaSeries({
            topColor: 'rgba(0, 255, 136, 0.3)',
            bottomColor: 'rgba(0, 255, 136, 0.02)',
            lineColor: '#00ff88',
            lineWidth: 2,
            priceFormat: { type: 'percent' },
        });

        let dataLoaded = false;

        // Try to load real price history
        if (tokenId) {
            const res = await fetch(`/api/polymarket/prices/${tokenId}`, { credentials: 'include' }).then(r => r.json());

            if (res.points && res.points.length > 0) {
                const chartData = res.points.map(p => ({
                    time: Math.floor(p.timestamp / 1000),
                    value: p.price * 100, // Convert to percentage
                }));
                priceSeries.setData(chartData);
                addLog('info', `Chart: ${chartData.length} Datenpunkte geladen`);
                dataLoaded = true;
            }
        }

        // Fallback: Generate synthetic data based on current price
        if (!dataLoaded) {
            const currentPrice = signal.market?.outcomes?.[0]?.price || 0.5;
            const syntheticData = generateSyntheticPriceData(currentPrice);
            priceSeries.setData(syntheticData);

            // Add info overlay for synthetic data
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: absolute; bottom: 8px; left: 8px; font-size: 9px; color: var(--text-muted); z-index: 10;';
            overlay.innerHTML = slug
                ? `<a href="https://polymarket.com/event/${slug}" target="_blank" style="color: var(--cyan-dim);">ğŸ“ˆ View on Polymarket</a>`
                : 'ğŸ“Š Simulated data';
            container.style.position = 'relative';
            container.appendChild(overlay);
        }

        // Load and display signal markers
        if (marketId) {
            await loadSignalMarkers(marketId);
        }

        priceChart.timeScale().fitContent();

    } catch (err) {
        container.innerHTML = `
            <div class="chart-placeholder" style="flex-direction: column; gap: 8px;">
                <span style="color: var(--red-risk);">Chart Error: ${err.message}</span>
                ${slug ? `<a href="https://polymarket.com/event/${slug}" target="_blank" style="color: var(--cyan-info); font-size: 10px;">View on Polymarket â†’</a>` : ''}
            </div>
        `;
    }
}

function generateSyntheticPriceData(currentPrice) {
    const data = [];
    const now = Math.floor(Date.now() / 1000);
    const hoursBack = 168; // 7 days

    let price = currentPrice * 100; // Start at current price (as percentage)

    for (let i = hoursBack; i >= 0; i--) {
        const time = now - i * 3600;

        // Random walk toward current price
        const targetDiff = (currentPrice * 100) - price;
        const drift = targetDiff * 0.02; // Mean reversion
        const noise = (Math.random() - 0.5) * 3; // Random noise

        price = Math.max(1, Math.min(99, price + drift + noise));

        data.push({ time, value: price });
    }

    // Ensure last point is current price
    data[data.length - 1].value = currentPrice * 100;

    return data;
}

// Resize chart on window resize
window.addEventListener('resize', () => {
    if (priceChart) {
        const container = document.getElementById('chart-container');
        priceChart.resize(container.clientWidth, 180);
    }
    if (equityChart) {
        const container = document.getElementById('equity-chart-container');
        equityChart.resize(container.clientWidth, 150);
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        EQUITY CURVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let equityChart = null;
let equitySeries = null;

async function loadEquityCurve() {
    const container = document.getElementById('equity-chart-container');
    if (!container) return;

    try {
        const data = await fetch('/api/stats/equity', { credentials: 'include' }).then(r => r.json());

        // Wenn keine Trades, Platzhalter zeigen
        if (!data.equityCurve || data.equityCurve.length === 0) {
            container.innerHTML = '<span style="color: var(--text-muted); font-size: 11px;">Keine Trades - Chart erscheint nach erstem Trade</span>';
            return;
        }

        // Chart erstellen wenn noch nicht existiert
        if (!equityChart && typeof LightweightCharts !== 'undefined') {
            container.innerHTML = '';
            equityChart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 150,
                layout: {
                    background: { type: 'solid', color: '#080808' },
                    textColor: '#888888',
                },
                grid: {
                    vertLines: { color: '#1a1a1a' },
                    horzLines: { color: '#1a1a1a' },
                },
                timeScale: {
                    borderColor: '#222222',
                    timeVisible: true,
                },
                rightPriceScale: {
                    borderColor: '#222222',
                },
            });

            equitySeries = equityChart.addAreaSeries({
                topColor: 'rgba(0, 255, 136, 0.3)',
                bottomColor: 'rgba(0, 255, 136, 0.02)',
                lineColor: '#00ff88',
                lineWidth: 2,
            });
        }

        if (equitySeries && data.equityCurve.length > 0) {
            // Konvertiere zu Chart-Format
            const chartData = data.equityCurve.map((p, i) => ({
                time: Math.floor(Date.now() / 1000) - (data.equityCurve.length - i) * 3600,
                value: p.cumulative,
            }));
            equitySeries.setData(chartData);
            equityChart.timeScale().fitContent();
        }
    } catch (err) {
        console.error('Equity Curve Fehler:', err);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        AUDIT LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadAuditLog() {
    const container = document.getElementById('audit-log-container');
    if (!container) return;

    try {
        const data = await fetch('/api/audit?limit=20', { credentials: 'include' }).then(r => r.json());

        if (!data.entries || data.entries.length === 0) {
            container.innerHTML = '<div style="color: var(--text-muted); padding: 8px;">Keine Audit-Eintraege vorhanden</div>';
            return;
        }

        const html = data.entries.map(entry => {
            const typeColors = {
                trade: 'var(--cyan-info)',
                mode_change: 'var(--amber-watch)',
                kill_switch: 'var(--red-risk)',
                settings: 'var(--text-secondary)',
                daily_reset: 'var(--green-dim)',
            };
            const color = typeColors[entry.eventType] || 'var(--text-muted)';

            return `
                <div style="padding: 4px 8px; border-bottom: 1px solid var(--border-dim);">
                    <span style="color: ${color}; font-weight: 500;">[${entry.eventType.toUpperCase()}]</span>
                    <span style="color: var(--text-secondary);">${entry.action}</span>
                    ${entry.pnlImpact ? `<span style="color: ${entry.pnlImpact >= 0 ? 'var(--green-profit)' : 'var(--red-risk)'}; margin-left: 8px;">${entry.pnlImpact >= 0 ? '+' : ''}$${entry.pnlImpact.toFixed(2)}</span>` : ''}
                </div>
            `;
        }).join('');

        container.innerHTML = html;
    } catch (err) {
        container.innerHTML = '<div style="color: var(--red-risk); padding: 8px;">Fehler beim Laden</div>';
    }
}

// Lade Equity Curve und Audit Log beim Start und alle 30 Sekunden
loadEquityCurve();
loadAuditLog();
setInterval(() => {
    loadEquityCurve();
    loadAuditLog();
}, 30000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        BROWSER NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Lese Notification Settings aus den bestehenden Checkboxen im Settings-View
function getNotificationSettings() {
    return {
        enabled: document.getElementById('settings-browser-notifications')?.checked ?? false,
        highAlpha: document.getElementById('settings-notify-high-alpha')?.checked ?? true,
        tradeExecuted: document.getElementById('settings-notify-trade')?.checked ?? true,
        riskWarning: document.getElementById('settings-notify-killswitch')?.checked ?? true,
        signal: document.getElementById('settings-notify-signal')?.checked ?? true,
        dailyReset: document.getElementById('settings-notify-daily-reset')?.checked ?? false,
    };
}

// Fallback fuer alte localStorage-basierte Settings
const notificationSettings = {
    enabled: localStorage.getItem('notifications_enabled') === 'true',
    sound: localStorage.getItem('notifications_sound') !== 'false',
    highAlpha: localStorage.getItem('notify_high_alpha') !== 'false',
    almanienEdge: localStorage.getItem('notify_almanien_edge') !== 'false',
    tradeExecuted: localStorage.getItem('notify_trade_executed') !== 'false',
    riskWarning: localStorage.getItem('notify_risk_warning') !== 'false',
    pipelineError: localStorage.getItem('notify_pipeline_error') !== 'false',
};

const notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleAQAp/XWhGwAJH/l0phlDC+M4MeJWABIoejAhEoAaqzsvXw8AFi36bRvMgBqxO+rbigAec3ypGIgAIvV9JpXFgCd3PaOSwwAsOP3gj0CAMTq94EyANLy+H0pAN35+HghAOj9+HIZAPn/9GwTAAD+8mYOAAH86WEJAAXz4FwFAAnq11cCAA3f0FIAEK3KTAAS0sVGABTHwEAAFry7OgAYr7Y0ABqkriwAG5ujJQAclpodAB2RlxYAHoyTDwAfh48IAB+DjAIAH3+JAAAfeoUAAB92ggAAHnJ+AAAeb3sAAB1regAAHWh3AAAcZXQAABtidAAAG19yAAAaXXAAABpbbQAAGlltAAAZV2oAABlVaAAAGVNmAAAYUWQAABhPYgAAF01gAAAXS14AABZJXAAAFkdaAAAVRVgAABVDVgAAFEFUAAAUP1IAABNAUAAAEz5OAAASPEwAABE6SgAAETlIAAAQN0YAABs1RAAAHTNCAAAuMUAAACQvPgAAGi09AAAYKzsAABUpOQAAEyc3AAARJTUAABMjMwAAECExAAAPHy8AAA0dLQAADxsrAAA=');

async function requestNotificationPermission() {
    if (!('Notification' in window)) {
        addLog('warn', 'Browser unterstuetzt keine Notifications');
        return false;
    }
    if (Notification.permission === 'granted') return true;
    if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            notificationSettings.enabled = true;
            localStorage.setItem('notifications_enabled', 'true');
            addLog('success', 'Browser Notifications aktiviert');
            return true;
        }
    }
    addLog('warn', 'Browser Notifications verweigert');
    return false;
}

function showBrowserNotification(data) {
    // Nutze bestehende Settings-Checkboxen oder Fallback
    const settings = getNotificationSettings();
    const masterEnabled = settings.enabled || notificationSettings.enabled;

    if (!masterEnabled || Notification.permission !== 'granted') return;

    // Mapping von Event-Typen zu Checkbox-IDs
    const typeMap = {
        'high_alpha': 'highAlpha',
        'almanien_edge': 'signal',  // Almanien-Edge = neues Signal
        'trade_executed': 'tradeExecuted',
        'risk_warning': 'riskWarning',
        'pipeline_error': 'signal',  // Pipeline Fehler unter Signal
    };
    const settingKey = typeMap[data.type];

    // Pruefe ob dieser Event-Typ aktiviert ist
    if (settingKey) {
        const isEnabled = settings[settingKey] ?? notificationSettings[settingKey] ?? true;
        if (!isEnabled) return;
    }

    const notification = new Notification(data.title, {
        body: data.body,
        icon: '/icon-192.png',
        badge: '/icon-192.png',
        tag: data.type + '-' + Date.now(),
        requireInteraction: data.urgency === 'critical',
        silent: !notificationSettings.sound,
    });

    if (notificationSettings.sound && data.urgency !== 'low') {
        notificationSound.play().catch(() => {});
    }

    notification.onclick = () => {
        window.focus();
        if (data.type === 'high_alpha') showView('signals');
        else if (data.type === 'risk_warning') showView('risk');
        else if (data.type === 'pipeline_error') showView('markets');
        notification.close();
    };

    if (data.urgency !== 'critical') {
        setTimeout(() => notification.close(), 10000);
    }
}

// Permission Request wenn Browser-Notifications Checkbox aktiviert wird
function initBrowserNotificationsCheckbox() {
    const checkbox = document.getElementById('settings-browser-notifications');
    if (checkbox) {
        checkbox.addEventListener('change', function() {
            if (this.checked && Notification.permission !== 'granted') {
                requestNotificationPermission().then(granted => {
                    if (!granted) {
                        this.checked = false;
                        addLog('warn', 'Browser Notifications verweigert');
                    } else {
                        addLog('success', 'Browser Notifications aktiviert');
                    }
                });
            }
        });
    }
}

// Initialisiere Checkbox-Handler wenn Settings-View geladen wird
setTimeout(initBrowserNotificationsCheckbox, 500);

function testNotification() {
    showBrowserNotification({
        type: 'high_alpha',
        title: 'TEST NOTIFICATION',
        body: 'Dies ist eine Test-Notification. Alles funktioniert!',
        icon: 'alpha',
        urgency: 'medium',
    });
}

// Socket Event Handler fuer Browser Notifications
if (socket) {
    socket.on('browser_notification', (data) => {
        showBrowserNotification(data);
    });
}

// Initialize Notifications
if ('Notification' in window && Notification.permission === 'granted' && notificationSettings.enabled) {
    // Notifications bereits aktiviert
} else if (notificationSettings.enabled) {
    requestNotificationPermission();
}
setTimeout(updateNotificationUI, 100);

// =====================================================================================
//                        SETTINGS PAGE FUNCTIONS
// =====================================================================================

// Default-Werte fuer Settings
const DEFAULT_SETTINGS = {
    trading: {
        maxDailyLoss: 100,
        maxPositions: 10,
        maxPerMarket: 50,
        maxBetUsdc: 10,
        kellyFraction: 25,
        bankroll: 1000,
        executionMode: 'paper',
    },
    signals: {
        minAlpha: 15,
        minEdge: 5,
        minVolumeUsd: 10000,
        autoTradeOnBreaking: false,
    },
    notifications: {
        browserNotifications: true,
        notifySignal: true,
        notifyTrade: true,
        notifyKillswitch: true,
        notifyDailyReset: false,
        notifyHighAlpha: true,
    },
};

// Lade Settings beim View-Wechsel
async function loadSettings() {
    try {
        const [serverSettings, configData, walletData] = await Promise.all([
            fetch('/api/settings/all', { credentials: 'include' }).then(r => r.ok ? r.json() : null),
            fetch('/api/config', { credentials: 'include' }).then(r => r.ok ? r.json() : null),
            fetch('/api/wallet', { credentials: 'include' }).then(r => r.ok ? r.json() : null),
        ]);

        // Trading Settings aus Server laden
        if (serverSettings?.trading) {
            setSettingsInputValue('settings-execution-mode', serverSettings.trading.executionMode || 'paper');
            setSettingsInputValue('settings-max-daily-loss', serverSettings.trading.maxDailyLoss || DEFAULT_SETTINGS.trading.maxDailyLoss);
            setSettingsInputValue('settings-max-positions', serverSettings.trading.maxPositions || DEFAULT_SETTINGS.trading.maxPositions);
            setSettingsInputValue('settings-max-per-market', serverSettings.trading.maxPerMarket || DEFAULT_SETTINGS.trading.maxPerMarket);
            setSettingsInputValue('settings-kelly-fraction', (serverSettings.trading.kellyFraction || 0.25) * 100);
            setSettingsInputValue('settings-bankroll', serverSettings.trading.bankroll || DEFAULT_SETTINGS.trading.bankroll);
            setSettingsInputValue('settings-max-bet', serverSettings.trading.maxBetUsdc || DEFAULT_SETTINGS.trading.maxBetUsdc);
        }

        // Signal Settings
        if (serverSettings?.signals) {
            setSettingsInputValue('settings-min-alpha', serverSettings.signals.minAlpha || DEFAULT_SETTINGS.signals.minAlpha);
            setSettingsInputValue('settings-min-edge', serverSettings.signals.minEdge || DEFAULT_SETTINGS.signals.minEdge);
            setSettingsInputValue('settings-min-volume', serverSettings.signals.minVolumeUsd || DEFAULT_SETTINGS.signals.minVolumeUsd);
        }

        // Notification Settings aus localStorage laden
        const savedNotify = loadSettingsNotificationConfig();
        setSettingsCheckbox('settings-browser-notifications', savedNotify?.enabled ?? true);
        setSettingsCheckbox('settings-notify-signal', savedNotify?.events?.signal ?? true);
        setSettingsCheckbox('settings-notify-trade', savedNotify?.events?.trade ?? true);
        setSettingsCheckbox('settings-notify-killswitch', savedNotify?.events?.killswitch ?? true);
        setSettingsCheckbox('settings-notify-daily-reset', savedNotify?.events?.dailyReset ?? false);
        setSettingsCheckbox('settings-notify-high-alpha', savedNotify?.events?.highAlpha ?? true);
        setSettingsCheckbox('settings-auto-trade', savedNotify?.autoTrade ?? false);

        // System Status aktualisieren
        updateSettingsSystemStatus(serverSettings, configData, walletData);

        addLog('info', 'Settings geladen');
    } catch (err) {
        addLog('error', 'Settings laden fehlgeschlagen: ' + err.message);
    }
}

function loadSettingsNotificationConfig() {
    try {
        const saved = localStorage.getItem('edgyalpha_notifications');
        return saved ? JSON.parse(saved) : null;
    } catch {
        return null;
    }
}

function setSettingsInputValue(id, value) {
    const el = document.getElementById(id);
    if (el) el.value = value;
}

function setSettingsCheckbox(id, checked) {
    const el = document.getElementById(id);
    if (el) el.checked = checked;
}

function getSettingsInputValue(id, defaultVal = 0) {
    const el = document.getElementById(id);
    return el ? (parseFloat(el.value) || defaultVal) : defaultVal;
}

function getSettingsCheckbox(id) {
    const el = document.getElementById(id);
    return el ? el.checked : false;
}

function getSettingsSelectValue(id) {
    const el = document.getElementById(id);
    return el ? el.value : '';
}

function updateSettingsSystemStatus(serverSettings, configData, walletData) {
    // Telegram Status
    const telegramEl = document.getElementById('settings-telegram-status');
    if (telegramEl) {
        const telegramOk = serverSettings?.telegram?.enabled && serverSettings?.telegram?.configured;
        telegramEl.textContent = telegramOk ? 'AKTIV' : 'INAKTIV';
        telegramEl.className = 'data-value ' + (telegramOk ? 'positive' : '');
    }

    // Wallet Status
    const walletEl = document.getElementById('settings-wallet-status');
    if (walletEl) {
        const walletOk = walletData?.configured && !walletData?.error;
        walletEl.textContent = walletOk ? (walletData.address || 'KONFIGURIERT') : 'NICHT KONFIGURIERT';
        walletEl.className = 'data-value ' + (walletOk ? 'positive' : 'warning');
    }

    // Germany Mode Status
    const germanyEl = document.getElementById('settings-germany-status');
    if (germanyEl) {
        const germanyOk = serverSettings?.germany?.enabled;
        germanyEl.textContent = germanyOk ? 'AKTIV' : 'INAKTIV';
        germanyEl.className = 'data-value ' + (germanyOk ? 'positive' : '');
    }

    // Dawum Status
    const dawumEl = document.getElementById('settings-dawum-status');
    if (dawumEl) {
        const dawumOk = serverSettings?.germany?.sources?.dawum;
        dawumEl.textContent = dawumOk ? 'AKTIV' : 'INAKTIV';
        dawumEl.className = 'data-value ' + (dawumOk ? 'positive' : '');
    }

    // RSS Status
    const rssEl = document.getElementById('settings-rss-status');
    if (rssEl) {
        const rssOk = serverSettings?.germany?.sources?.rss;
        rssEl.textContent = rssOk ? 'AKTIV' : 'INAKTIV';
        rssEl.className = 'data-value ' + (rssOk ? 'positive' : '');
    }
}

async function saveAllSettings() {
    const statusEl = document.getElementById('settings-save-status');

    try {
        // 1. Server Settings speichern (Trading & Signals)
        const serverPayload = {
            maxDailyLoss: getSettingsInputValue('settings-max-daily-loss', 100),
            maxPositions: getSettingsInputValue('settings-max-positions', 10),
            maxPerMarket: getSettingsInputValue('settings-max-per-market', 50),
            maxBetUsdc: getSettingsInputValue('settings-max-bet', 10),
            minAlpha: getSettingsInputValue('settings-min-alpha', 15),
            minEdge: getSettingsInputValue('settings-min-edge', 5),
            minVolumeUsd: getSettingsInputValue('settings-min-volume', 10000),
        };

        const settingsRes = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(serverPayload),
        }).then(r => r.json());

        if (!settingsRes.success) {
            throw new Error(settingsRes.error || 'Server settings save failed');
        }

        // 2. Execution Mode speichern
        const newMode = getSettingsSelectValue('settings-execution-mode');
        if (newMode) {
            await fetch('/api/execution/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ mode: newMode }),
            });
            updateModeUI(newMode);
        }

        // 3. Notification Settings in localStorage speichern
        const notificationPayload = {
            enabled: getSettingsCheckbox('settings-browser-notifications'),
            events: {
                signal: getSettingsCheckbox('settings-notify-signal'),
                trade: getSettingsCheckbox('settings-notify-trade'),
                killswitch: getSettingsCheckbox('settings-notify-killswitch'),
                dailyReset: getSettingsCheckbox('settings-notify-daily-reset'),
                highAlpha: getSettingsCheckbox('settings-notify-high-alpha'),
            },
            autoTrade: getSettingsCheckbox('settings-auto-trade'),
        };
        localStorage.setItem('edgyalpha_notifications', JSON.stringify(notificationPayload));

        // Kelly Fraction und Bankroll in localStorage (da Server-Config)
        localStorage.setItem('edgyalpha_kelly', getSettingsInputValue('settings-kelly-fraction', 25));
        localStorage.setItem('edgyalpha_bankroll', getSettingsInputValue('settings-bankroll', 1000));

        // Erfolgs-Feedback
        if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.textContent = 'Einstellungen gespeichert!';
            statusEl.style.background = 'var(--green-dark)';
            statusEl.style.borderColor = 'var(--green-dim)';
            statusEl.style.color = 'var(--green-profit)';
            setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        }

        addLog('success', 'Einstellungen gespeichert');

        // Risk Dashboard neu laden
        loadRiskDashboard();

    } catch (err) {
        if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.textContent = 'Fehler beim Speichern: ' + err.message;
            statusEl.style.background = 'rgba(255,51,68,0.15)';
            statusEl.style.borderColor = 'var(--red-dim)';
            statusEl.style.color = 'var(--red-risk)';
            setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
        }
        addLog('error', 'Settings speichern fehlgeschlagen: ' + err.message);
    }
}

function resetSettingsToDefaults() {
    if (!confirm('Alle Einstellungen auf Standardwerte zuruecksetzen?')) return;

    // Trading Defaults
    setSettingsInputValue('settings-execution-mode', DEFAULT_SETTINGS.trading.executionMode);
    setSettingsInputValue('settings-max-daily-loss', DEFAULT_SETTINGS.trading.maxDailyLoss);
    setSettingsInputValue('settings-max-positions', DEFAULT_SETTINGS.trading.maxPositions);
    setSettingsInputValue('settings-max-per-market', DEFAULT_SETTINGS.trading.maxPerMarket);
    setSettingsInputValue('settings-kelly-fraction', DEFAULT_SETTINGS.trading.kellyFraction);
    setSettingsInputValue('settings-bankroll', DEFAULT_SETTINGS.trading.bankroll);
    setSettingsInputValue('settings-max-bet', DEFAULT_SETTINGS.trading.maxBetUsdc);

    // Signal Defaults
    setSettingsInputValue('settings-min-alpha', DEFAULT_SETTINGS.signals.minAlpha);
    setSettingsInputValue('settings-min-edge', DEFAULT_SETTINGS.signals.minEdge);
    setSettingsInputValue('settings-min-volume', DEFAULT_SETTINGS.signals.minVolumeUsd);
    setSettingsCheckbox('settings-auto-trade', DEFAULT_SETTINGS.signals.autoTradeOnBreaking);

    // Notification Defaults
    setSettingsCheckbox('settings-browser-notifications', DEFAULT_SETTINGS.notifications.browserNotifications);
    setSettingsCheckbox('settings-notify-signal', DEFAULT_SETTINGS.notifications.notifySignal);
    setSettingsCheckbox('settings-notify-trade', DEFAULT_SETTINGS.notifications.notifyTrade);
    setSettingsCheckbox('settings-notify-killswitch', DEFAULT_SETTINGS.notifications.notifyKillswitch);
    setSettingsCheckbox('settings-notify-daily-reset', DEFAULT_SETTINGS.notifications.notifyDailyReset);
    setSettingsCheckbox('settings-notify-high-alpha', DEFAULT_SETTINGS.notifications.notifyHighAlpha);

    addLog('info', 'Einstellungen auf Defaults zurueckgesetzt');
}

// =====================================================================================
//                        SETTINGS VIEW HANDLER
// =====================================================================================

// Handler fÃ¼r Settings View registrieren
registerViewHandler('settings', () => loadSettings());

// =====================================================================================
//                        MOBILE MENU FUNCTIONS
// =====================================================================================

function toggleMobileMenu() {
    const sidebar = document.querySelector('.sidebar-nav');
    const overlay = document.querySelector('.mobile-overlay');
    const menuBtn = document.querySelector('.mobile-menu-btn');
    const menuIcon = document.getElementById('menu-icon');

    const isOpen = sidebar.classList.toggle('open');
    overlay.classList.toggle('active', isOpen);
    menuBtn.classList.toggle('active', isOpen);

    // Icon wechseln
    if (menuIcon) {
        menuIcon.textContent = isOpen ? 'âœ•' : 'â˜°';
    }
}

function closeMobileMenu() {
    const sidebar = document.querySelector('.sidebar-nav');
    const overlay = document.querySelector('.mobile-overlay');
    const menuBtn = document.querySelector('.mobile-menu-btn');
    const menuIcon = document.getElementById('menu-icon');

    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    if (menuBtn) menuBtn.classList.remove('active');
    if (menuIcon) menuIcon.textContent = 'â˜°';
}

// Resize Handler - MenÃ¼ schlieÃŸen wenn Viewport grÃ¶ÃŸer wird
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        closeMobileMenu();
    }
});

// Escape-Taste schlieÃŸt MenÃ¼
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && window.innerWidth <= 768) {
        closeMobileMenu();
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        TOAST NOTIFICATION SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showToast(message, type = 'info', duration = 5000) {
    const container = document.getElementById('toast-container') || createToastContainer();

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;

    const iconMap = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
    };

    const colorMap = {
        success: 'var(--green-profit)',
        error: 'var(--red-risk)',
        warning: 'var(--amber-watch)',
        info: 'var(--cyan-info)'
    };

    toast.innerHTML = `
        <span style="margin-right: 8px;">${iconMap[type] || iconMap.info}</span>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px;">&times;</button>
    `;

    toast.style.cssText = `
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-terminal);
        border: 1px solid ${colorMap[type] || colorMap.info};
        border-left: 4px solid ${colorMap[type] || colorMap.info};
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 12px;
        margin-bottom: 8px;
        animation: slideIn 0.3s ease;
        max-width: 400px;
    `;

    container.appendChild(toast);

    if (duration > 0) {
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    return toast;
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.style.cssText = `
        position: fixed;
        top: 60px;
        right: 16px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
    `;
    document.body.appendChild(container);

    // Animation styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    return container;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//                        TRADE HISTORY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let historyData = { trades: [], total: 0, offset: 0, limit: 20 };

async function loadHistory(offset = 0) {
    const statusFilter = document.getElementById('history-filter-status')?.value || '';
    const strategyFilter = document.getElementById('history-filter-strategy')?.value || '';
    const modeFilter = document.getElementById('history-filter-mode')?.value || '';

    const params = new URLSearchParams();
    params.append('limit', '20');
    params.append('offset', offset.toString());
    if (statusFilter) params.append('status', statusFilter);
    if (strategyFilter) params.append('strategy', strategyFilter);
    if (modeFilter) params.append('mode', modeFilter);

    try {
        const response = await fetch(`/api/trades/history?${params}`);
        const data = await response.json();

        historyData = {
            trades: data.trades || [],
            total: data.total || 0,
            offset: offset,
            limit: 20,
            stats: data.stats || {}
        };

        renderHistory();
    } catch (err) {
        console.error('History laden fehlgeschlagen:', err);
        showToast('History laden fehlgeschlagen', 'error');
    }
}

function renderHistory() {
    const tbody = document.getElementById('history-tbody');
    const stats = historyData.stats || {};

    // Update Stats
    document.getElementById('history-total-trades').textContent = stats.totalTrades || historyData.trades.length;
    document.getElementById('history-win-rate').textContent = stats.winRate ? `${(stats.winRate * 100).toFixed(1)}%` : '--';

    const pnl = stats.totalPnL || 0;
    const pnlEl = document.getElementById('history-total-pnl');
    pnlEl.textContent = pnl >= 0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`;
    pnlEl.style.color = pnl >= 0 ? 'var(--green-profit)' : 'var(--red-risk)';

    document.getElementById('history-volume').textContent = `$${(stats.totalVolume || 0).toFixed(0)}`;
    document.getElementById('history-count').textContent = `${historyData.total} Trades`;

    // Render Trades
    if (historyData.trades.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="padding: 40px; text-align: center; color: var(--text-muted);">
                    Keine Trades gefunden
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = historyData.trades.map(t => {
        const date = new Date(t.entryTime).toLocaleString('de-DE', {
            day: '2-digit', month: '2-digit', year: '2-digit',
            hour: '2-digit', minute: '2-digit'
        });

        const dirIcon = t.direction === 'yes' ? 'ğŸŸ¢' : 'ğŸ”´';
        const statusIcon = t.status === 'pending' ? 'â³' : t.won ? 'âœ…' : 'âŒ';
        const statusText = t.status === 'pending' ? 'Offen' : t.won ? 'Won' : 'Lost';

        const strategyEmoji = {
            arbitrage: 'ğŸ’°',
            lateEntry: 'â±ï¸',
            timeDelay: 'âš¡',
            manual: 'ğŸ‘¤'
        }[t.strategy] || 'ğŸ“Š';

        const pnl = t.actualProfit;
        const pnlText = pnl !== null ? (pnl >= 0 ? `+$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`) : '--';
        const pnlColor = pnl !== null ? (pnl >= 0 ? 'var(--green-profit)' : 'var(--red-risk)') : 'var(--text-muted)';

        const marketQuestion = t.marketQuestion || t.marketId?.substring(0, 20) || '--';

        return `
            <tr style="border-bottom: 1px solid var(--border-dim);">
                <td style="padding: 10px 8px; color: var(--text-secondary);">${date}</td>
                <td style="padding: 10px 8px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${marketQuestion}">${marketQuestion.substring(0, 30)}...</td>
                <td style="padding: 10px 8px; text-align: center;">${dirIcon}</td>
                <td style="padding: 10px 8px; text-align: right;">$${t.size.toFixed(2)}</td>
                <td style="padding: 10px 8px; text-align: right;">${(t.entryPrice * 100).toFixed(1)}%</td>
                <td style="padding: 10px 8px; text-align: right;">${t.exitPrice !== null ? (t.exitPrice * 100).toFixed(1) + '%' : '--'}</td>
                <td style="padding: 10px 8px; text-align: right; color: ${pnlColor}; font-weight: 500;">${pnlText}</td>
                <td style="padding: 10px 8px; text-align: center;">${statusIcon} ${statusText}</td>
                <td style="padding: 10px 8px;">${strategyEmoji} ${t.strategy}</td>
            </tr>
        `;
    }).join('');

    // Pagination
    renderHistoryPagination();
}

function renderHistoryPagination() {
    const pagination = document.getElementById('history-pagination');
    const totalPages = Math.ceil(historyData.total / historyData.limit);
    const currentPage = Math.floor(historyData.offset / historyData.limit) + 1;

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';

    // Previous
    if (currentPage > 1) {
        html += `<button class="btn" onclick="loadHistory(${(currentPage - 2) * historyData.limit})">â—€ï¸</button>`;
    }

    // Page numbers
    for (let i = 1; i <= totalPages && i <= 5; i++) {
        const isActive = i === currentPage;
        html += `<button class="btn${isActive ? ' primary' : ''}" onclick="loadHistory(${(i - 1) * historyData.limit})">${i}</button>`;
    }

    // Next
    if (currentPage < totalPages) {
        html += `<button class="btn" onclick="loadHistory(${currentPage * historyData.limit})">â–¶ï¸</button>`;
    }

    pagination.innerHTML = html;
}

function refreshHistory() {
    loadHistory(0);
    showToast('History aktualisiert', 'success', 2000);
}

function exportHistoryCSV() {
    if (historyData.trades.length === 0) {
        showToast('Keine Trades zum Exportieren', 'warning');
        return;
    }

    const headers = ['Datum', 'Markt', 'Richtung', 'Size', 'Entry', 'Exit', 'P/L', 'Status', 'Strategie', 'Mode'];
    const rows = historyData.trades.map(t => [
        new Date(t.entryTime).toISOString(),
        t.marketQuestion || t.marketId,
        t.direction,
        t.size,
        t.entryPrice,
        t.exitPrice || '',
        t.actualProfit || '',
        t.status,
        t.strategy,
        t.mode
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = `edgyalpha-trades-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();

    URL.revokeObjectURL(url);
    showToast('CSV exportiert', 'success');
}

// Handler fÃ¼r History View registrieren
registerViewHandler('history', () => loadHistory(0));

    </script>
</body>
</html>
